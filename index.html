<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-中间件/ElasticSearch/ElasticSearch相关知识点" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/ElasticSearch%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/" class="article-date">
  <time datetime="2021-10-14T10:09:31.649Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>►<a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/">ElasticSearch</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ElasticSearch相关知识点"><a href="#ElasticSearch相关知识点" class="headerlink" title="ElasticSearch相关知识点"></a>ElasticSearch相关知识点</h2><h3 id="ES基础知识点"><a href="#ES基础知识点" class="headerlink" title="ES基础知识点"></a>ES基础知识点</h3><p>​    ES集群可以包含多个索引（indices）(数据库)，每一个索引可以包含多个类型（types）（表），每一个类型包含多个文档（documents）（行），然后每个文档包含多个字段（fields）（列）。</p>
<h4 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a>索引（Index）</h4><p>​    索引是文档(Document)的容器，是一类文档的集合。在ES中有三种索引的概念，意思分别为：</p>
<ul>
<li>索引(名词)。类比传统的关系型数据库领域来说，索引相当于SQL中的一个数据库(Database)。索引由其名称(必须为全小写字符)进行标识。</li>
<li>索引(动词)。保存一个文档到索引(名词)的过程。这非常类似于SQL语句中的 INSERT关键词。如果该文档已存在时那就相当于数据库的UPDATE。</li>
<li>倒排索引。关系型数据库通过增加一个B+树索引到指定的列上，以便提升数据检索速度。索引ElasticSearch 使用了一个叫做 倒排索引 的结构来达到相同的目的。</li>
</ul>
<h4 id="类型（Type）"><a href="#类型（Type）" class="headerlink" title="类型（Type）"></a>类型（Type）</h4><p>​    Type 可以理解成关系数据库中Table。</p>
<p>​    之前的版本中，索引和文档中间还有个类型的概念，每个索引下可以建立多个类型，文档存储时需要指定index和type。从6.0.0开始单个索引中只能有一个类型，7.0.0以后将将不建议使用，8.0.0 以后完全不支持。但是后续的版本弃用了，原因如下：</p>
<p>​    我们虽然可以通俗的去理解Index比作 SQL 的 Database，Type比作SQL的Table。但这并不准确，因为如果在SQL中,Table 之前相互独立，同名的字段在两个表中毫无关系。但是在ES中，同一个Index 下不同的 Type 如果有同名的字段，他们会被 Luecence 当作同一个字段 ，并且他们的定义必须相同。所以我觉得Index现在更像一个表，而Type字段并没有多少意义。目前Type已经被Deprecated，在7.0开始，一个索引只能建一个Type为_doc</p>
<h4 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a>文档（Document）</h4><p>​    Document Index 里面单条的记录称为Document（文档）。等同于关系型数据库表中的行。</p>
<h4 id="映射（Mapping）"><a href="#映射（Mapping）" class="headerlink" title="映射（Mapping）"></a>映射（Mapping）</h4><p>​    映射(Mapping)相当于数据表的表结构。ElasticSearch中的映射（Mapping）用来定义一个文档，可以定义所包含的字段以及字段的类型、分词器及属性等等。</p>
<p>​    映射定义了类型中的域，每个域的数据类型，以及Elasticsearch如何处理这些域。映射也用于配置与类型有关的元数据。（元数据就是指和文档相关的数据，例如：文档的id、文档的index、文档的版本号）</p>
<p>​    映射创建完毕后就不能修改了，只能后续增加映射，不能修改已经存在的映射。映射也分为动态和静态。动态就是根据传入的json的类型去猜测映射的类型，例如“123”回被当为String。静态映射是在创建index时指定映射。</p>
<h4 id="字段（fields）"><a href="#字段（fields）" class="headerlink" title="字段（fields）"></a>字段（fields）</h4><p>​    代表传统DB中的列的概念，例如学生表中的name列，一般映射也是对字段进行限制。</p>
<h4 id="分片（Shard）"><a href="#分片（Shard）" class="headerlink" title="分片（Shard）"></a>分片（Shard）</h4><p>​    一个分片是一个底层的工作单元 ，它仅保存了全部数据中的一部分。索引实际上是指向一个或者多个物理分片的逻辑命名空间 。分片是数据的容器，文档保存在分片内，分片又被分配到集群内的各个节点里。分片分为主分片和副本。</p>
<ul>
<li>主分片：主要的数据存储分片，也是和用户打交道的主要分片。</li>
<li>副本：主要对主分片的数据做冗余备份。当主分片异常时，副本可以继续提供读访问。</li>
</ul>
<p>注意：一个index可能存在多个主分片上。主分片数量在创建时指定后就不能修改了，但是副本的数量可以修改。主分片不能和本分片的副本在同一个节点上。</p>
<h4 id="节点（Node）"><a href="#节点（Node）" class="headerlink" title="节点（Node）"></a>节点（Node）</h4><p>​    节点是一个ElasticSearch的实例，其本质就是一个Java进程；Node 是组成集群的一个单独的服务器，用于存储数据并提供集群的搜索和索引功能。与集群一样，节点也有一个唯一名字，默认在节点启动时会生成一个uuid作为节点名，该名字也可以手动指定。单个集群可以由任意数量的节点组成。如果只启动了一个节点，则会形成一个单节点的集群。一台机器可以部署多个节点，但是建议一台机器部署一个节点。</p>
<h4 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h4><p>​    Elasticsearch 使用一种称为倒排索引的结构，它适用于快速的全文搜索。一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。文档列表里面存储该词出现的文档和文档中该词出现的频率。</p>
<p>​    倒排索引就是将文档中出现的不重复的词语建立一个列表，然后对于各个文档，标注出该词语在文档中出现的次数。第一列是不重复词语，第一行是各个文档的id或者名称。表格中间填写的就是各个文档中各个词语出现的次数。</p>
<p>​    正排索引就是像MySQL这样类似，根据id查询该行的信息。倒排就是根据信息查询id。</p>
<h4 id="分析器"><a href="#分析器" class="headerlink" title="分析器"></a>分析器</h4><p>​    分析器就是从一串文本中切分出一个一个的词条，并対每个词条进行标准化。分析器实际上是将三个功能封装到了一个包里</p>
<ul>
<li>字符过滤器：首先，字符串按顺序通过每个字符过滤器 。他们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉HTML，或者将 &amp; 转化成 and。</li>
<li>分词器：其次，字符串被分词器分为单个的词条。一个简单的分词器遇到空格和标点的时候，可能会将文本拆分成词条。</li>
<li>Token 过滤器：最后，词条按顺序通过每个 token 过滤器 。这个过程可能会改变词条（例如，小写化 Quick ），删除词条（例如， 像 a， and， the 等无用词），或者增加词条（例如，像 jump 和 leap 这种同义词）。</li>
</ul>
<p>​    内置的分析器有一下几种：</p>
<ul>
<li>标准分析器是Elasticsearch默认使用的分析器。它是分析各种语言文本最常用的选择。它根据 Unicode 联盟 定义的 单词边界 划分文本。删除绝大部分标点。最后，将词条小写。</li>
<li>简单分析器在任何不是字母的地方分隔文本，将词条小写。</li>
<li>空格分析器在空格的地方划分文本。</li>
<li>特定语言分析器可用于很多语言。它们可以考虑指定语言的特点。例如， 英语 分析器附带了一组英语无用词（常用单词，例如 and 或者 the ，它们对相关性没有多少影响），它们会被删除。 由于理解英语语法的规则，这个分词器可以提取英语单词的词干。</li>
</ul>
<h3 id="ES中相关原理"><a href="#ES中相关原理" class="headerlink" title="ES中相关原理"></a>ES中相关原理</h3><h4 id="如何索引到文档"><a href="#如何索引到文档" class="headerlink" title="如何索引到文档"></a>如何索引到文档</h4><p>​    当索引一个文档的时候，文档会被存储到一个主分片中。这个时候是通过计算得到该文档所在的分片的。通过以下公式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure>

<p>​    routing 是一个可变值，默认是文档的 _id ，也可以设置成一个自定义的值。 routing 通过 hash 函数生成一个数字，然后这个数字再除以 number_of_primary_shards （主分片的数量）后得到 余数 。这个分布在 0 到 number_of_primary_shards-1 之间的余数，就是我们所寻求的文档所在分片的位置。这也就是为什么不能修改主分片的数量，如果修改了，后续的索引就无法找到对应的分片，之前的存放的文档也会有影响。</p>
<h4 id="搜索的过程"><a href="#搜索的过程" class="headerlink" title="搜索的过程"></a>搜索的过程</h4><p>​    先说普通的CURD操作，因为CURD一般都带有三个属性：_index, _type, 和 routing values ，基本可以确定集群中的那个分片处理这个请求。</p>
<p>​    但是搜索比较复杂一些。主要分为查询阶段和取回阶段。</p>
<h5 id="查询阶段"><a href="#查询阶段" class="headerlink" title="查询阶段"></a>查询阶段</h5><p>​    当一个搜索请求被发送到某个节点时，这个节点就变成了协调节点。 这个节点的任务是广播查询请求到所有相关分片并将它们的响应整合成全局排序后的结果集合，这个结果集合会返回给客户端。</p>
<p>​    第一步是广播请求到索引中每一个节点的分片拷贝。就像 document GET requests 所描述的， 查询请求可以被某个主分片或某个副本分片处理， 这就是为什么更多的副本（当结合更多的硬件）能够增加搜索吞吐率。 协调节点将在之后的请求中轮询所有的分片拷贝来分摊负载。</p>
<p>​    每个分片在本地执行查询请求并且创建一个长度为 from + size 的优先队列—也就是说，每个分片创建的结果集足够大，均可以满足全局的搜索请求。 分片返回一个轻量级的结果列表到协调节点，它仅包含文档 ID 集合以及任何排序需要用到的值，例如 _score 。</p>
<p>​    协调节点将这些分片级的结果合并到自己的有序优先队列里，它代表了全局排序结果集合。至此查询过程结束。</p>
<h5 id="取回阶段"><a href="#取回阶段" class="headerlink" title="取回阶段"></a>取回阶段</h5><p>​    协调节点首先决定哪些文档 确实 需要被取回。例如，如果我们的查询指定了 { “from”: 90, “size”: 10 } ，最初的90个结果会被丢弃，只有从第91个开始的10个结果需要被取回。这些文档可能来自和最初搜索请求有关的一个、多个甚至全部分片。</p>
<p>​    协调节点给持有相关文档的每个分片创建一个 multi-get request ，并发送请求给同样处理查询阶段的分片副本。</p>
<p>​    分片加载文档体– _source 字段—如果有需要，用元数据和 search snippet highlighting 丰富结果文档。 一旦协调节点接收到所有的结果文档，它就组装这些结果为单个响应返回给客户端。</p>
<ul>
<li><p>想象一下有两个文档有同样值的时间戳字段，搜索结果用 timestamp 字段来排序。 由于搜索请求是在所有有效的分片副本间轮询的，那就有可能发生主分片处理请求时，这两个文档是一种顺序， 而副本分片处理请求时又是另一种顺序。</p>
<p>这就是所谓的结果震荡问题: 每次用户刷新页面，搜索结果表现是不同的顺序。 让同一个用户始终使用同一个分片，这样可以避免这种问题， 可以设置 preference 参数（偏好参数选定对应的节点）为一个特定的任意值比如用户会话ID来解决。</p>
</li>
</ul>
<h4 id="节点故障后选举的流程"><a href="#节点故障后选举的流程" class="headerlink" title="节点故障后选举的流程"></a>节点故障后选举的流程</h4><p>​    Elasticsearch在满足如下时间点的时候会触发选举1.集群启动初始化2.集群的Master崩溃的时候3.任何一个节点发现当前集群中的Master节点没有得到n/2 + 1节点认可的时候，触发选举。</p>
<p>​    选举的流程：</p>
<p><img src="https://pic2.zhimg.com/v2-7c4b590346650f5e32088458da5df48d_r.jpg" alt="preview"></p>
<p>​    详细看文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/110079342">https://zhuanlan.zhihu.com/p/110079342</a></p>
<p>​    <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/281021501">https://zhuanlan.zhihu.com/p/281021501</a></p>
<h4 id="处理冲突的流程"><a href="#处理冲突的流程" class="headerlink" title="处理冲突的流程"></a>处理冲突的流程</h4><p>​    每个文档都有一个 _version （版本）号，当文档被修改时版本号递增。 Elasticsearch 使用这个 _version 号来确保变更以正确顺序得到执行。如果旧版本的文档在新版本之后到达，它可以被简单的忽略。</p>
<p>​    我们可以利用 _version 号来确保 应用中相互冲突的变更不会导致数据丢失。我们通过指定想要修改文档的 version 号来达到这个目的。 如果该版本不是当前版本号，我们的请求将会失败。</p>
<p>也可以通过外部版本号：</p>
<p>如果你的主数据库已经有了版本号 — 或一个能作为版本号的字段值比如 timestamp — 那么你就可以在 Elasticsearch 中通过增加 version_type=external 到查询字符串的方式重用这些相同的版本号， 版本号必须是大于零的整数， 且小于 9.2E+18 — 一个 Java 中 long 类型的正值。</p>
<p>外部版本号的处理方式和我们之前讨论的内部版本号的处理方式有些不同， Elasticsearch 不是检查当前 _version 和请求中指定的版本号是否相同， 而是检查当前 _version 是否 小于 指定的版本号。 如果请求成功，外部的版本号作为文档的新 _version 进行存储。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><h4 id="POSTMAN练习"><a href="#POSTMAN练习" class="headerlink" title="POSTMAN练习"></a>POSTMAN练习</h4><ul>
<li>PUT /index/type/id {body} 添加一个文档。</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT &#x27;http://127.0.0.1:9200/megacorp/employee/4&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;first_name&quot; : &quot;Li&quot;,</span><br><span class="line">    &quot;last_name&quot; :  &quot;Si&quot;,</span><br><span class="line">    &quot;age&quot; :        26,</span><br><span class="line">    &quot;about&quot; :      &quot;I love to sleep&quot;,</span><br><span class="line">    &quot;interests&quot;: [ &quot;bed&quot;, &quot;work&quot; ]</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>GET /megacorp/employee/1 查询一个id为1的文档。</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET &#x27;http://127.0.0.1:9200/megacrop/employee/1&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;from&quot;:2,</span><br><span class="line">    &quot;size&quot;:1</span><br><span class="line">&#125; &#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>GET /megacorp/employee/_search    搜索文档。可以添加相关的json来限制查询条件</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET &#x27;http://127.0.0.1:9200/megacrop/employee/_search&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;last_name&quot; : &quot;Smith&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>HEAD /megacorp/employee/123 查询文档是否存在。</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --head &#x27;http://127.0.0.1:9200/megacrop/employee/23&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>PUT /website/blog/123/_create    如果ID不存在创建新文档</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT &#x27;http://127.0.0.1:9200/website/blog/123/_create&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My first blog entry&quot;,</span><br><span class="line">  &quot;text&quot;:  &quot;I am starting to get the hang of this...&quot;,</span><br><span class="line">  &quot;date&quot;:  &quot;2014/01/02&quot;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>DELETE /website/blog/123    删除文档</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request DELETE &#x27;http://127.0.0.1:9200/website/blog/123&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>POST /website/blog/1/_update    更新文档，存在的字段就更新，不存在的字段就增加。</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &#x27;http://127.0.0.1:9200/megacorp/employee/4/_update&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">   &quot;doc&quot; : &#123;</span><br><span class="line">      &quot;about&quot; : &quot;l love to sleep and work&quot;</span><br><span class="line">      </span><br><span class="line">   &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_most_important_queries.html">ES常用的查询语句</a></p>
</li>
<li><p>多个查询的组合。比较复杂，后面如果经常使用需要多看</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;must&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">25</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;must_not&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;Zhang&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;should&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;rock&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;exists&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;interests&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后续需要多看官方的文档，多了解了解</p>
<h4 id="SpringBoot整合"><a href="#SpringBoot整合" class="headerlink" title="SpringBoot整合"></a>SpringBoot整合</h4><p>​    整合依赖，添加esstarter即可，注意这个依赖使用的是elasticsearch-rest-high-level-client</p>
<p>​    添加相关配置，例如集群的url，这里可以添加多个，客户端会轮询</p>
<p>​    添加相关实体类，加上@Document(indexName = “user”)注解</p>
<p>​    添加UserRepository接口继承ElasticsearchRepository&lt;User, Integer&gt;，一般的方法默认都实现了，也可以是使用@Query注解修改你方法的Query</p>
<p>​    查询即可，后续高级的用法再说。</p>
<h3 id="ES的面试问题"><a href="#ES的面试问题" class="headerlink" title="ES的面试问题"></a>ES的面试问题</h3><ul>
<li>ES集群相关的配置。</li>
</ul>
<p>我们公司使用的是单节点架构，分片是默认的5分片。索引大概4个索引。主要存储的数据都是设备的历史数据和状态记录。这样是没法达到高可用的，可以设置多节点，保证高可用，因为主分片和他的副本是不会在同一个节点上的。索引的话可以设置多个主分片，但是后续不能修改，这个就需要结合你的业务增长速度，每个分片其实会占用一定的计算机资源。副本的话可以后续修改，如果你某个索引吞吐量达，可以添加副本的数量。</p>
<ul>
<li>ES是如何找到一个文档的</li>
</ul>
<p>​    首先以我们公司使用的单节点架构为例，寻找一个文档很简单，知道文档的id和index，直接就能判断出文档在哪个分片，然后获取数据并且返回即可。这一步骤没有什么可以讲的点。搜索就复杂一点，因为不知道文档属于哪个分片，所以需要将请求发送到这个索引的所有副本分片上，同时后续的请求会轮询其他分片。每个分片建立一个优先队列，长度为from+size。默认的是0和10。然后该分片将符合要求的文档的id和排序值返回给协调节点，协调节点将所有节点的结果排序，取出客户端需要的数据，再次请求对应的分片，将分片返回的文档返回给客户端即可。多节点的话，最先请求的节点会处理客户端的请求，也叫做协调节点，但是我们只有一个节点，所以也就只有一个协调节点。</p>
<ul>
<li>项目中什么地方使用到ES，为什么这样用？</li>
</ul>
<p>因为我们公司项目本身是用来给政府单位开发的，所以在设计上会存在一些过量的设计，以此凸显自己项目的优势。这个我认为在开发中是没法避免的。后期的话，公司会做一个设备信息状态的判断 ，然后演算某些隧道的设备是否达到替换的标准，以此给业主提供参考意见，我觉这个地方可以展示es的一些优势，将es利用起来，例如：对某条隧道故障设备进行排名，再按照设备的供应商、地理位置等等条件。当然，这只是我的一个想法，目前的使用还是简单的将其作为一个数据库，对设备的历史数据进行维护。</p>
<ul>
<li>ES如果某一时刻需要开启大批量的查询，如何做？</li>
</ul>
<p>可以通过游标查询，游标查询允许我们 先做查询初始化，然后再批量地拉取结果。游标查询是取某个时间点的快照数据，通过请求中设置游标的时间参数，获取到游标的id，后续的请求发送这个id即可。达到大批量的查询。 游标查询的过期时间会在每次做查询的时候刷新，所以你的时间点设置只要本地查询处理就可以了。不需要设置很大。初始搜索请求和每个后续滚动请求返回一个新的 _scroll_id。</p>
<ul>
<li>ES如何解决脑裂现象的</li>
</ul>
<p>脑裂现象是指集群中因为网络分区或者其他原因导致出现两个master的现象，例如123选举3节点为master节点。456选举6节点为master节点。esmaster节点的选举来源分为两个地方，activemaster列表和mastercanditancees列表，前者是通过禁止本地节点入选来解决脑裂现象，后者是通过通过设置最小节点数来解决脑裂现象。当然，在我们项目实际使用过程中没有涉及到集群的这一方面，所以有些实际的问题可能没有涉及到。</p>
<ul>
<li>什么是倒排索引</li>
</ul>
<p>​    说到倒排索引，其实可以先提一下正排索引，类似MySQL这种，根据某行记录的ID查询该行记录，例如查询id为9的用户的信息，这就是正排索引，倒排索引相反，根据信息查询id，例如，有很多用户的信息，每个用户有一个备注，例如：我喜欢打篮球或者我喜欢打排球。倒排索引就是将这段话分词，分为各个词语，然后将形成一个列表，第一列就是各个词语，第一行就是各个文档id，中间内容就是记录各个词语在各个文档中是否出现或者出现的频率。这样就能达到一个效果，根据词语搜索文档的id，再搜索文档的信息。这样的表格就是倒排索引。</p>
<ul>
<li>ES集群是如何处理故障的？</li>
</ul>
<p>​    其他节点发现master节点故障后，发起选举，选举出新的master节点，然后新的主节点重新分配主分片，为挂掉的主节点创建分片的副本。</p>
<ul>
<li>ES集群的选举过程？</li>
</ul>
<p>​    选举的情况有三种：1）master节点崩溃。2）集群初始化的时候。3）任意节点发现当前master节点没有n/2+1节点支持时。</p>
<p>​    es的节点成员先发送ping请求给其他节点，构建两个列表：当前其他节点认为的存活的master节点列表和master候选节点列表。activeMaster和masterCanditances存在优先级，先从activeMaster中选举，如果该列表为空，在从masterCanditance列表中选举。</p>
<p>activeMaster节点不包含本地节点，这样就可以避免脑裂现象。该列表的选举采用Bully算法，就是每个节点都有一个优先级，从这些节点中选取出优先级最高的节点当作master节点。优先级的判断主要有两点：版本号和id。版本号越大优先级越高、id越小优先级越高。</p>
<p>masterCanditances列表里面先判断是否达到最小节点数，如果达到了就按照优先级进行选举。</p>
<p>选举出来master节点后，还存在两种情况：本地节点是master节点，会等待其他节点投票，如果超时或者设置的最小节点，就重新选举，如果票数大于，就当选为master节点。本地节点不是master时，首先禁止其他节点加入自己，然后监听集群的发布状态。如果新的master和自己的一致，就进行状态更新，否则重新发起选举。</p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>//索引的概念</p>
<p>//文档的概念</p>
<p>//映射的相关概念</p>
<p>//主分片和复制分片的概念</p>
<p>//es如何确保请求被分开（可能是轮询）</p>
<p>//es中的文本分析和</p>
<p>//倒排索引（分词）</p>
<p>//分析器</p>
<p>//结构化查询（通过json体进行查询）</p>
<p>//查询语句和过滤语句</p>
<p>//结果震荡</p>
<p>//字典树</p>
<p>练习</p>
<p>//简单的CURD</p>
<p>//指定映射和分析器</p>
<p>//结构化查询（通过json体进行查询）</p>
<p>//查询语句和过滤语句</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/ElasticSearch%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/" data-id="ckuqw9s8z001txcupfhlng9lw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-中间件/ElasticSearch/elasticsearch搭建和api使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/elasticsearch%E6%90%AD%E5%BB%BA%E5%92%8Capi%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2021-10-14T10:09:31.649Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>►<a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/">ElasticSearch</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Elasticsearch搭建和简单API使用"><a href="#Elasticsearch搭建和简单API使用" class="headerlink" title="Elasticsearch搭建和简单API使用"></a>Elasticsearch搭建和简单API使用</h1><p>​    之前的博客介绍了SpringBoot如何使用ES，但是ES最新版本的安装没有说明，最近需要做这个了发现没有具体的文档，这篇博客就来说一下ES在CentOS下的安装文档，同时也介绍一下一些简单的ES使用的API。不多逼逼了，开始。</p>
<h3 id="Elasticsearch安装"><a href="#Elasticsearch安装" class="headerlink" title="Elasticsearch安装"></a>Elasticsearch安装</h3><ul>
<li><p>下载RPM包。</p>
<p>本次的安装步骤是使用RPM包安装的，因为步骤比较简单。所以第一步需要下载RPM包，这个需要到官网下载，地址如下：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a>。根据自己的需要下载对应的版本就可以了。把RPM包上传到服务器上即可。</p>
</li>
<li><p>安装ES</p>
<p>在RPM包目录下执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm  --install elasticsearch-7.9.1-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>出现以下画面就表示安装完成</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200904104228179.png" alt="image-20200904104228179"></p>
</li>
<li><p>配置ES</p>
<p>配置ES前需要先安装Java，但是这个比较简单，并且不在本次叙述内容里面，这里就不再累述了，网上博客一搜一大堆。</p>
<ul>
<li><p>配置ES中的JAVA_HOME。</p>
<p>配置一下ES中的JAVA_HOME，这样ES启动的时候就会自己去找Java环境了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/elasticsearch</span><br><span class="line"></span><br><span class="line">修改JAVA_HOME属性为本机的配置即可</span><br></pre></td></tr></table></figure></li>
<li><p>修改ES配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">修改以下配置</span><br><span class="line">cluster.initial_master_nodes</span><br><span class="line">network.host</span><br><span class="line">http.port</span><br><span class="line">node.name</span><br><span class="line">cluster.name</span><br><span class="line">详细文件内容如下：</span><br><span class="line"><span class="comment"># ======================== Elasticsearch Configuration =========================</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> Elasticsearch comes with reasonable defaults for most settings.</span></span><br><span class="line"><span class="comment">#       Before you set out to tweak and tune the configuration, make sure you</span></span><br><span class="line"><span class="comment">#       understand what are you trying to accomplish and the consequences.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The primary way of configuring a node is via this file. This template lists</span></span><br><span class="line"><span class="comment"># the most important settings you may want to configure for a production cluster.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please consult the documentation for further information on configuration options:</span></span><br><span class="line"><span class="comment"># https://www.elastic.co/guide/en/elasticsearch/reference/index.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for your cluster:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cluster.name: elasticsearch</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ------------------------------------ Node ------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">node.name: node-1</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Add custom attributes to the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------- Paths ------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to directory where to store the data (separate multiple locations by comma):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to log files:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------- Memory -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Lock the memory on startup:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Make sure that the heap size is set to about half the memory available</span></span><br><span class="line"><span class="comment"># on the system and that the owner of the process is allowed to use this</span></span><br><span class="line"><span class="comment"># limit.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Elasticsearch performs poorly when the system is swapping the memory.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Network -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set the bind address to a specific IP (IPv4 or IPv6):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set a custom port for HTTP:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the network module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># --------------------------------- Discovery ----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Pass an initial list of hosts to perform discovery when this node is started:</span></span><br><span class="line"><span class="comment"># The default list of hosts is [&quot;127.0.0.1&quot;, &quot;[::1]&quot;]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#discovery.seed_hosts: [&quot;host1&quot;, &quot;host2&quot;]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Bootstrap the cluster using an initial set of master-eligible nodes:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the discovery and cluster formation module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Gateway -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Block initial recovery after a full cluster restart until N nodes are started:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#gateway.recover_after_nodes: 3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the gateway module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Various -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Require explicit names when deleting indices:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>启动ES，添加到开机自启</p>
<p>命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service elasticsearch start</span><br><span class="line">chkconfig --add elasticsearch</span><br></pre></td></tr></table></figure></li>
<li><p>其他信息</p>
<ul>
<li><p>删除ES</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e elasticsearch-7.9.1-x86_64.rpm</span><br></pre></td></tr></table></figure></li>
<li><p>开放防火墙端口（建议开启防火墙）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=9200/tcp --permanent</span><br></pre></td></tr></table></figure></li>
<li><p>把日志目录到权限赋予es用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R es:es /opt/elasticsearch</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="API简单介绍"><a href="#API简单介绍" class="headerlink" title="API简单介绍"></a>API简单介绍</h3><p>​    ES可以通过使用RESTful API来进行交互，使用的是9200端口。更极端的情况下，可以使用curl命令来进行交互。</p>
<p>​    一个 Elasticsearch 请求和任何 HTTP 请求一样由若干相同的部件组成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X&lt;VERB&gt; <span class="string">&#x27;&lt;PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;&#x27;</span> -d <span class="string">&#x27;&lt;BODY&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">介绍</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>VERB</code></td>
<td align="center">适当的 HTTP <em>方法</em> 或 <em>谓词</em> : <code>GET</code>、 <code>POST</code>、 <code>PUT</code>、 <code>HEAD</code> 或者 <code>DELETE</code>。</td>
</tr>
<tr>
<td align="center"><code>PROTOCOL</code></td>
<td align="center"><code>http</code> 或者 <code>https</code>（如果你在 Elasticsearch 前面有一个 <code>https</code> 代理）</td>
</tr>
<tr>
<td align="center"><code>HOST</code></td>
<td align="center">Elasticsearch 集群中任意节点的主机名，或者用 <code>localhost</code> 代表本地机器上的节点。</td>
</tr>
<tr>
<td align="center"><code>PORT</code></td>
<td align="center">运行 Elasticsearch HTTP 服务的端口号，默认是 <code>9200</code> 。</td>
</tr>
<tr>
<td align="center"><code>PATH</code></td>
<td align="center">API 的终端路径（例如 <code>_count</code> 将返回集群中文档数量）。Path 可能包含多个组件，例如：<code>_cluster/stats</code> 和 <code>_nodes/stats/jvm</code> 。</td>
</tr>
<tr>
<td align="center"><code>QUERY_STRING</code></td>
<td align="center">任意可选的查询字符串参数 (例如 <code>?pretty</code> 将格式化地输出 JSON 返回值，使其更容易阅读)</td>
</tr>
<tr>
<td align="center"><code>BODY</code></td>
<td align="center">一个 JSON 格式的请求体 (如果请求需要的话)</td>
</tr>
</tbody></table>
<ul>
<li><p>例子</p>
<ul>
<li><p>创建一个商品的索引，指定四个属性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9200/commodity</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;number_of_shards&quot;</span>:3,</span><br><span class="line">        <span class="string">&quot;number_of_replicas&quot;</span>:2</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;commodity_id&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>:<span class="string">&quot;long&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;commodity_name&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;picture_url&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;price&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>:<span class="string">&quot;double&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">返回结果：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;shards_acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;commodity&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200904143546873.png" alt="image-20200904143546873"></p>
</li>
</ul>
<p>还有一些用法，这里就不再列出来了，详细的文档可以看看官方文档，官方文档是基于2.0版本的，但是安装的是7.9，所以部分用法可能有些不一样，但是了解ES的一些基础的东西估计没有问题。中文文档地址在下方。<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</a></p>
</li>
</ul>
<p>​    这样就基础的就差不多了，就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/elasticsearch%E6%90%AD%E5%BB%BA%E5%92%8Capi%E4%BD%BF%E7%94%A8/" data-id="ckuqw9s8z001uxcupbakzcif6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-中间件/MySQL/MySQL事务了解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/MySQL/MySQL%E4%BA%8B%E5%8A%A1%E4%BA%86%E8%A7%A3/" class="article-date">
  <time datetime="2021-10-14T10:09:31.649Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>►<a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/MySQL/">MySQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="MySQL事务了解"><a href="#MySQL事务了解" class="headerlink" title="MySQL事务了解"></a>MySQL事务了解</h2><p>​    上次使用了最基本的MySQL，只是简单的查询一个表中的数据，这次练习一下事务。开始。</p>
<p>​    MySQL有四层架构，分别为：<strong>连接层</strong>、<strong>服务层</strong>、<strong>引擎层</strong>、<strong>存储层</strong>。这四层的作用如下：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200608233609217.png" alt="image-20200608233609217"></p>
<p>​    需要注意的是，事务的执行是在引擎层，并不是服务层。目前使用最广泛的就是InnoDB，其他的引擎很少有支持事务的。</p>
<p>​    事务的特性有四个。<strong>原子性</strong>、<strong>一致性</strong>、<strong>隔离性</strong>、<strong>持久性</strong>。四个特性简称为<strong>ACID</strong>，其含义和解释如下：</p>
<ul>
<li>原子性：操作这些指令时，要么全部执行成功，要么全部不执行。只要其中一个指令执行失败，所有的指令都执行失败，数据进行回滚，回到执行指令前的数据状态。</li>
<li>一致性：事务的执行使数据从一个状态转换为另一个状态，但是对于整个数据的完整性保持稳定。</li>
<li>隔离性：隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。</li>
<li>持久性：当事务正确完成后，它对于数据的改变是永久性的。</li>
</ul>
<p>​    MySQL中的事务为了保证原子性，通过undo log日志来进行事务的撤销和数据的回滚。一致性则是MySQL中最终追求的目标，需要其他三个特性的支持。为了保持隔离性，MySQL中使用锁来对数据进行保护和同步。持久性则是使用InnoDB存储引擎中的redo log日志来实现的。下面分别介绍。</p>
<ul>
<li><p>undo log 日志。回滚日志的作用就是对数据进行回滚，属于逻辑日志。它对SQL语句执行相关的信息进行记录。当发生回滚时，InnoDB引擎会根据undo log日志中的记录做与之前相反的工作。比如对于每个数据插入操作（insert），回滚时会执行数据删除操作（delete）。</p>
</li>
<li><p>说锁之前先说一下MySQL中的数据存储形式，分为：数据库、数据表、数据页、行。各个形式如下：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200612170140499.png" alt="image-20200612170140499"></p>
<p>MySQL中的锁有下面几种：行锁、表锁、页锁。粒度分别如下：</p>
<ul>
<li><p>行锁：粒度最小的锁，表示只针对当前操作的行进行加锁；</p>
</li>
<li><p>表锁：粒度最大的锁，表示当前的操作对整张表加锁；</p>
</li>
<li><p>页锁：粒度介于行级锁和表级锁中间的一种锁，表示对页进行加锁；</p>
</li>
</ul>
<p>表锁因为锁定的是整张表，所以并发性比较差，行锁如果过多，占用的资源比较多。</p>
<p>涉及到锁了，就要提及数据的读写问题了，读写问题有三类：脏读、不可重复读、幻读。</p>
<ul>
<li><p>脏读。当前事务中读到其他事务未提交的数据，也就是脏数据。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200612202259136.png" alt="image-20200612202259136"></p>
</li>
<li><p>不可重复读。在事务A中先后两次读取同一个数据，但是两次读取的结果不一样。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200612202326662.png" alt="image-20200612202326662"></p>
</li>
<li><p>幻读。在事务A中按照某个条件先后两次查询数据库，两次查询结果的行数不同，这种现象称为幻读。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200612202505995.png" alt="image-20200612202505995"></p>
</li>
</ul>
<p>根据这些问题产生了四种隔离级别，如下图：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200612202611299.png" alt="image-20200612202611299"></p>
<p>然后就是MVCC（多版本的并发控制协议）相当于git，这个可以解决脏读和不可重复读读问题。这个放在后面讲吧。</p>
</li>
<li><p>redo log日志。重做日志是InnoDB引擎层的日志，用来记录事务操作引起数据的变化，记录的是数据页的物理修改。InnoDB引擎对数据的更新，是先将更新记录写入redo log日志，然后会在系统空闲的时候或者是按照设定的更新策略再将日志中的内容更新到磁盘之中。这就是所谓的<strong>预写式技术（Write Ahead logging）</strong>。这种技术可以大大减少IO操作的频率，提升数据刷新的效率。redo log是一种物理日志，记录的是实际上对某个数据进行了怎么样的修改；而binlog是逻辑日志，记录的是SQL语句的原始逻辑，比如”给ID=2这一行的a字段加1 “。binlog日志中的内容是二进制的，根据日记格式参数的不同，可能基于SQL语句、基于数据本身或者二者的混合。一般常用记录的都是SQL语句。详细执行步骤如下：（在对redo log写入时有两个阶段的提交，一是binlog写入之前<code>prepare</code>状态的写入，二是binlog写入之后<code>commit</code>状态的写入。）</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200612212946695.png" alt="image-20200612212946695"></p>
<p>其实是看了一篇博客，详细了了解了事务的原理和关于MySQL的一些信息。链接如下：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HQh_HpbtvJv6Y5k3OAlfsQ">https://mp.weixin.qq.com/s/HQh_HpbtvJv6Y5k3OAlfsQ</a></p>
<p>后面也回简单写一个demo，具体把这些概念了解一下。就这样吧，结束。</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/MySQL/MySQL%E4%BA%8B%E5%8A%A1%E4%BA%86%E8%A7%A3/" data-id="ckuqw9s92001vxcup426rfbx9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-中间件/MySQL/SQL语法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/MySQL/SQL%E8%AF%AD%E6%B3%95/" class="article-date">
  <time datetime="2021-10-14T10:09:31.649Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>►<a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/MySQL/">MySQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一些重要的SQL命令："><a href="#一些重要的SQL命令：" class="headerlink" title="一些重要的SQL命令："></a>一些重要的SQL命令：</h3><ul>
<li><strong>SELECT</strong> - 从数据库中提取数据</li>
<li><strong>UPDATE</strong> - 更新数据库中的数据</li>
<li><strong>DELETE</strong> - 从数据库中删除数据</li>
<li><strong>INSERT INTO</strong> - 向数据库中插入新数据</li>
<li><strong>CREATE DATABASE</strong> - 创建新数据库</li>
<li><strong>ALTER DATABASE</strong> - 修改数据库</li>
<li><strong>CREATE TABLE</strong> - 创建新表<ul>
<li><strong>NOT NULL</strong> - 指示某列不能存储 NULL 值。</li>
<li><strong>UNIQUE</strong> - 保证某列的每行必须有唯一的值。</li>
<li><strong>PRIMARY KEY</strong> - NOT NULL 和 UNIQUE 的结合。确保某列（或两个列多个列的结合）有唯一标识，有助于更容易更快速地找到表中的一个特定的记录。</li>
<li><strong>FOREIGN KEY</strong> - 保证一个表中的数据匹配另一个表中的值的参照完整性。</li>
<li><strong>CHECK</strong> - 保证列中的值符合指定的条件。</li>
<li><strong>DEFAULT</strong> - 规定没有给列赋值时的默认值。</li>
</ul>
</li>
<li><strong>ALTER TABLE</strong> - 变更（改变）数据库表</li>
<li><strong>DROP TABLE</strong> - 删除表</li>
<li><strong>CREATE INDEX</strong> - 创建索引（搜索键）</li>
<li><strong>DROP INDEX</strong> - 删除索引</li>
</ul>
<h3 id="需要注意的点"><a href="#需要注意的点" class="headerlink" title="需要注意的点"></a>需要注意的点</h3><ul>
<li>SQL 使用单引号来环绕文本值，如果是数值字段，请不要使用引号。</li>
<li>通过使用 SQL，可以为表名称或列名称指定别名。基本上，创建别名是为了让列名称的可读性更强。</li>
<li>更新一个包含索引的表需要比更新一个没有索引的表花费更多的时间，这是由于索引本身也需要更新。</li>
</ul>
<h3 id="关键字用法"><a href="#关键字用法" class="headerlink" title="关键字用法"></a>关键字用法</h3><ul>
<li><p>SELECT DISTINCT 语句。在表中，一个列可能会包含多个重复值，有时您也许希望仅仅列出不同（distinct）的值。</p>
<p>DISTINCT 关键词用于返回唯一不同的值。</p>
</li>
<li><p>WHERE语句。WHERE 子句用于提取那些满足指定条件的记录。</p>
<ul>
<li>BETWEEN：在某个范围内<code>Select * from emp where sal between 1500 and 3000;</code></li>
<li>LIKE：搜索某种模式<code>Select * from emp where ename like &#39;M%&#39;;</code>（通配符类似正则表达式）</li>
<li>MySQL 中使用 REGEXP 或 NOT REGEXP 运算符 (或 RLIKE 和 NOT RLIKE) 来操作正则表达式。<code>SELECT * FROM Websites WHERE name REGEXP &#39;^[GFs]&#39;;</code></li>
</ul>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20210601165337182.png" alt="image-20210601165337182"></p>
<ul>
<li>IN：指定针对某个列的多个可能值<code>Select * from emp where sal in (5000,3000,1500);</code></li>
</ul>
</li>
<li><p>AND &amp; OR 运算符。如果第一个条件和第二个条件都成立，则 AND 运算符显示一条记录。如果第一个条件和第二个条件中只要有一个成立，则 OR 运算符显示一条记录。</p>
</li>
<li><p>ORDER BY关键字。 关键字用于对结果集按照一个列或者多个列进行排序。(多列时，先排前面字段，再拍后面字段)ORDER BY 关键字默认按照升序对记录进行排序。如果需要按照降序对记录进行排序，您可以使用 DESC 关键字。<code>SELECT * FROM Websites ORDER BY alexa DESC;</code></p>
</li>
<li><p>SELECT TOP 子句。MYSQL中为LIMIT。<code>SELECT * FROM Websites LIMIT 2;</code>SELECT TOP 子句用于规定要返回的记录的数目。</p>
</li>
<li><p>JOIN语句。SQL join 用于把来自两个或多个表的行结合起来。<strong>on</strong> 条件是在生成临时表时使用的条件，它不管 <strong>on</strong> 中的条件是否为真，都会返回左边表中的记录。<strong>where</strong> 条件是在临时表生成好后，再对临时表进行过滤的条件。</p>
<ul>
<li><strong>INNER JOIN</strong>：如果表中有至少一个匹配，则返回行</li>
<li><strong>LEFT JOIN</strong>：即使右表中没有匹配，也从左表返回所有的行。LEFT JOIN语句后面的表被称为右表。</li>
<li><strong>RIGHT JOIN</strong>：即使左表中没有匹配，也从右表返回所有的行</li>
<li><strong>FULL JOIN</strong>：只要其中一个表中存在匹配，则返回行</li>
</ul>
</li>
<li><p>UNION 操作符合并两个或多个 SELECT 语句的结果。UNION 内部的每个 SELECT 语句必须拥有相同数量的列。列也必须拥有相似的数据类型。同时，每个 SELECT 语句中的列的顺序必须相同。UNION ALL用于将不同表中相同列中查询的数据展示出来；（包括重复数据）</p>
</li>
<li><p>SELECT INTO 语句从一个表复制数据，然后把数据插入到另一个新表中。</p>
</li>
<li><p>INSERT INTO SELECT 语句从一个表复制数据，然后把数据插入到一个已存在的表中。</p>
</li>
<li><p>TRUNCATE TABLE 语句。仅仅删除表内的数据，但并不删除表本身。</p>
</li>
<li><p>AUTO INCREMENT 字段。我们通常希望在每次插入新记录时，自动地创建主键字段的值。</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line">(</span><br><span class="line">ID <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">LastName <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">FirstName <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">Address <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">City <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (ID)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="SQL函数"><a href="#SQL函数" class="headerlink" title="SQL函数"></a>SQL函数</h3><ul>
<li>AVG() 函数返回数值列的平均值。</li>
<li>COUNT() 函数返回匹配指定条件的行数。<ul>
<li>COUNT(column_name) 函数返回指定列的值的数目</li>
<li>COUNT(*) 函数返回表中的记录数</li>
<li>COUNT(DISTINCT column_name) 函数返回指定列的不同值的数目</li>
</ul>
</li>
<li>FIRST() 函数返回指定的列中第一个记录的值。</li>
<li>LAST() 函数返回指定的列中最后一个记录的值。</li>
<li>MAX() 函数返回指定列的最大值。</li>
<li>MIN() 函数返回指定列的最小值。</li>
<li>SUM() 函数返回数值列的总数。</li>
<li>GROUP BY 语句用于结合聚合函数，根据一个或多个列对结果集进行分组。</li>
<li>HAVING 子句。在 SQL 中增加 HAVING 子句原因是，WHERE 关键字无法与聚合函数一起使用。HAVING 子句可以让我们筛选分组后的各组数据。</li>
<li>EXISTS 运算符用于判断查询子句是否有记录，如果有一条或多条记录存在返回 True，否则返回 False。</li>
<li>UCASE() 函数把字段的值转换为大写。</li>
<li>LCASE() 函数把字段的值转换为小写。</li>
<li>MID() 函数用于从文本字段中提取字符。</li>
<li>LEN() 函数返回文本字段中值的长度。</li>
<li>ROUND() 函数用于把数值字段舍入为指定的小数位数。</li>
<li>NOW() 函数返回当前系统的日期和时间。</li>
<li>FORMAT() 函数用于对字段的显示进行格式化。</li>
<li>DATEDIFF() 函数返回两个日期之间的天数。用前一个参数减去后一个参数。</li>
</ul>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p># Write your MySQL query statement below</p>
<p>select  count(distinct sender_id send_to_id)/count(distinct requester_id accepter_id) from FriendRequest,RequestAccepted</p>
<p>select product_id,sum(rest),sum(paid),sum(canceled),sum(refunded) from Invoice group by product_id;</p>
<p>select distinct</p>
<p>a.follower,</p>
<p>count(f.followee) as num</p>
<p>from </p>
<p>(select distinct followee as follower</p>
<p>from follow </p>
<p>where</p>
<p>followee in (select distinct follower from follow)) as a</p>
<p>left join follow as f on a.follower = f.followee</p>
<p>group by f.followee</p>
<p>order by a.follower</p>
<p>select distinct</p>
<p>a1.player_id</p>
<p>from Activity as a1,Activity as a2</p>
<p>where a1.event_date = a2.event_date-1</p>
<p>select </p>
<p>b.book_id</p>
<p>from Orders as o</p>
<p>left join Books as b</p>
<p>on o.book_id = b.book_id</p>
<p>where datediff(2019-06-23,b.available_from)&gt;30 </p>
<p>and datediff(o.dispatch_date,2018-06-23)&gt;0</p>
<p>group by book_id</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/MySQL/SQL%E8%AF%AD%E6%B3%95/" data-id="ckuqw9s93001xxcup4h7xa8ef" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-中间件/PostgreSQL/Centos安装Postgresql和posogis插件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/PostgreSQL/Centos%E5%AE%89%E8%A3%85Postgresql%E5%92%8Cposogis%E6%8F%92%E4%BB%B6/" class="article-date">
  <time datetime="2021-10-14T10:09:31.649Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>►<a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/PostgreSQL/">PostgreSQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Centos安装Postgresql和posogis插件"><a href="#Centos安装Postgresql和posogis插件" class="headerlink" title="Centos安装Postgresql和posogis插件"></a>Centos安装Postgresql和posogis插件</h2><p>​    公司临时让装一个数据库，正好是之前了解过的Postgresql，顺带把之前的安装的坑填。并且这次也安装了插件。下面直接开始。</p>
<p>​    安装的插件有：fuzzystrmatch、postgis、uuid-ossp。其中uuid-ossp需要再初始化数据库的时候指定，剩下的都可以在安装完数据库后进行安装。下面直接上教程，不逼逼了。很详细。</p>
<ul>
<li>下载postgresql官方压缩包，选择对应的版本。地址：<a target="_blank" rel="noopener" href="https://www.postgresql.org/ftp/source/">https://www.postgresql.org/ftp/source/</a>，下载tar.gz</li>
</ul>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806103650919.png" alt="image-20200806103650919"></p>
<ul>
<li><p>解压到指定目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf postgresql-9.6.10.tar -C /home/program/soft/</span><br></pre></td></tr></table></figure></li>
<li><p>执行配置命令，中间出现部分错误，按照指示安装对应插件即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install uuid uuid-devel</span><br><span class="line">./configure --prefix=/bigdata/work/postgresql --with-uuid=ossp</span><br></pre></td></tr></table></figure>

<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806104151703.png" alt="image-20200806104151703"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install readline-devel</span><br></pre></td></tr></table></figure>

<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806104250201.png" alt="image-20200806104250201"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install zlib-devel</span><br></pre></td></tr></table></figure>

<p>出现下面命令即可以执行make命令。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806104818429.png" alt="image-20200806104818429"></p>
</li>
<li><p>执行make命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>出现以下截图即安装成功：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806105752457.png" alt="image-20200806105752457"></p>
</li>
<li><p>后续的配置</p>
<p>创建一个postgres用户，创建数据目录和日志目录，将权限给这个用户。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adduser postgres</span><br><span class="line">mkdir /bigdata/work/postgresql/data</span><br><span class="line">chown -R postgres:postgres /bigdata/work/postgresql/data</span><br></pre></td></tr></table></figure></li>
<li><p>添加环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PGDATA=/bigdata/work/postgresql/data</span><br><span class="line"><span class="built_in">export</span> PGHOME=/bigdata/work/postgresql</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PGHOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure></li>
<li><p>初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">initdb</span><br></pre></td></tr></table></figure>

<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806111651152.png" alt="image-20200806111651152"></p>
</li>
<li><p>修改两个配置，使用root用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /bigdata/work/postgresql/data/pg_hba.conf</span><br><span class="line">vim /bigdata/work/postgresql/data/postgresql.conf</span><br></pre></td></tr></table></figure>

<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806141658615.png" alt="image-20200806141658615"></p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806141724073.png" alt="image-20200806141724073"></p>
</li>
<li><p>将启动脚本复制到linux中去管理。</p>
<p>从postgresql中的解压目录复制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp contrib/start-scripts/linux  /etc/init.d/postgresql</span><br><span class="line">vim /etc/init.d/postgresql</span><br></pre></td></tr></table></figure>

<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200807090320846.png" alt="image-20200807090320846"></p>
</li>
<li><p>授予权限，设置开机自启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/init.d/postgresql</span><br><span class="line">chkconfig --add postgresql</span><br></pre></td></tr></table></figure></li>
<li><p>启动，设置密码。</p>
<p>直接使用root用户启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service postgresql start</span><br></pre></td></tr></table></figure>

<p>使用postgrees用户查看进程信息</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806142450969.png" alt="image-20200806142450969"></p>
<p>使用自带的工具连接数据库，设置密码。可以讲这个设置为系统环境变量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/bigdata/work/postgresql/bin/psql</span><br><span class="line">\password</span><br></pre></td></tr></table></figure></li>
<li><p>使用远程工具连接测试</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200806142714037.png" alt="image-20200806142714037"></p>
</li>
<li><p>安装Postgis插件</p>
<ul>
<li>先做准备工作，设置postgres用户的环境变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">vim ~/.bash_profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PGDATA=/bigdata/work/postgresql/data</span><br><span class="line"><span class="built_in">export</span> PGHOME=/bigdata/work/postgresql</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PGHOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$PGHOME</span>/lib:/lib64:/usr/lib64:/usr/<span class="built_in">local</span>/lib64:/lib:/usr/lib:/usr/<span class="built_in">local</span>/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure>

<ul>
<li>安装需要依赖包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y python-devel perl-ExtUtils-Embed python-devel gcc-c++ openssl-devel readline readline-devel bzip2 zlib zlib-devel openssl openssl-devel pam pam-devel libxml2 libxml2-devel libxslt libxslt-devel openldap openldap-devel libgeos-dev libproj-dev libgdal-dev xsltproc docbook-xsl docbook-xml imagemagick libmagickcore-dev dblatex tcl tcl-devel unixODBC unixODBC-devel libpng12 libpng12-devel</span><br></pre></td></tr></table></figure>

<ul>
<li><p>下载其他依赖包</p>
<ul>
<li><p>安装Proj4</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.osgeo.org/proj/proj-4.9.3.tar.gz</span><br><span class="line">  tar -xf proj-4.9.3.tar.gz</span><br><span class="line">  <span class="built_in">cd</span> proj-4.9.3</span><br><span class="line">  ./configure --prefix=/bigdata/work/postgresql/plugin/proj</span><br><span class="line">  make </span><br><span class="line">  make install</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;/bigdata/work/postgresql/plugin/proj/lib&quot;</span> &gt; /etc/ld.so.conf.d/proj-4.9.3.conf</span><br><span class="line">  ldconfig</span><br></pre></td></tr></table></figure></li>
<li><p>安装GEOS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  wget http://download.osgeo.org/geos/geos-3.6.1.tar.bz2</span><br><span class="line">  tar -jxf geos-3.6.1.tar.bz2</span><br><span class="line">  <span class="built_in">cd</span> geos-3.6.1</span><br><span class="line">serivice jj</span><br><span class="line">  make</span><br><span class="line">  make install</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;/bigdata/work/postgresql/plugin/geos/lib&quot;</span> &gt; /etc/ld.so.conf.d/geos-3.6.1.conf</span><br><span class="line">  ldconfig</span><br></pre></td></tr></table></figure></li>
<li><p>安装GDAL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.osgeo.org/gdal/2.1.2/gdal-2.1.2.tar.gz</span><br><span class="line">tar -xf gdal-2.1.2.tar.gz</span><br><span class="line"><span class="built_in">cd</span> gdal-2.1.2</span><br><span class="line">./configure --prefix=/bigdata/work/postgresql/plugin/gdal</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/bigdata/work/postgresql/plugin/gdal/lib&quot;</span> &gt; /etc/ld.so.conf.d/gdal-2.1.2.conf</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure></li>
<li><p>安装PostGIS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.osgeo.org/postgis/<span class="built_in">source</span>/postgis-2.2.5.tar.gz</span><br><span class="line">tar -xf postgis-2.2.5.tar.gz</span><br><span class="line"><span class="built_in">cd</span> postgis-2.2.5</span><br><span class="line">./configure --prefix=/bigdata/work/postgresql/plugin/postgis --with-pgconfig=/bigdata/work/postgresql/bin/pg_config --with-geosconfig=/bigdata/work/postgresql/plugin/geos/bin/geos-config --with-gdalconfig=/bigdata/work/postgresql/plugin/gdal/bin/gdal-config --with-projdir=/bigdata/work/postgresql/plugin/proj</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200807094928599.png" alt="image-20200807094928599"></p>
<p>解决这个问题。需要将postgresql的lib目录导入ld.so.conf.d</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ld.so.conf</span><br><span class="line"></span><br><span class="line">/bigdata/work/postgresql/lib</span><br><span class="line"></span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>验证插件正常安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">su postgres</span><br><span class="line">psql</span><br><span class="line">create database postgis;</span><br><span class="line">\c postgis</span><br><span class="line">CREATE EXTENSION postgis;</span><br><span class="line">CREATE EXTENSION postgis_topology;</span><br><span class="line">CREATE EXTENSION fuzzystrmatch;</span><br><span class="line">CREATE EXTENSION postgis_tiger_geocoder;</span><br><span class="line">CREATE EXTENSION <span class="string">&quot;uuid-ossp&quot;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200807150426313.png" alt="image-20200807150426313"></p>
<p>即成功。</p>
<p>fuzzystrmatch是在源码中的有的，但是没有包含编译的时候没有包含进去，需要make一下。</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> contrib/fuzzystrmatch/</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>UUID-OSSP插件也是</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> contrib/uuid-ossp/</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>  如下图：</p>
<p>  <img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200807151502098.png" alt="image-20200807151502098"></p>
</li>
</ul>
<p>​    剩下就没有什么可以讲的了，按照步骤来就可以了。以为一些centos的依赖指定了版本，如果你的PostgreSQL版本和我的不一致，这一点需要注意。如何查询对应的版本需要到网上搜一搜。</p>
<p>​    就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/PostgreSQL/Centos%E5%AE%89%E8%A3%85Postgresql%E5%92%8Cposogis%E6%8F%92%E4%BB%B6/" data-id="ckuqw9s93001yxcup71w98bl0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-中间件/RabbitMQ/RabbitMQ基础知识了解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%BA%86%E8%A7%A3/" class="article-date">
  <time datetime="2021-10-14T10:09:31.649Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>►<a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/">RabbitMQ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="RabbitMQ基础知识了解"><a href="#RabbitMQ基础知识了解" class="headerlink" title="RabbitMQ基础知识了解"></a>RabbitMQ基础知识了解</h2><p>​    公司前一段时间重构了一个老项目的代码，转为了SpringBoot，但是中间RabbitMQ在转换的时候我问了大佬一个很弱智的问题，所以抽了空，了解一下这个之前一直用但是不懂原理的中间件。</p>
<p>​    RabbitMQ是基于AMQP（高级消息队列协议）开发的一个消息队列产品，相当于一个软件，所以其实要讲的AMQP，下面也就简单介绍一下AMQP，然后在介绍中间的一些组件。</p>
<p>​    AMQP高级消息队列协议）是一种消息传递协议，使一致的客户端应用程序可以与一致的消息传递中间件代理进行通信。消息发布到<em>exchanges</em>（交换机），交换机类似于邮局或邮箱。然后，交换机使用称为<em>bindings</em>（绑定）的规则将消息副本分发到队列中。然后，代理要么将消息传递给订阅了队列的消费者，要么消费者按需从队列中获取/拉取消息。这就是AMQP的一些基础概念，下面就来一一叙述中间提及到的概念。概念如下图：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200924085039570.png" alt="image-20200924085039570"></p>
<h3 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h3><p>​    交换机是接收消息的AMQP中的一种实体。交换记接收一条消息并将其路由到零个或多个队列中。使用的路由算法取决于交换机的类型和绑定的规则。交换机在RabbitMQ官网上只有四种，但是实际使用中还多了一个默认的类型。四种交换机名称分别为：Direct exchange（直接交换）、Fanout exchange（扇形交换）、Topic exchange（主题交换）、Headers exchange（标头交换）。下面就说说实际使用到的五种交换。</p>
<ul>
<li>默认交换。默认交换是一种特殊的直接交换，特殊的地方在于：默认交换是预先声明的不带名称（空字符串）的直接交换。创建的每个队列都使用与队列名称相同的路由自动绑定到该队列。举个例子，有一个队列声明为：”search-indexing-online”，那么使用路由关键字”search-indexing-online”发送到默认交换机的消息将会被队列”search-indexing-online”接收。看起来类似于直接将消息发送到队列中。</li>
<li>直接交换。直接交换是基于消息路由关键字将消息传递到队列，原理也比较容易理解：队列使用路由关键字绑定到交换机，收到消息后，如果消息的路由关键字和前面的关键字一致，该消息就会路由到该队列。需要注意的是，如果有多个消费者接收同一个队列，那么将会在消费者层面进行负载均衡，而不是队列。示意图如下：</li>
</ul>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200923175758411.png" alt="image-20200923175758411"></p>
<ul>
<li>扇形交换。扇形交换将消息路由到与其绑定的所有队列，并且路由关键字将被忽略。如果将N个队列绑定到扇形交换的交换机，则将新消息发布到该交换机时，会将消息的副本传递到所有N个队列。扇出交换机非常适合消息的广播路由。示意图如下：</li>
</ul>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200923180111463.png" alt="image-20200923180111463"></p>
<ul>
<li>主题交换。主题交换根据消息的路由关键字和一个匹配规则将消息路由到一个或多个队列。主题交换类型通常用于实现各种发布/订阅模式变体。类似于MQTT中主题的概念，订阅了这个主题的客户端都可以接收到此类消息。没有示意图。</li>
<li>标头交换。标头交换旨在用于在多个属性上进行路由，这些属性比路由键更容易表示为消息标头。标头交换忽略路由键属性。相反，用于路由的属性取自headers属性。如果标头的值等于绑定时指定的值，则认为消息匹配。</li>
</ul>
<h3 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h3><p>​    AMQP中队列的概念和其他协议中队列的概念一致，存储由应用程序使用的消息。队列的属性有一些不同于其他的，如下：</p>
<ul>
<li><p>名称</p>
</li>
<li><p>持久（队列将在代理重新启动后幸存）</p>
</li>
<li><p>独占（仅由一个连接使用，并且该连接关闭时队列将被删除）</p>
</li>
<li><p>自动删除（至少有一个使用方的队列在最后一个使用方退订时被删除）</p>
</li>
<li><p>参数（可选；由插件和特定于代理的功能使用，例如消息TTL，队列长度限制等）</p>
<p> 需要注意的是，队列必须要先声明再使用，声明这个工作没有定必须由谁做，消费者或者生产者都可以，最好是由谁最先使用谁创建。如果声明已经创建的队列，属性一致的话，声明无效；属性不一致的话，会报一个406的通道异常。</p>
</li>
</ul>
<h3 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h3><p>​    绑定是交换机使用的规则之一，这个规则的作用就是将消息路由联系到队列。为了指示交换机E将消息路由到队列Q，必须将Q 绑定到E。绑定可能具有某些交换机类型使用的可选 路由键属性。路由键的目的是选择发布到交换机的某些消息以路由到绑定队列。换句话说，路由键就像一个过滤器。</p>
<h3 id="消息的相关知识"><a href="#消息的相关知识" class="headerlink" title="消息的相关知识"></a>消息的相关知识</h3><p>​    broker(代理)将消息发送到应用程序之后（使用<code>basic.deliver</code>或<code>basic.get-ok</code>方法）。应用程序发送回确认之后（使用<code>basic.ack</code>方法）。前者称为自动确认模型，而后者称为显式确认模型。</p>
<p>​    关于RabbitMQ或者AMQP的基础知识了解到这里就暂时差不多了，后续的学习需要更加深入。就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%BA%86%E8%A7%A3/" data-id="ckuqw9s94001zxcup17v6h8ts" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-中间件/RabbitMQ/RabbitMQ相关知识点" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/" class="article-date">
  <time datetime="2021-10-14T10:09:31.649Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>►<a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/">RabbitMQ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="RabbtiMQ相关知识点"><a href="#RabbtiMQ相关知识点" class="headerlink" title="RabbtiMQ相关知识点"></a>RabbtiMQ相关知识点</h2><h3 id="RabbitMQ中的一些基础概念"><a href="#RabbitMQ中的一些基础概念" class="headerlink" title="RabbitMQ中的一些基础概念"></a>RabbitMQ中的一些基础概念</h3><h4 id="AMQP"><a href="#AMQP" class="headerlink" title="AMQP"></a>AMQP</h4><p>​    AMQP（Advanced Message Queuing Protocol，高级消息队列协议）是一个进程间传递异步消息的网络协议。</p>
<p>​    过程：发布者（Publisher）发布消息（Message），经由交换机（Exchange）。交换机根据路由规则将收到的消息分发给与该交换机绑定的队列（Queue）。最后 AMQP 代理会将消息投递给订阅了此队列的消费者，或者消费者按照需求自行获取。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20210629175842275.png" alt="image-20210629175842275"></p>
<h5 id="Exchange交换机"><a href="#Exchange交换机" class="headerlink" title="Exchange交换机"></a>Exchange交换机</h5><p>​    交换机是用来发送消息的 AMQP 实体。交换机拿到一个消息之后将它路由给一个或零个队列。它使用哪种路由算法是由交换机类型和绑定（Bindings）规则所决定的。有四种类型的交换机。</p>
<ul>
<li>默认交换机（default exchange）实际上是一个由消息代理预先声明好的没有名字（名字为空字符串）的直连交换机（direct exchange）。它有一个特殊的属性使得它对于简单应用特别有用处：那就是每个新建队列（queue）都会自动绑定到默认交换机上，绑定的路由键（routing key）名称与队列名称相同。</li>
<li>直连型交换机（direct exchange）是根据消息携带的路由键（routing key）将消息投递给对应绑定键的队列。直连交换机用来处理消息的单播路由（unicast routing）（尽管它也可以处理多播路由）。</li>
<li>扇型交换机（funout exchange）将消息路由给绑定到它身上的所有队列，而不理会绑定的路由键。如果 N 个队列绑定到某个扇型交换机上，当有消息发送给此扇型交换机时，交换机会将消息的拷贝分别发送给这所有的 N 个队列。</li>
<li>主题交换机（Topic exchange）Topic 的路由规则是一种模糊匹配，可以通过通配符满足一部分规则就可以传送。</li>
<li>头交换机（headers exchange）headers 类型的 Exchange 不依赖于 routing key 与 binding key 的匹配规则来路由消息，而是根据发送的消息内容中的 headers 属性进行匹配。</li>
</ul>
<h5 id="Queue队列"><a href="#Queue队列" class="headerlink" title="Queue队列"></a>Queue队列</h5><p>​    AMQP 中的队列（queue）跟其他消息队列或任务队列中的队列是很相似的：它们存储着即将被应用消费掉的消息。</p>
<p>​    队列在声明（declare）后才能被使用。如果一个队列尚不存在，声明一个队列会创建它。如果声明的队列已经存在，并且属性完全相同，那么此次声明不会对原有队列产生任何影响。如果声明中的属性与已存在队列的属性有差异，那么一个错误代码为 406 的通道级异常就会被抛出。</p>
<p>​    持久化队列（Durable queues）会被存储在磁盘上，当消息代理（broker）重启的时候，它依旧存在。没有被持久化的队列称作暂存队列（Transient queues）。并不是所有的场景和案例都需要将队列持久化。（持久化的队列并不会使得路由到它的消息也具有持久性。）</p>
<h6 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h6><p>​    当一条消息在队列中出现以下三种情况的时候，该消息就会变成一条死信。</p>
<ul>
<li>消息被拒绝(basic.reject / basic.nack)，并且requeue = false</li>
<li>消息TTL过期</li>
<li>队列达到最大长度</li>
</ul>
<p>​    “死信”消息会被RabbitMQ进行特殊处理，如果配置了死信队列信息，那么该消息将会被丢进死信队列中，如果没有配置，则该消息将会被丢弃。</p>
<h5 id="消息的机制"><a href="#消息的机制" class="headerlink" title="消息的机制"></a>消息的机制</h5><h6 id="RabbitMQ确认消息收到的机制"><a href="#RabbitMQ确认消息收到的机制" class="headerlink" title="RabbitMQ确认消息收到的机制"></a>RabbitMQ确认消息收到的机制</h6><p>​    生产者发送消息到 RabbitMQ Server 后，RabbitMQ Server 需要对生产者进行消息 Confirm 确认。</p>
<p>​    消费者确认指的就是 RabbitMQ 需要确认消息到底有没有被收到，来确定要不要将该条消息从队列中删除掉。这就需要消费者来告诉 RabbitMQ，有以下两种方式。</p>
<ul>
<li>消费者在消费消息的时候，如果设定应答模式为自动，则消费者收到消息后，消息就会立即被 RabbitMQ 从 队列中删除掉。 </li>
<li>手动应答模式：可以在既定的正常情况下进行确认（告诉 RabbitMQ，我已经消费过该消息了，你可以删除该条数据了）；可以在既定的异常情况下不进行确认（RabbitMQ 会继续保留该条数据），这样下一次可以继续消费该条数据。    </li>
</ul>
<h6 id="RabbitMQ消息的持久化"><a href="#RabbitMQ消息的持久化" class="headerlink" title="RabbitMQ消息的持久化"></a>RabbitMQ消息的持久化</h6><p>持久化可以提高 RabbitMQ 的可靠性，以防止在异常情况（比如：重启、关机、宕机等）下的数据丢失。</p>
<p>RabbitMQ 持久化分为三部分：交换机的持久化、队列的持久化、消息的持久化。</p>
<ul>
<li>交换机持久化是指将交换机的属性数据存储在磁盘上，当 MQ 的服务器发生意外或关闭之后，在重启 RabbitMQ 时不需要重新手动或执行代码去创建交换机了，交换机会自动被创建，相当于一直存在。</li>
<li>如果不将队列设置为持久化，那么在 RabbitMQ 服务重启之后，相关队列的元数据会丢失，数据也会丢失。队列都没有了，消息也找不到地方存储了。队列的持久化能保证其本身的元数据不会因异常情况而丢失，但是并不能保证内部所存储的消息不会丢失；</li>
<li>RabbitMQ 的消息是依附于队列存在的，所以要想消息持久化，那么前提是队列也必须设置持久化。</li>
</ul>
<h6 id="RabbitMQ消息的唯一性"><a href="#RabbitMQ消息的唯一性" class="headerlink" title="RabbitMQ消息的唯一性"></a>RabbitMQ消息的唯一性</h6><p>对每条消息，MQ系统内部必须生成一个inner-msg-id，作为去重和幂等的依据，这个内部消息ID的特性是：</p>
<p>（1）全局唯一</p>
<p>（2）MQ生成，具备业务无关性，对消息发送方和消息接收方屏蔽</p>
<p>有了这个inner-msg-id，就能保证上半场重发，也只有1条消息落到MQ-server的DB中，实现上半场幂等。</p>
<h4 id="RabbitMQ中一些详细的概念"><a href="#RabbitMQ中一些详细的概念" class="headerlink" title="RabbitMQ中一些详细的概念"></a>RabbitMQ中一些详细的概念</h4><ul>
<li>Connection（连接）：Producer 和 Consumer 通过 TCP 连接到 RabbitMQ Server。一个连接就代表了一个TCP连接。</li>
<li>Channel（信道）：基于 Connection 创建，数据流动都是在 Channel 中进行。一个连接可以有多个信道，因为TCP的创建和删除非常消耗资源。信道是双向数据流通道，是一个建立在TCP连接内的虚拟连接，每个信道有一个ID。</li>
<li>Vhost（虚拟主机） ： 虚拟主机，一个消息代理（Broker）里可以开设多个虚拟主机（Vhost），用作不同用户的权限分离。</li>
<li>Broker（消息代理）：实际上就是消息服务器实体。</li>
</ul>
<h3 id="RabbitMQ使用的场景"><a href="#RabbitMQ使用的场景" class="headerlink" title="RabbitMQ使用的场景"></a>RabbitMQ使用的场景</h3><ul>
<li>异步处理：比如用户注册后，需要写入数据库并且发送邮件和短信，这里可以通过RabbitMQ将发送邮件和短信异步化，因为这些操作对于目前的流程没有影响。</li>
<li>应用解耦：两个系统之间的应用解耦，A系统发送消息队列通知B系统，B系统完成数据持久化后，发送消息队列返回告知A系统。</li>
<li>流量削峰：用户发起请求,服务器收到之后,首先写入消息队列,加入消息队列长度超过最大值,超过一定阈值后则直接抛弃用户请求或跳转到错误页面。可以缓解短时间的高流量压垮应用。</li>
</ul>
<h3 id="RabbitMQ和Mosquitto的区别"><a href="#RabbitMQ和Mosquitto的区别" class="headerlink" title="RabbitMQ和Mosquitto的区别"></a>RabbitMQ和Mosquitto的区别</h3><p>​    MQTT一般是物联网首选的协议，基于发布订阅的轻量级协议。一字节报头，两字节心跳报文。开销比较小，能够减少网络流量。</p>
<p>​    AMQP高级消息队列协议，是面向消息中间件提供的开放的应用层协议，其设计目标是对于消息的排序、路由（包括点对点和订阅-发布）、保持可靠性、保证安全性。AMQP规范了消息传递方和接收方的行为，以使消息在不同的提供商之间实现互操作性，就像SMTP，HTTP，FTP等协议可以创建交互系统一样。</p>
<p>​    RabbitMQ和Mosquitto分别是这两种协议的broker。Mosquitto比较轻量级。</p>
<h3 id="RabbitMQ使用中遇到的一些问题"><a href="#RabbitMQ使用中遇到的一些问题" class="headerlink" title="RabbitMQ使用中遇到的一些问题"></a>RabbitMQ使用中遇到的一些问题</h3><ul>
<li>RabbitMQ如何保证消息顺序性</li>
</ul>
<p>​    通过添加一个属性，上一条消息的ID，生产者顺序发送。消费者拿到消息后，如何没有上一条消息的ID，就进行正常消费，同时在缓存中存储一下这条消息的ID。如果有上一条id的属性，但是不对或者缓存中没有，把消息重新放到队列里面，或者睡眠一段时间，等待其他消费者消费完上一条消息。</p>
<p>​    也可以将生产者和消费者绑定，就是一个生产者对应一个消费者。将业务分离，本身RabbitMQ到消息就有顺序性，这样就能保证整体的顺序性。</p>
<p>​    也可以将生产者的消息都发到一个队列里面，消费者这对应一个队列。生产者轮流发送消息。</p>
<ul>
<li>RabbitMQ如何保证消息的幂等性</li>
</ul>
<p>​    生产者在发送消息时，可以添加一个业务ID，例如SessionID，消费者收到消息后，在redis中进行设置，如果redis中存在，认为消息已经消费了，丢弃当前消息，如果没有key，认为消息没有被消费。执行业务逻辑。</p>
<p>​    还有一种就是将id当作数据库主键，如果该数据存在了，就update一下，不再新增数据。</p>
<ul>
<li>RabbitMQ如何保证消息可靠性？</li>
</ul>
<p>​    首先有三个地方需要保证。1）生产者发送消息到交换机，这里可以通过confirmCallBack来实现，还有消息投递队列失败后会调用一个ReturnCallback，不过这个消耗比较高。2）MQ里面如果宕机了，可以通过队列持久化和消息持久化解决这个问题，可能会影响吞吐量。3）消费者这边取消自动ack，手动确认收到消息。业务处理完成之后ack。</p>
<ul>
<li>RabbitMQ消费者如果长时间不ack会怎么样？</li>
</ul>
<p>猜想：消费者连接时通过心跳机制可以检测消费者是否在线，如果一条消息没有ack，并且消费者心跳不在线，认为消费者挂了，将消息重新放到队列里面。</p>
<ul>
<li>RabbitMQ如何实现延时发送</li>
</ul>
<p>​    因为我们的系统里面很少遇到这样的需求，所以后续的说法可能不太准确。1）可以利用死信队列来达到这样的效果，生产者生产消息，到一个普通交换机中，绑定这个交换机的队列就是延时队列，设置过期时间ttl，然后等待过期时间，消息过期后回转到指定的死信交换机的死信队列里面，再让消费者去消费死信队列里面的消息即可。达到延时的效果。但是这种存在一些缺点，因为延时时间是不固定的，所以队列的设置也比较多，给代码开发带来很多繁琐。2）利用rabbitMQ插件来实现延时队列，安装插件、创建指定的队列和交换机发送的时候指定延时时间就可以了。</p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>//Rabbbit使用场景</p>
<p>//RabbitMQ确认消息收到的机制</p>
<p>//RabbitMQ确认消息唯一的机制</p>
<p>//RabbitMQ消息的持久化</p>
<p>//RabbitMQ的死信队列</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>一般编写了config类，直接使用即可，因为springboot对当前包的bean都扫描了</p>
<p>启用对@ConfigurationProperties注释 bean 的支持。 @ConfigurationProperties bean 可以以标准方式注册（例如使用@Bean方法），或者为了方便，可以直接在此注释上指定。</p>
<p>@SpringBootApplicationh注解是三个注解的集合体@Configuration,@EnableAutoConfiguration,@ComponentScan，会自动扫描当前包及子包的所有注入bean吗，会自动根据xml文件配置相关bean</p>
<p>导入相关依赖</p>
<p>创建bean，指定创建的交换机和队列的属性，是否持久化</p>
<p>使用rabbitTemplate发送消息即可，发送消息时需要指定交换机、绑定key、发送的对象</p>
<p>持久化需要交换机持久化、队列持久化。消息持久化</p>
<p>交换机和队列可以在创建bean的时候指定是否持久化</p>
<p>消息持久化需要在发送的时候确定，默认是自动持久化的。不过需要队列先持久化</p>
<p>message 从 producer 到 rabbitmq broker cluster 则会返回一个 confirmCallback 。</p>
<p>重点是 CorrelationData 对象，每个发送的消息都需要配备一个 CorrelationData 相关数据对象，CorrelationData 对象内部只有一个 id 属性，用来表示当前消息唯一性。</p>
<p>发送的时候创建一个 CorrelationData 对象。</p>
<p>message 从 exchange-&gt;queue 投递失败则会返回一个 returnCallback 。我们将利用这两个 callback 控制消息的最终一致性和部分纠错能力。</p>
<p>必须 rabbitTemplate.setMandatory(true)，不然当 发送到交换器成功，但是没有匹配的队列，不会触发 ReturnCallback 回调。而且 ReturnCallback 比 ConfirmCallback 先回调。</p>
<p>后一个callback会导致性能下降，尽量少用</p>
<p>接收：</p>
<p>接收需要手动确认，需要在配置文件中开启一项设置</p>
<p>编写方法即可，填写相关的入参，然后判断ID，就是deliverTag，deliverTag是递增的，然后ack即可。处理完毕或者先ACK都可以。</p>
<p>练习</p>
<p>//练习RabbitMQ中的一些基础概念</p>
<p>//练习发送的确认</p>
<p>//练习消费的确认</p>
<p>controller发送指定交换机的消息</p>
<p>消费者消费，并且返回ack</p>
<p>打印这条消息</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/" data-id="ckuqw9s950020xcupcppn4xv8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-中间件/Redis/Redis相关知识点" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/Redis%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/" class="article-date">
  <time datetime="2021-10-14T10:09:31.649Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>►<a class="article-category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/">Redis</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Redis基础概念"><a href="#Redis基础概念" class="headerlink" title="Redis基础概念"></a>Redis基础概念</h2><h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><p>​    Redis是一个高性能的key-value数据库。支持数据持久化，可以将内存中的数据保存在磁盘中，重启的时候再次加载使用。读的速度为110000次/s写的速度为81000次/s。操作都是原子操作。redis支持的类型：String、list、set、Zsetsorted set、Hash等。redis是单进程，单线程单，通过队列技术将并发访问变为串行访问。</p>
<ul>
<li>当Redis内存满了后，写命令会返回错误信息，读命令还是可以正常返回。</li>
</ul>
<h3 id="持久化机制和原理"><a href="#持久化机制和原理" class="headerlink" title="持久化机制和原理"></a>持久化机制和原理</h3><p>Redis有两个持久化策略：RDB和AOF</p>
<h4 id="RDB快照"><a href="#RDB快照" class="headerlink" title="RDB快照"></a>RDB快照</h4><p>​    Redis支持将当前数据的快照存成一个数据文件的持久化机制。而一个持续写入的数据库如何生成快照呢。Redis借助了fork命令的copy on write机制。在生成快照时，将当前进程fork出一个子进程，然后在子进程中循环所有的数据，将数据写如一个临时文件，持久化结束后，用这个临时文件代替上一个持久化文件，也就是rename。由于os的写时复制机制（copy on write)父子进程会共享相同的物理页面，当父进程处理写请求时os会为父进程要修改的页面创建副本，而不是写共享的页面。所以子进程的地址空间内的数据是fork时刻整个数据库的一个快照。即持久化后的数据库的修改不会记录到持久化文件中，这个也是它的一个缺点之一，因为有可能从持久化后到服务器断电之前到数据都会丢失，主要是看项目的取舍。而且RDB快照是全量持久化，并不是增量持久化。</p>
<p>​    在redis客户端中执行<code>save 60 1000</code>(60秒内，如果有1000个键被修改就执行RDB)命令即可调用RDB快照的备份。</p>
<h4 id="AOF日志"><a href="#AOF日志" class="headerlink" title="AOF日志"></a>AOF日志</h4><p>​    AOF日志的全称是Append Only File，是一个追加写入的日志。但是AOF日志文件里面存储的是redis的标准命令，有些命令经过转化，例如删除一个不存在的键，redis认为不会对数据库造成造成修改，所以不会记录在AOF日志文件中，有些命令因为操作系统的不同可能会导致执行结果不同，所以都转换为统一的命令。</p>
<ul>
<li>AOF rewrite：功能就是重新生成一份AOF文件，新的AOF文件中一条记录的操作只会有一次，而不像一份老文件那样，可能记录了对同一个值的多次操作。其生成过程和RDB类似，也是fork一个进程，直接遍历数据，写入新的AOF临时文件。在写入新文件的过程中，所有的写操作日志还是会写到原来老的 AOF文件中，同时还会记录在内存缓冲区中。当重完操作完成后，会将所有缓冲区中的日志一次性写入到临时文件中。然后调用原子性的rename命令用新的 AOF文件取代老的AOF文件。 </li>
</ul>
<p>​    在Redis中对AOF调用write写入后，何时再调用fsync将其写到磁盘上，通过appendfsync选项来控制，下面appendfsync的三个设置项，安全强度逐渐变强。 通过设置配置项来实现AOF备份：<code>appendonly yes</code>,通过配置<code>appendfsync</code>来设置何时写到磁盘上。</p>
<ul>
<li>appendfsync no ：当设置appendfsync为no的时候，Redis不会主动调用fsync去将AOF日志内容同步到磁盘，所以这一切就完全依赖于操作系统的调试了。对大多数Linux操作系统，是每30秒进行一次fsync，将缓冲区中的数据写到磁盘上。 </li>
<li>appendfsync everysec：当设置appendfsync为everysec的时候，Redis会默认每隔一秒进行一次fsync调用，将缓冲区中的数据写到磁盘。但是当这一 次的fsync调用时长超过1秒时。Redis会采取延迟fsync的策略，再等一秒钟。也就是在两秒后再进行fsync，这一次的fsync就不管会执行多长时间都会进行。这时候由于在fsync时文件描述符会被阻塞，所以当前的写操作就会阻塞。 </li>
<li>appednfsync always：当设置appendfsync为always时，每一次写操作都会调用一次fsync，这时数据是最安全的，当然，由于每次都会执行fsync，所以其性能也会受到影响。 </li>
</ul>
<h3 id="Redis的内存回收策略"><a href="#Redis的内存回收策略" class="headerlink" title="Redis的内存回收策略"></a>Redis的内存回收策略</h3><p>​    如果redis占用的内存满了，可以通过设置内存回收策略来进行键值淘汰，配置项为：<code>maxmemory-policy</code>。主动清除策略主要有八种：</p>
<blockquote>
<ul>
<li><p>volatile-ttl：在筛选时，会针对设置了过期时间的键值对，根据过期时间的先后进行删除，越早过期的越先被删除。</p>
</li>
<li><p>volatile-random：就像它的名称一样，在设置了过期时间的键值对中，进行随机删除。</p>
</li>
<li><p>volatile-lru：会使用 LRU 算法筛选设置了过期时间的键值对删除。（LRU：最近最少使用）</p>
</li>
<li><p>volatile-lfu：会使用 LFU 算法筛选设置了过期时间的键值对删除（LFU：最不经常使用）</p>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>allkeys-random：从所有键值对中随机选择并删除数据。</p>
</li>
<li><p>allkeys-lru：使用 LRU 算法在所有数据中进行筛选删除。</p>
</li>
<li><p>allkeys-lfu：使用 LFU 算法在所有数据中进行筛选删除。</p>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>noeviction：不会剔除任何数据，拒绝所有写入操作并返回客户端错误信息”(error) OOM command not allowed when used memory”，此时Redis只响应读操作。</li>
</ul>
</blockquote>
<p>LRU是最近最少使用页面置换算法(Least Recently Used),也就是首先淘汰最长时间未被使用的页面!</p>
<p>LFU是最近最不常用页面置换算法(Least Frequently Used),也就是淘汰一定时期内被访问次数最少的页!</p>
<h3 id="Redis的键删除策略"><a href="#Redis的键删除策略" class="headerlink" title="Redis的键删除策略"></a>Redis的键删除策略</h3><p>​    Redis过期key的删除方式有三种：</p>
<ul>
<li>被动删除：当读/写一个已经过期的key时，会触发惰性删除策略，直接删除掉这个过期key。返回nil。</li>
<li>主动删除：由于惰性删除策略无法保证冷数据被及时删掉，所以Redis会定期主动淘汰一批已过期的key。<ul>
<li>随机测试100个设置了过期时间的key</li>
<li>删除所有发现的已过期的key</li>
<li>若删除的key超过25个则重复步骤1</li>
</ul>
</li>
<li>当前已用内存超过maxmemory限定时，触发主动清理策略。</li>
</ul>
<h3 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h3><p>​    Redis有三种集群模式：主从模式、Sentinel模式（哨兵模式）、Cluster模式（集群模式）。</p>
<h4 id="主从模式"><a href="#主从模式" class="headerlink" title="主从模式"></a>主从模式</h4><p>​    主从模式将数据库分为两种，主库和从库。主数据库可以进行读和写，从数据库只能进行读。多个从数据库对应一个主数据库，从数据库挂了重启后会向主数据库请求同步数据。主数据库挂掉后，不影响从数据库的读，但是不能提供写服务了。</p>
<p>​    机制：当slave启动后，主动向master发送SYNC命令。master接收到SYNC命令后在后台保存快照（RDB持久化）和缓存保存快照这段时间的命令，然后将保存的快照文件和缓存的命令发送给slave。slave接收到快照文件和命令后加载快照文件和缓存的执行命令。复制初始化后，master每次接收到的写命令都会同步发送给slave，保证主从数据一致性。</p>
<p>​    缺点就是主数据挂掉后，redis无法提供写服务。</p>
<p>​    搭建方式：通过下载redis安装包，安装后，通过启动不同的配置文件来达到多个redis服务的目的。在配置文件中配置主数据库和从数据库即可。</p>
<h5 id="流程和细节"><a href="#流程和细节" class="headerlink" title="流程和细节"></a>流程和细节</h5><p>建立连接阶段（即准备阶段）</p>
<ol>
<li>设置master的地址和端口，保存master信息</li>
<li>建立socket链接</li>
<li>发送ping命令（定时器任务）</li>
<li>身份验证</li>
<li>发送slave端口信息<br>至此，主从链接成功！</li>
</ol>
<p>数据同步阶段（注意从机命令为psync，主机命令为bgsave）</p>
<p>步骤1：请求同步<br>步骤2：创建RDB同步数据<br>步骤3：恢复RDB同步数据<br>步骤4：请求部分同步数据<br>步骤5：恢复部分同步数据<br>至此，数据同步工作完成</p>
<p>命令传播阶段</p>
<p>通过ping命令，从机通知主机发送缓冲区内的命令</p>
<h4 id="Sentinel模式（哨兵模式）"><a href="#Sentinel模式（哨兵模式）" class="headerlink" title="Sentinel模式（哨兵模式）"></a>Sentinel模式（哨兵模式）</h4><p>​    主从模式的弊端就是主数据库挂掉后，从数据库无法提供写的服务，所以产生了哨兵模式。</p>
<p>​    Sentinel是一个进程，用来监控redis进程的状态，Sentinel也可以启动多个形成一个集群。当Sentinel检测到主节点挂掉后，会将从节点升级为主节点，并修改其他所有节点的配置文件。当主节点再次启动后，会变为从节点。从节点故障后，哨兵不会进行故障转移。</p>
<p>​    机制：每个Sentinel会每秒钟一次的频率向所有的主从节点发送PING命令，如果实例的回复超过了指定的值（通过配置down-after-milliseconds,默认是30秒），则会被Sentinel标记为主观下线。如果主节点标记主观下线，其他Sentinel都要确认这个主节点下线，。当Sentinel的确认数量超过了配置值后，认为主节点客观下线。将每10一次发送的INFO命令变为1秒发送一次。</p>
<h5 id="具体的流程和细节"><a href="#具体的流程和细节" class="headerlink" title="具体的流程和细节"></a>具体的流程和细节</h5><p>​    哨兵在进行主从切换过程中经历三个阶段</p>
<p>1.监控阶段</p>
<p>​    单个哨兵通过和主节点建立cmd链接，发送info命令，得到主节点的信息和各个从节点的信息，同时在主节点内存储哨兵实例的信息。主节点信息同步完毕后，向从节点建立链接，发送info命令，完善从节点的信息。</p>
<p>​    当其他哨兵加入进来时，链接到主节点后，发现主节点内有哨兵实例，通过发布订阅的形式，将两个哨兵实例的信息进行同步，后续的哨兵都是这样。</p>
<p>2.通知阶段</p>
<p>​    哨兵通过建立的cmd链接，发送相应的命令给节点，节点将状态信息返回，然后该哨兵通过发布订阅将信息同步给其他哨兵。</p>
<p>3.故障转移</p>
<p>​        一个哨兵发现主节点发送info命令没有回复，通知其他哨兵，并且将主节点状态修改为主观下线。其他哨兵也发送命令给主节点，如果确认的哨兵数超过了设定的值，就认为该主节点客观下线。然后哨兵之间需要选举出一个哨兵执行节点切换的任务。</p>
<p>​    每个哨兵都有一票，这票投给自己最先收到竞选通知的哨兵，直到某个哨兵票数超过一半以上，就认为该哨兵负责本次的切换。</p>
<p>​    哨兵从剩下的从节点中选出最优的主节点。先筛选出在线的，再筛选出响应快的，再筛选出和原先主节点同步时间最近的，最后还有多个的话，就按照优先原则，偏移量和uuid都会有影响。最后选出一个从节点，然后将这个从节点升级为主节点，将其他从节点的主节点的信息修改为新的主节点。后面如果掉线的主节点上线的话，也会修改为从节点。</p>
<h4 id="Cluster模式（集群模式）"><a href="#Cluster模式（集群模式）" class="headerlink" title="Cluster模式（集群模式）"></a>Cluster模式（集群模式）</h4><p>​    哨兵模式基本可以满足生产的需要，但是当数据量过大，导致一台机器无法满足时，这个时候就需要将数据进行分片存储，这就是集群模式。</p>
<p>​    Redis集群是一个由多个节点组成的分布式服务器群，它具有复制、高可用和分片特性；Redis集群没有中心节点，并且带有复制和故障转移特性，这可以避免单个节点成为性能瓶颈，或者因为某个节点下线而导致整个集群下线；</p>
<p>​    我们有3个主节点，3个从节点，每个主节点处理各自的数据，提供读写能力，从节点异步复制主节点的数据。一般读请求分配给从节点，写请求分配给主节点。</p>
<h5 id="数据分片"><a href="#数据分片" class="headerlink" title="数据分片"></a>数据分片</h5><p>​    一个 Redis 集群包含 16384 个哈希槽（hash slot）， 它们的编号为0、1、2、3……16382、16383，这个槽是一个逻辑意义上的槽，实际上并不存在。redis中的每个key都属于这 16384 个哈希槽的其中一个，存取key时都要进行key-&gt;slot的映射计算。Redis Cluster中的每个Master节点都会负责一部分的槽，当有某个key被映射到某个Master负责的槽，那么这个Master负责为这个key提供服务。在Redis Cluster中，只有Master才拥有槽的所有权，如果是某个Master的slave，这个slave只负责槽的使用，但是没有所有权。</p>
<h5 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h5><p>​    在cluster中，节点之间通过gossip协议进行通信。A节点会发送PING消息给B节点，若是在cluster_node_timeout时长内没有收到B节点的回复消息，则A节点会判定B节点已经下线了。这时候，A节点判定完后，会想集群广播B节点下线的消息。如果集群中的超过半数以上的节点都认为B节点下线后，B节点就会真正的下线。</p>
<p>​    当问题节点下线后，如果该下线节点是带有槽的主节点，则需要从它的从节点选出一个替换它，当问题节点的从节点发现其主节点下线时，将会触发故障恢复流程。但是并不是所有的从节点都能参与到故障恢复的流程中，若从节点与问题主节点的断线时间超过cluster_node_timeout * cluster-slave-validity-factor时，该从节点不能参与到后续恢复流程。</p>
<p>​    主要是通过对多个从节点使用不同的延迟选举时间来支持优先级问题。复制偏移量越大说明从节点延迟越低，那么它应该具有更高的优先级来替换故障主节点。</p>
<h4 id="Redis中的脑裂现象"><a href="#Redis中的脑裂现象" class="headerlink" title="Redis中的脑裂现象"></a>Redis中的脑裂现象</h4><p>​    redis中的脑裂现象：哨兵将发现主节点下线后，将一个从节点升级为主节点，但是仍然有客户端连接旧的主节点，两个主节点造成数据没有同步，后续主节点恢复后，数据仍然丢失。可以通过设置第一个参数表示连接到master的最少slave数量，第二个参数表示slave连接到master的最大延迟时间这两个参数。如果两个条件都不满足，主节点就会拒绝同步数据。防止脑裂现象的产生。</p>
<h3 id="Redis中的发布订阅"><a href="#Redis中的发布订阅" class="headerlink" title="Redis中的发布订阅"></a>Redis中的发布订阅</h3><p>​    Redis中的发布订阅可以使用匹配符，需要注意当没有消费者时，生产者发布的消息可能会丢失。</p>
<h3 id="Redis中的事务"><a href="#Redis中的事务" class="headerlink" title="Redis中的事务"></a>Redis中的事务</h3><p>​    Redis中的事务比较独特。事务开启后，会将命令都放入队列缓存中，其他客户端的命令不会放入。事务执行后，如果遇到命令格式错误，事务中所有的操作都不会被执行。但是如果命令格式正确，使用方式不对，例如对String执行hash方法，该命令不会被执行，其他正确命令仍然会被执行。</p>
<p>​    watch是为了完善redis事务的特点，在事务开始前监听某个key，如果事务中间key发生了变化，事务就会中断，不再执行。unwatch是为了取消监听，防止本次的监听对下次的事务产生影响。exec和discard也有同样的效果。</p>
<p>​    如果客户端发送的命令为 EXEC 、 DISCARD 、 WATCH 、 MULTI 四个命令的其中一个， 那么服务器立即执行这个命令。如果不是这四个命令，服务器并不立即执行这个命令， 而是将这个命令放入一个事务队列里面， 然后向客户端返回 QUEUED。某些命令执行出错也不会影响整个事务。</p>
<h3 id="Redis中的管道"><a href="#Redis中的管道" class="headerlink" title="Redis中的管道"></a>Redis中的管道</h3><p>​    Redis默认每次执行请求都会创建和断开一次连接池的操作，因此我们可以使用Redis的管道来一次性发送多条命令并返回多个结果，节约发送命令和创建连接的时间提升效率。</p>
<p>​    Redis中管道的实现是根据队列，可以保证数据的顺序性。</p>
<h2 id="Redis数据结构相关知识点"><a href="#Redis数据结构相关知识点" class="headerlink" title="Redis数据结构相关知识点"></a>Redis数据结构相关知识点</h2><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><ul>
<li>一个键最大能存储 512MB，暂时没有找到原因</li>
</ul>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><ul>
<li>列表最多可存储 232 - 1 元素 (4294967295, 每个列表可存储40多亿)。</li>
<li>Redis list的实现为一个双向链表，即可以支持反向查找和遍历，更方便操作，不过带来了部分额外的内存开销。</li>
</ul>
<h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><ul>
<li>列表最多可存储 232 - 1 元素 (4294967295, 每个列表可存储40多亿)。</li>
<li>hash的原理也是数组加链表，扩容机制不太一样，是双table扩容，新的table要扩容时，是在执行完原油命令后，将就table上的元素慢慢复制到新table。这就是渐进式扩容。但是还是存在一些问题的，就是极端情况下，如果键一直在增加，新table也会很快触发扩容，这种情况下如何处理，这里其实估计只有后续看源码能够想清楚了。</li>
</ul>
<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><ul>
<li>列表最多可存储 232 - 1 元素 (4294967295, 每个列表可存储40多亿)。</li>
<li>Redis 的 Set 是 String 类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。</li>
<li>set 的内部实现是一个 value永远为null的HashMap，实际就是通过计算hash的方式来快速排重的，这也是set能提供判断一个成员是否在集合内的原因。</li>
</ul>
<h3 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h3><ul>
<li>列表最多可存储 232 - 1 元素 (4294967295, 每个列表可存储40多亿)。</li>
<li>Zset就是排序集合，在插入时需要制定元素的权，redis也是根据权来进行排序的。权相同时，则是根据字典排序。</li>
</ul>
<h3 id="跳跃表（skiplist）"><a href="#跳跃表（skiplist）" class="headerlink" title="跳跃表（skiplist）"></a>跳跃表（skiplist）</h3><p>​    跳跃表以有序的方式在层次化的链表中保存元素， 效率和平衡树媲美 —— 查找、删除、添加等操作都可以在对数期望时间下完成， 并且比起平衡树来说， 跳跃表的实现要简单直观得多。</p>
<p>​    跳表相当于是在链表的形式上添加层级来达到快速查询的目的。</p>
<h2 id="Redis相关命令"><a href="#Redis相关命令" class="headerlink" title="Redis相关命令"></a>Redis相关命令</h2><h3 id="Redis常用的基础命令"><a href="#Redis常用的基础命令" class="headerlink" title="Redis常用的基础命令"></a>Redis常用的基础命令</h3><ul>
<li>启动：<code>redis-server redis.conf</code></li>
<li>连接：<code>redis-cli -h host -p port -a password</code></li>
<li>获取配置：<code>CONFIG GET *</code></li>
<li>设置配置：<code>ONFIG SET loglevel &quot;notice&quot;</code></li>
<li>删除key：<code>del tset</code></li>
<li>序列化给定 key ，并返回被序列化的值:<code>dump test</code></li>
<li>检查给定 key 是否存在:<code>EXISTS test</code></li>
<li>为给定 key 设置过期时间，以秒计:<code>EXPIRE test 120</code></li>
<li>为给定 key 设置过期时间,接受的时间参数是 UNIX 时间戳: <code>EXPIREAT test 1623297047</code></li>
<li>设置 key 的过期时间以毫秒计:<code>PEXPIRE test 120000</code></li>
<li>设置 key 过期时间的时间戳(unix timestamp) 以毫秒计:<code>PEXPIREAT test 1623297047000</code></li>
<li>查找所有符合给定模式( pattern)的 key :<code>keys tes*</code></li>
<li>将当前数据库的 key 移动到给定的数据库 db 当中:<code>move test 1</code></li>
<li>移除 key 的过期时间，key 将持久保持:<code>PERSIST test</code></li>
<li>以毫秒为单位返回 key 的剩余的过期时间:<code>PTTL test</code></li>
<li>以秒为单位，返回给定 key 的剩余生存时间(TTL, time to live):<code>TTL test</code></li>
<li>从当前数据库中随机返回一个 key :<code>RANDOMKEY</code></li>
<li>修改 key 的名称:<code>RENAME test test1</code></li>
<li>仅当 newkey 不存在时，将 key 改名为 newkey:<code>RENAMENX test1 test</code></li>
<li>迭代数据库中的数据库键:<code>SCAN cursor [MATCH pattern] [COUNT count]</code></li>
<li>返回 key 所储存的值的类型:<code>type test</code></li>
<li>验证密码是否正确：<code>AUTH qhlk@2017</code></li>
<li>打印字符串：<code>ECHO &quot;this is test&quot;</code>(当你的字符串中间带特殊字符时，需要你带上双引号)</li>
<li>查看服务是否运行：<code>PING</code></li>
<li>关闭当前连接：<code>QUIT</code></li>
<li>切换到指定的数据库：<code>SELECT 0</code>(总共十六个库，0-15)</li>
<li>创建当前数据库的备份：<code>SAVE</code></li>
<li>根据备份文件恢复redis数据库：<code>BGSAVE</code></li>
</ul>
<h3 id="字符串相关命令"><a href="#字符串相关命令" class="headerlink" title="字符串相关命令"></a>字符串相关命令</h3><ul>
<li>设置指定 key 的值：<code>set tset &quot;hello&quot;</code>也可以对存在的key执行就是修改</li>
<li>获取指定 key 的值：<code>GET test1</code></li>
<li>返回 key 中字符串值的子字符：<code>GETRANGE test1 0 5</code></li>
<li>将给定 key 的值设为 value ，并返回 key 的旧值(old value)：<code>GETSET test1 &quot;this is test1.&quot;</code></li>
<li>对 key 所储存的字符串值，获取指定偏移量上的位(bit)：<code>GETBIT test1 10</code></li>
<li>获取所有(一个或多个)给定 key 的值：<code>MGET test test1</code></li>
<li>对 key 所储存的字符串值，设置或清除指定偏移量上的位(bit)：<code>SETBIT test1 10 1</code></li>
<li>将值 value 关联到 key ，并将 key 的过期时间设为 seconds (以秒为单位)：<code>SETEX test1 120 &quot;this is test1&quot;</code></li>
<li>只有在 key 不存在时设置 key 的值：<code>SETNX test1 &quot;hello&quot;</code></li>
<li>用 value 参数覆写给定 key 所储存的字符串值，从偏移量 offset 开始：<code>SETRANGE test2 1 &quot;hahaha&quot;</code></li>
<li>返回 key 所储存的字符串值的长度：<code>STRLEN test2</code></li>
<li>同时设置一个或多个 key-value 对：<code>mset key &quot;2&quot; key2 &quot;this is &quot;</code></li>
<li>同时设置一个或多个 key-value 对，当且仅当所有给定 key 都不存在：<code>MSETNX ke2 &quot;test&quot; key &quot;haha&quot;</code></li>
<li>这个命令和 SETEX 命令相似，但它以毫秒为单位设置 key 的生存时间：<code>PSETEX key 120000 &quot;this &quot;</code></li>
<li>将 key 中储存的数字值增一：<code>INCR key</code></li>
<li>将 key 所储存的值加上给定的增量值（increment）：<code>INCRBY ke2 34</code></li>
<li>将 key 中储存的数字值减一：<code>DECR ke2</code></li>
<li>key 所储存的值减去给定的减量值（decrement） ：<code>DECRBY ke2 3</code></li>
<li>如果 key 已经存在并且是一个字符串， APPEND 命令将指定的 value 追加到该 key 原来值（value）的末尾：<code>APPEND key &quot;end&quot;</code></li>
</ul>
<h3 id="HASH相关命令"><a href="#HASH相关命令" class="headerlink" title="HASH相关命令"></a>HASH相关命令</h3><ul>
<li>删除一个或多个哈希表字段：<code>HDEL testhash object</code></li>
<li>查看哈希表 key 中，指定的字段是否存在：<code>HEXISTS testhash2 bug</code></li>
<li>获取存储在哈希表中指定字段的值：<code>HGET testhash2 age</code></li>
<li>获取在哈希表中指定 key 的所有字段和值：<code>HGETALL testhash2</code></li>
<li>为哈希表 key 中的指定字段的整数值加上增量 increment ：<code>HINCRBY testhash2 age 1</code></li>
<li>为哈希表 key 中的指定字段的浮点数值加上增量 increment ：<code>HINCRBYFLOAT testhash2 money 3.4</code></li>
<li>获取所有哈希表中的字段：<code>HKEYS testhash2</code></li>
<li>获取哈希表中字段的数量：<code>HLEN testhash2</code></li>
<li>获取所有给定字段的值：<code>HMGET testhash2 redis mysql age</code></li>
<li>同时将多个 field-value (域-值)对设置到哈希表 key 中：<code>HMSET testhash2 age 13 money 13.4 name lihua</code></li>
<li>将哈希表 key 中的字段 field 的值设为 value ：<code>HSET testhash2 redis good mysql bad rabbitmq bad</code>(也可以设置多个字段)</li>
<li>只有在字段 field 不存在时，设置哈希表字段的值:<code>HSETNX testhash2 tag &quot;null&quot;</code></li>
<li>获取哈希表中所有值:<code>HVALS testhash2</code></li>
<li>迭代哈希表中的键值对:<code>HSCAN key cursor [MATCH pattern] [COUNT count]</code></li>
</ul>
<h3 id="LIST相关命令"><a href="#LIST相关命令" class="headerlink" title="LIST相关命令"></a>LIST相关命令</h3><ul>
<li>移出并获取列表的第一个元素， 如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止：<code>BLPOP testlist2 10</code></li>
<li>移出并获取列表的最后一个元素， 如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止：<code>BRPOP testlist2 10</code></li>
<li>从列表中弹出一个值，将弹出的元素插入到另外一个列表中并返回它； 如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止：<code>BRPOPLPUSH testlist testlist5 10</code>（从尾部取出，插入到另一个列表的头部）</li>
<li>通过索引获取列表中的元素：<code>LINDEX testlist 3</code></li>
<li>在列表的元素前或者后插入元素：<code>LINSERT testlist AFTER test &quot;after&quot;</code></li>
<li>获取列表长度：<code>LLEN testlist</code></li>
<li>移出并获取列表的第一个元素：<code>LPOP testlist</code></li>
<li>将一个或多个值插入到列表头部：<code>LPUSH testlist &quot;hehe&quot; &quot;test222&quot;</code></li>
<li>将一个值插入到已存在的列表头部：<code>LPUSHX testlist1 &quot;hehe&quot; &quot;test222&quot;</code></li>
<li>获取列表指定范围内的元素：<code>LRANGE testlist 0 2</code></li>
<li>移除列表元素：<code>LREM testlist 0 &quot;haha&quot;</code></li>
<li>通过索引设置列表元素的值：<code>LSET testlist 0 &quot;this is test&quot;</code></li>
<li>对一个列表进行修剪(trim)，就是说，让列表只保留指定区间内的元素，不在指定区间之内的元素都将被删除：<code>LTRIM testlist 0 4</code></li>
<li>移除列表的最后一个元素，返回值为移除的元素：<code>RPOP testlist</code></li>
<li>移除列表的最后一个元素，并将该元素添加到另一个列表并返回：<code>RPOPLPUSH testlist testlist2</code>(头部插入)</li>
<li>在列表中添加一个或多个值：<code>RPUSH testlist &quot;test&quot; &quot;test2&quot;</code>(添加到尾部)</li>
<li>为已存在的列表添加值：<code>RPUSHX mylist &quot;test&quot;</code></li>
</ul>
<h3 id="SET相关命令"><a href="#SET相关命令" class="headerlink" title="SET相关命令"></a>SET相关命令</h3><ul>
<li>向集合添加一个或多个成员：<code>SADD myset &quot;123&quot; 3</code>（这里是多个成员，分别为字符串123和int 3）</li>
<li>获取集合的成员数：SCARD myset</li>
<li>返回第一个集合与其他集合之间的差异：<code>SDIFF myset myset1</code>(主要返回前面集合中的差异，后面集合元素不会返回)</li>
<li>返回给定所有集合的差集并存储在 destination 中：<code>SDIFFSTORE myset2 myset myset1</code></li>
<li>返回给定所有集合的交集：<code>SINTER myset myset2</code></li>
<li>返回给定所有集合的交集并存储在 destination 中：<code>SINTERSTORE myset3 myset myset2</code></li>
<li>判断 member 元素是否是集合 key 的成员：<code>SISMEMBER myset &quot;123&quot;</code></li>
<li>返回集合中的所有成员：<code>SMEMBERS myset1</code></li>
<li>将 member 元素从 source 集合移动到 destination 集合：<code>SMOVE myset2 myset1 &quot;3&quot;</code></li>
<li>移除并返回集合中的一个随机元素：<code>spop myset1</code></li>
<li>返回集合中一个或多个随机数：<code>SRANDMEMBER myset1 2</code></li>
<li>移除集合中一个或多个成员：<code>SREM myset1 &quot;haha&quot;</code></li>
<li>返回所有给定集合的并集：<code>SUNION myset myset1</code></li>
<li>所有给定集合的并集存储在 destination 集合中：<code>SUNIONSTORE myset4 myset myset1</code></li>
<li>迭代集合中的元素：<code>SSCAN key cursor [MATCH pattern] [COUNT count]</code></li>
</ul>
<h3 id="有序集合相关命令"><a href="#有序集合相关命令" class="headerlink" title="有序集合相关命令"></a>有序集合相关命令</h3><ul>
<li>向有序集合添加一个或多个成员，或者更新已存在成员的分数：<code>ZADD myzset 1 &quot;test1&quot; 2 &quot;test2&quot;</code></li>
<li>获取有序集合的成员数：<code>ZCARD myzset</code></li>
<li>计算在有序集合中指定区间分数的成员数：<code>ZCOUNT myzset 0 2</code></li>
<li>有序集合中对指定成员的分数加上增量 increment：<code>ZINCRBY myzset 2 &quot;test2&quot;</code></li>
<li>计算给定的一个或多个有序集的交集并将结果集存储在新的有序集合 destination 中：<code>ZINTERSTORE summyzset 2 myzset myzset2</code>(中间的数字2代表有两个set合并)</li>
<li>在有序集合中计算指定字典区间内成员数量：<code>ZLEXCOUNT myzset - +</code>(不清楚为啥)</li>
<li>通过索引区间返回有序集合指定区间内的成员：<code>ZRANGE myzset 0 -1 withscores</code>(withscores是表示将权一块显示出来，0代表排序的第一位，2代表排序集合的第三个元素)</li>
<li>通过字典区间返回有序集合的成员：<code>ZRANGEBYLEX myzset - +</code>(-号代表底，+号代表最高)</li>
<li>通过分数返回有序集合指定区间内的成员：<code>ZRANGEBYSCORE myzset (0 (2 withscores</code>(（代表不包含0，[代表包含,这里的分数就带代表权)</li>
<li>返回有序集合中指定成员的索引：<code>ZRANK myzset &quot;test1&quot;</code>(索引即时该元素在排序集合中的位置)</li>
<li>移除有序集合中的一个或多个成员：<code>ZREM myzset &quot;test1&quot;</code></li>
<li>移除有序集合中给定的字典区间的所有成员：<code>ZREMRANGEBYLEX myzset2 - +</code></li>
<li>移除有序集合中给定的排名区间的所有成员：<code>ZREMRANGEBYRANK myzset 0 0</code></li>
<li>移除有序集合中给定的分数区间的所有成员：<code>ZREMRANGEBYSCORE myzset 0 5</code> </li>
<li>返回有序集中指定区间内的成员，通过索引，分数从高到低：<code>ZREVRANGE myzset 0 -1 withscores</code></li>
<li>返回有序集中指定分数区间内的成员，分数从高到低排序：<code>ZREVRANGEBYSCORE myzset 100 0</code>(也存在根据字典区间的命令)</li>
<li>返回有序集合中指定成员的排名，有序集成员按分数值递减(从大到小)排序：<code>ZRANK myzset lisi</code>(查询lisi在有序集合中的排名)</li>
<li>返回有序集中，成员的分数值：<code>ZSCORE myzset lisi</code></li>
<li>计算给定的一个或多个有序集的并集，并存储在新的 key 中：<code>ZUNIONSTORE out 2 zset1 zset2 WEIGHTS 2 3</code>(看不懂)</li>
<li>迭代有序集合中的元素（包括元素成员和元素分值）：<code>ZSCAN site 0 match &quot;R*&quot;</code></li>
</ul>
<h3 id="HyperLogLog相关命令"><a href="#HyperLogLog相关命令" class="headerlink" title="HyperLogLog相关命令"></a>HyperLogLog相关命令</h3><p>​    redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。在Redis里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基 数。比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是在误差可接受的范围内，快速计算基数。但是HyperLogLog 只会计算基数，不会存储元素本身。</p>
<ul>
<li>添加指定元素到 HyperLogLog 中：<code>PFADD mypf &quot;redis&quot;</code>(后面可以跟多个元素，元素可以不带引号，存储的都是字符串类型)</li>
<li>返回给定 HyperLogLog 的基数估算值：<code>PFCOUNT mypf</code></li>
<li>将多个 HyperLogLog 合并为一个 HyperLogLog：<code>PFMERGE mypf3 mypf mypf2</code></li>
</ul>
<h3 id="发布订阅相关命令"><a href="#发布订阅相关命令" class="headerlink" title="发布订阅相关命令"></a>发布订阅相关命令</h3><p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。Redis 客户端可以订阅任意数量的频道。</p>
<ul>
<li>订阅一个或多个符合给定模式的频道：<code>PSUBSCRIBE testchannel</code>(后面参数类似于正则表达式)</li>
<li>查看订阅与发布系统状态：<code>PUBSUB channels</code>(目前不清楚用法，现在参数固定)</li>
<li>将信息发送到指定的频道：PUBLISH testchannel “this is test”</li>
<li>退订所有给定模式的频道：PUNSUBSCRIBE mychannel </li>
<li>订阅给定的一个或多个频道的信息：SUBSCRIBE testchannel</li>
<li>指退订给定的频道：UNSUBSCRIBE mychannel</li>
</ul>
<h3 id="Redis中的事务-1"><a href="#Redis中的事务-1" class="headerlink" title="Redis中的事务"></a>Redis中的事务</h3><ul>
<li>取消事务，放弃执行事务块内的所有命令:<code>DISCARD</code></li>
<li>执行所有事务块内的命令:<code>EXEC</code></li>
<li>标记一个事务块的开始:<code>MULTI</code>（连续执行两次multi不会导致事务回滚）</li>
<li>取消 WATCH 命令对所有 key 的监视:UNWATCH（使用方法是在watch前面，并不是在事务中取消监视，而是在监视前取消所有的其他监视，所以只要调用了watch，key被修改，就会出错。只是为了完善redis事务的一个点）</li>
<li>监视一个(或多个) key ，如果在事务执行之前这个(或这些) key 被其他命令所改动，那么事务将被打断:<code>WATCH lock</code>（在multi里面执行watch不会导致事务回滚。）</li>
</ul>
<h2 id="Redis在SpringBoot中的应用"><a href="#Redis在SpringBoot中的应用" class="headerlink" title="Redis在SpringBoot中的应用"></a>Redis在SpringBoot中的应用</h2><h2 id="Redis实际中的应用和解决方案"><a href="#Redis实际中的应用和解决方案" class="headerlink" title="Redis实际中的应用和解决方案"></a>Redis实际中的应用和解决方案</h2><h3 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h3><p>​    对于一些设置了过期时间的key，如果这个key可能会在某些时间点被超高并发地访问，是一个热点数据，当这个key过期后，这个时间点有大量并发去请求这个key，该key没有命中，大量的请求穿透到数据库服务器。</p>
<p>​    解决方案：有两种方案，1）将热点数据设置永不过期。2）使用互斥锁：先从redis获取数据，如果redis中数据没有，去争夺锁，拿到锁的线程去查询数据库，然后见过结果放入redis中。其他没抢到的，等一段时间，再执行查询等方法，重新从redis中获取数据。锁是需要按照key 维度去加锁。例如akey的锁不能影响其他key的查询。</p>
<h3 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h3><p>​    大量的key设置了相同的过期时间，导致在缓存在同一时刻全部失效，造成瞬时DB请求量大、压力骤增，引起雪崩。</p>
<p>​    解决方案：1）可以给缓存时间加上一个随机偏移量，例如一个小时的缓存时间，可以将这个时间再10分钟内随机，将失效时间平均到10分钟内。2）和上面的缓存击穿一样，加一个互斥锁，减少数据库的访问次数。3）设置热点数据永不过期，需要考虑数据的同步时间间隔和数据异常的处理情况。</p>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><p>​    访问一个一定不存在的key，缓存不起作用，请求会穿透到DB，流量大时DB会挂掉。因为查不到数据，所以后续的查询仍然会请求数据库。</p>
<p>​    解决方案有以下：1）如果是大量的不存在的key，可以认为是受到的攻击，可以在最外层做一层过滤。2）当数据库查询的结果为空时，可以将这个null结果做个缓存，设置一个较短的过期时间。当查询的key都是不存在的时候且不重复，这个作用也是比较小的。3）布隆过滤器。</p>
<h5 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h5><p>​    有一个bitset集合，还有一组hash算法，将一个key通过这组hash算法计算得到一组下标。将bitset中这组下标的位置设置为true，如果一个key通过这样的计算，得到的一组下标的位置不全为true，则这个key一定不存在，当都是true时，这个key可能存在。降低误判率也有方法：增大bitset集合的长度，增多hash算法，得到更多的下标。一般是增加长度，因为长度如果过短的话，增加hash算法其实意义不大。</p>
<h3 id="缓存一致性"><a href="#缓存一致性" class="headerlink" title="缓存一致性"></a>缓存一致性</h3><p>​    当数据时效性要求很高时，需要保证缓存中的数据与数据库中的保持一致，需要保证缓存节点和副本中的数据也保持一致，不能出现差异现象。</p>
<p>​    解决方法：更新数据库后，直接让缓存失效。</p>
<h3 id="面试中遇到的问题"><a href="#面试中遇到的问题" class="headerlink" title="面试中遇到的问题"></a>面试中遇到的问题</h3><ul>
<li>项目中什么地方用到redis，为什么使用redis？</li>
</ul>
<p>我们项目中redis的主要作用就是存储设备点位的信息，主要是存储设备当前状态的值，还有就是用户的token信息也是存储在redis中。当然，项目中还有一些其他的地方我没有涉及，可能这部分的信息也有存储在redis中的需求。因为项目是在我来公司之前成立的，所以技术的选型我并没有参与，对于选用redis并不知道当时出于什么考虑。我们redis使用的是单机服务，对于我们的项目来说可能够用了，但是并没有考虑到高可用，小公司对于技术的优化可能没有强烈的需求，我也是在私下会对这部分有个了解。我对于公司的redis优化的思路是采用哨兵模式进行高可用的优化。因为单机模式会存在宕机的可能，集群模式主要是为了应对单个服务器无法存储全部的数据的情况，所以我认为哨兵模式对于我们的项目来说比较适合。后面就介绍一下哨兵模式的一些特点和搭建中遇到的问题。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/Redis%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/" data-id="ckuqw9s960021xcup5ztkc1mr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-SpringCloud/SpringCloud基础了解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/SpringCloud/SpringCloud%E5%9F%BA%E7%A1%80%E4%BA%86%E8%A7%A3/" class="article-date">
  <time datetime="2021-10-14T10:09:31.648Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringCloud/">SpringCloud</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="SpringCloud基础了解"><a href="#SpringCloud基础了解" class="headerlink" title="SpringCloud基础了解"></a>SpringCloud基础了解</h2><h3 id="SpringCloud背景和基础知识"><a href="#SpringCloud背景和基础知识" class="headerlink" title="SpringCloud背景和基础知识"></a>SpringCloud背景和基础知识</h3><p>​    随着技术的慢慢发展，单一的应用很难满足目前用户的需求的。例如现在最简单的商场应用，用户下单后，需要创建订单服务，再创建库存服务、快递服务、如果有可能还会有会员积分服务。所以目前单一的应用去做这些事情很困难，能够完成，但是中间要花费大量的时间和精力去处理服务之间的协调和通信问题。SpringCloud就应用而生，和SpringBoot的产生一样，也是轻量级，让开发人员更加专注的开发业务代码，而不是和业务无关的代码。由此可见，这也是目前主流工具的开发方向。</p>
<p>​    想要了解SpringCloud需要先了解SpringBoot，因为都是Spring的全家桶，所以SpringCloud是基于SpringBoot的。关于SpringBoot的介绍这里就不再累述了，很多文档包括我也写了一些。其实在我看来，因为这些脚手架的原因，现在开发人员甚至不用关注底层原理，直接就可以开发。所以SpringBoot只要会大致写一个HelloWorld，就可以看关于SpringCloud的文档了。但是一旦底层出现一些问题，这些人又完全没有方法。短期看，Spring对于编程的发展有一定的好处，但是长远看，会使得编程人员往更高级的语言发展（但是Java本身就是高级语言啊）或者后来的编程人员越来越原理这里底层原理。无论哪种都不是很好的结果。（说多了，开始吧）</p>
<h3 id="SpringCloud的核心组件"><a href="#SpringCloud的核心组件" class="headerlink" title="SpringCloud的核心组件"></a>SpringCloud的核心组件</h3><ul>
<li><p>服务发现——Netflix Eureka。通过这个组件可以将服务注册到Eureka服务端中，服务端则将所有的服务的机器和端口号记录下来。当调用服务时，向注册中心查询注册表即可。</p>
</li>
<li><p>客服端负载均衡——Netflix Ribbon。这个组件是为了提供客户侧的软件负载均衡算法。Ribbon的负载均衡默认使用的最经典的<strong>Round Robin轮询算法</strong>。</p>
</li>
<li><p>HTTP客户端——OpenFeign。简化调用服务时的工作，将复杂的请求简化为配置，使用动态代理来构造出需要请求的服务地址，最后发起请求和解析请求。</p>
</li>
<li><p>断路器——Netflix Hystrix。为了避免雪崩现象，使用Hystrix来解决这个问题。Hystrix是隔离、熔断以及降级的一个框架。当某个服务挂掉后，Hystrix首先熔断，在一定时间后直接返回，但是不能直接返回，需要降级，把这个错误或者异常记录，在服务恢复后继续执行。</p>
</li>
<li><p>服务网关——Netflix Zuul。各个服务因为请求地址不同，前端做分离是不现实的，所以采用路由的形式，将前端的请求统一从路由过，再由路由转发给对应的服务。</p>
</li>
</ul>
<h3 id="记在后面的话"><a href="#记在后面的话" class="headerlink" title="记在后面的话"></a>记在后面的话</h3><p>​    其实把上面的看完就可以理解这些组件设计的目的了，总的来说，SpringCloud的组件虽然都是轻量级的，但是普通的应用拆分服务的很少，所以还是有一定体量的才会上微服务，所以保证这些服务和应用正常工作就显得格外重要，各个组件也是为了保证这一点。作为码农，了解各个模块和组件的作用非常重要，要比一个demo重要的多。后面我也会慢慢的搭建一个简单的SpringCloud框架。</p>
<p>​    就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/SpringCloud/SpringCloud%E5%9F%BA%E7%A1%80%E4%BA%86%E8%A7%A3/" data-id="ckuqw9s7s000zxcup33sqeed1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-SpringCloud/SpringCloud集成Eureka" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/14/SpringCloud/SpringCloud%E9%9B%86%E6%88%90Eureka/" class="article-date">
  <time datetime="2021-10-14T10:09:31.648Z" itemprop="datePublished">2021-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringCloud/">SpringCloud</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="SpringCloud集成Eureka"><a href="#SpringCloud集成Eureka" class="headerlink" title="SpringCloud集成Eureka"></a>SpringCloud集成Eureka</h2><p>​    下面就开始简单的写一个demo，先把组件慢慢都集成进来，先集成Eureka。</p>
<h3 id="创建父模块"><a href="#创建父模块" class="headerlink" title="创建父模块"></a>创建父模块</h3><p>​    父模块需要创建maven项目，这里没有找到基础的方法，就是不使用任何IDE去生成项目，所以最后无奈只能使用IDEA来生成这些项目。</p>
<p>​    首先选择maven，再输入自己项目的信息。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200602152019621.png" alt="image-20200602152019621"></p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200602141047248.png" alt="image-20200602141047248"></p>
<p>​    输入完成后，删除src目录，只保留一个pom文件，加入SpringBoot依赖即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="创建Eureka服务注册中心"><a href="#创建Eureka服务注册中心" class="headerlink" title="创建Eureka服务注册中心"></a>创建Eureka服务注册中心</h3><p>​    新建一个模块，根据spring的配置添加相应的依赖即可。这里需要注意一下。</p>
<p>​    我的IDE不知道抽什么风，一直连接不上springio，IDEA的代理配置能测试成功，但是到创建模块时死活不行，修改代理、用VPN、改地址为http，网上能找到的方法都试了，还是不行。最后放弃了，用的阿里云的spring镜像服务器。如下：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200602142009357.png" alt="image-20200602142009357"></p>
<p>​        中间有些步骤我给省略了，没有什么可讲的地方，下面就是选择依赖。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200602142110037.png" alt="image-20200602142110037"></p>
<p>​    后面就创建成功了，修改Eureka的配置即可。修改如下。</p>
<h4 id="pom文件"><a href="#pom文件" class="headerlink" title="pom文件"></a>pom文件</h4><p>​    pom文件需要修改父类依赖指向，指向刚才创建的父模块。EurekaServer依赖刚才创建模块的时候就已经导入了，不需要了。另外，看自己的需求导入健康检查依赖，这里我没有使用，就没有导入。pom文件全部代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.psq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ssodemo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.psq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>eureka<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>this is Eureka Server<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR4<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- eureka依赖       --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 健康检查依赖       --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="application-yml文件"><a href="#application-yml文件" class="headerlink" title="application.yml文件"></a>application.yml文件</h4><p>​    application.yml文件需要对项目做一个基础的配置，这里按照自己的需求配置就可以了。因为只是引入了Eureka，所以配置文件很少。另外，刚创建项目的时候是application.properties，命名为application.yml文件即可，要注意这两个文件虽然Spring都支持，但是这俩种文件的书写格式不一样。配置文件代码如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################################### common config : ####################################</span></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">eureka</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">8080</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">##eureka服务段配置</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">register-with-eureka</span>: <span class="string">false</span></span><br><span class="line">    <span class="meta">fetch-registry</span>: <span class="string">false</span></span><br><span class="line">    <span class="meta">service-url</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://127.0.0.1:8080/eureka</span></span><br><span class="line">  <span class="attr">server</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">renewal-percent-threshold</span>: <span class="string">0.49</span></span><br></pre></td></tr></table></figure>

<h4 id="启动类添加Eureka注解"><a href="#启动类添加Eureka注解" class="headerlink" title="启动类添加Eureka注解"></a>启动类添加Eureka注解</h4><p>​    启动类添加注解即可，添加一个<code>@EnableEurekaServer</code>注解，然后启动服务就可以了。</p>
<h4 id="启动结果及其验证方法"><a href="#启动结果及其验证方法" class="headerlink" title="启动结果及其验证方法"></a>启动结果及其验证方法</h4><p>​    启动单个模块，然后在浏览器输入<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a>，出现下面的页面就代表成功了。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/%E6%88%AA%E5%B1%8F2020-06-02%20%E4%B8%8B%E5%8D%882.59.01.png" alt="截屏2020-06-02 下午2.59.01"></p>
<h3 id="创建Eureka客户端"><a href="#创建Eureka客户端" class="headerlink" title="创建Eureka客户端"></a>创建Eureka客户端</h3><p>​    创建模块的步骤和上面一致，不过依赖和相应的配置需要修改一下。</p>
<h4 id="pom文件-1"><a href="#pom文件-1" class="headerlink" title="pom文件"></a>pom文件</h4><p>​    没有什么可以讲的地方。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.psq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ssodemo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.psq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>eureka-client<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>this is Eireka Client<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR4<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="application-yml配置文件"><a href="#application-yml配置文件" class="headerlink" title="application.yml配置文件"></a>application.yml配置文件</h4><p>​    唯一需要注意的地方就是端口号和注册中心的地址。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################################### common config : ####################################</span></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">eureka-client</span></span><br><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">8081</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">service-url</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://127.0.0.1:8080/eureka</span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">prefer-ip-address</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>

<h4 id="启动类注解"><a href="#启动类注解" class="headerlink" title="启动类注解"></a>启动类注解</h4><p>​    和注册中心的注解也不一样，需要修改一下。使用<code>@EnableDiscoveryClient</code>这个注解。</p>
<h4 id="启动监测"><a href="#启动监测" class="headerlink" title="启动监测"></a>启动监测</h4><p>​    需要注意的是，如果依赖中没有添加web依赖，项目就会启动一会就停掉了。因为没有添加web依赖的SpringBoot项目相当于一个java的demo，代码执行完毕就结束了。执行项目后，注册中心回出现已经注册的实例。如下图：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200602151510377.png" alt="image-20200602151510377"></p>
<p>​    这样就整合了一个Eureka，一个简单的demo，中间省略了很多的东西。只是简单的验证一下。就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/14/SpringCloud/SpringCloud%E9%9B%86%E6%88%90Eureka/" data-id="ckuqw9s7s0010xcup1ueyc7ty" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C%E5%AD%A6%E4%B9%A0/">C学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker%E5%AD%A6%E4%B9%A0/">Docker学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux%E5%AD%A6%E4%B9%A0/">Linux学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/netty/">netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/storm%E5%AD%A6%E4%B9%A0/">storm学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/">ElasticSearch</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/PostgreSQL/">PostgreSQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/">Redis</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%8F%E8%AE%AE/">协议</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%8F%E8%AE%AE/HTTP/">HTTP</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BF%83%E5%BE%97/">心得</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E9%A1%B9/">杂项</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A1%86%E6%9E%B6/Dubbo%E6%A1%86%E6%9E%B6/">Dubbo框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A1%86%E6%9E%B6/Spring%E7%9B%B8%E5%85%B3%E6%A1%86%E6%9E%B6/">Spring相关框架</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/ElasticSearch%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/elasticsearch%E6%90%AD%E5%BB%BA%E5%92%8Capi%E4%BD%BF%E7%94%A8/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/MySQL/MySQL%E4%BA%8B%E5%8A%A1%E4%BA%86%E8%A7%A3/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/MySQL/SQL%E8%AF%AD%E6%B3%95/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/PostgreSQL/Centos%E5%AE%89%E8%A3%85Postgresql%E5%92%8Cposogis%E6%8F%92%E4%BB%B6/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>