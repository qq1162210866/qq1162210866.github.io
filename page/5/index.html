<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-qq1162210866.github.io/博客/netty/Netty简单demo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/netty/Netty%E7%AE%80%E5%8D%95demo/" class="article-date">
  <time datetime="2021-10-13T13:28:21.195Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Netty简单demo"><a href="#Netty简单demo" class="headerlink" title="Netty简单demo"></a>Netty简单demo</h2><p>​    上篇博客简单介绍了Netty的一些基础概念和组件，这次就来写一个简单的demo，因为公司需要的是TCP服务端，所以这次的demo就写一个TCP服务端。下面就直接上代码。</p>
<p>​    首先是主类，里面也放着Netty的启动方法和执行流程。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> nettytrain;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TCPServerTrain.java</span></span><br><span class="line"><span class="comment"> * Description:  netty服务端的练习</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Peng Shiquan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPServerTrain</span> </span>&#123;</span><br><span class="line">    <span class="comment">//默认端口</span></span><br><span class="line">    <span class="keyword">private</span> Integer port = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TCPServerTrain</span><span class="params">(Integer port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 接收传入的连接</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="comment">//处理传入的连接，一般是bossGroup的二倍</span></span><br><span class="line">        EventLoopGroup workGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//服务端应用开发的入口</span></span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            <span class="comment">//设置主从线程池</span></span><br><span class="line">            serverBootstrap.group(bossGroup, workGroup)</span><br><span class="line">                    <span class="comment">//指定通道channel的类型，因为是服务端，所以是NioServerSocketChannel</span></span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    <span class="comment">//设置子通道也就是SocketChannel的处理器</span></span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> TCPServerHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                    <span class="comment">//配置ServerSocketChannel的选项</span></span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    <span class="comment">//配置子通道也就是SocketChannel的选项</span></span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//绑定并侦听某个端口</span></span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(port).sync();</span><br><span class="line">            <span class="comment">//如何没有客户端连接就会关闭Channel和两个线程池</span></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 关闭线程池</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            workGroup.shutdownGracefully();</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">10000</span>;</span><br><span class="line">        <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            port = Integer.parseInt(args[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> TCPServerTrain(port).run();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    代码里面的注释已经很清楚了，没有什么可以细讲的地方。下面的就是业务处理类，自己的业务处理主要放在这里。代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> nettytrain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.ReferenceCountUtil;</span><br><span class="line"><span class="keyword">import</span> network_train.ARPojo;</span><br><span class="line"><span class="keyword">import</span> network_train.ARSwitch;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TCPServerHandler.java</span></span><br><span class="line"><span class="comment"> * Description: 主要的业务处理类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Peng Shiquan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 通道的读取操作方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/6/19</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ByteBuf recvmg = (ByteBuf) msg;</span><br><span class="line">            String line = recvmg.toString(CharsetUtil.UTF_8);</span><br><span class="line">            System.err.println(<span class="string">&quot;接收到消息&quot;</span> + line);</span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;BG&quot;</span>) &amp;&amp; line.contains(<span class="string">&quot;ED&quot;</span>)) &#123;</span><br><span class="line">                ARPojo arPojo = ARSwitch.LineSwitch(line);</span><br><span class="line">                System.err.println(<span class="string">&quot;转换为pojo对象&quot;</span> + arPojo.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 释放msg</span></span><br><span class="line">            ReferenceCountUtil.release(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description:  异常捕获</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/6/19</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    也是没有什么可以讲的地方，这里的业务处理我放在其他的地方了，所以这里的代码很少，每个人的业务不同，所以业务处理也不同。</p>
<p>​    下面就说说遇到的问题。就是通道读取的方法，刚开始不知道怎么处理msg，后来转换成<code>ByteBuf</code>,再转换的<code>String</code>，这个地方不知道处理的对不对。其他的问题就是这个代码没有考虑到粘包的现象，现在还没有涉及到，所以没有写，后面慢慢补上。</p>
<p>​    就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/netty/Netty%E7%AE%80%E5%8D%95demo/" data-id="ckupl1rr8001a6rup2bmn1ozs" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qq1162210866.github.io/博客/netty/Netty编写客户端" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/netty/Netty%E7%BC%96%E5%86%99%E5%AE%A2%E6%88%B7%E7%AB%AF/" class="article-date">
  <time datetime="2021-10-13T13:28:21.195Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Netty编写客户端"><a href="#Netty编写客户端" class="headerlink" title="Netty编写客户端"></a>Netty编写客户端</h2><p>​    上一篇博客讲了一下解码器，但是其实没有涉及到客户端的编写，今天补上这篇博客。同时深入了解一下Netty（对于我来说）。加深自己的印象。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20201208205126779.png" alt="image-20201208205126779"></p>
<p>​    上面是一个简单的服务端的例子，之前的博客也讲过这个demo，下面按照自己最新的理解再次记录一下。首先是最开始创建两个线程组，boss线程组用来监听客户端的连接，只做到这一步，work线程组相当于干活的，当通道中有IO事件时就开始工作。这样做的好处就是可以提升读写性能。这一块的内容涉及到Netty的线程模型，这一块我不是很熟悉，找到一篇文章，大家可以了解一下，感兴趣的可以继续搜索一下：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87630368">Netty线程模型</a>，以后也会慢慢补上这些内容的，学习无涯。回到代码上，然后就是创建了一个<code>ServerBootstrap</code>，这个启动类的作用就是辅助与编写服务端，降低开发的复杂度。再然后就是设置线程组、设置<code>Channel</code>、配置TCP的参数，编写Netty之前最好还是有点NIO的编写经验，不要像我上来就开始，一点准备工作都没有做，读代码都很吃力。最后的两行代码含义就比较容易懂了，调用辅助类的<code>bind()</code>方法绑定监听某个端口，同时调用同步阻塞方法等待绑定操作完成。最后一行则是等待服务端链路关闭后，退出主方法。</p>
<p>​    说了这么多，其实和客户端的编写一点关系都没有，主要还是记录一下Netty启动的流程，对于Netty原理和底层的一些操作，这个需要等我看完NIO再记录一下。下面就讲一下Netty编写客户端的思路。</p>
<p>​    客户端不需要两个线程组，一个就够了，通道也和服务端不太一样，需要设置为<code>NioSocketChannel</code>,剩下就是设置TCP的参数和handler的设置。发起连接和服务端也不太一样，服务端是监听，客户端就是连接，调用<code>connect()</code>方法发起异步连接，然后再调用同步方法等待连接成功。最后就是连接关闭后释放线程组的资源。代码也比较简单，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置客户端的线程组，客户端只有一个线程组</span></span><br><span class="line">EventLoopGroup eventLoopGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">    bootstrap.group(eventLoopGroup).channel(NioSocketChannel.class)</span><br><span class="line">            .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">            .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="comment">//放入自己的业务Handler</span></span><br><span class="line">                    socketChannel.pipeline().addLast(<span class="keyword">new</span> TCPClientHandler());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="comment">//发起异步连接操作，同步阻等待结果</span></span><br><span class="line">    ChannelFuture channelFuture = bootstrap.connect(host, port).sync();</span><br><span class="line">    <span class="comment">//等待客户端链路关闭</span></span><br><span class="line">    channelFuture.channel().closeFuture().sync();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//释放NIO线程组</span></span><br><span class="line">    eventLoopGroup.shutdownGracefully();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    不要以为到这里就结束了，上面这个只是一个简单的demo，自己写着玩还可以，但是到了生产环境或者实际用的时候，很多东西没有考虑到。断线重连问题、线程管理的问题、连接多服务端的情况。这些问题是我开发时遇到的问题，下面就一一讲一下实现的逻辑，最后则给出整体的代码。</p>
<ul>
<li>断线重连。断线重连一般时客户端要做的事情，也分为两种情况，一开始连接不上和连接上过一段时间断了。这两种情况需要不同处理，一开始连接不上需要添加监听器，异步执行，失败就调用两秒重连。断线则需要再handler中的<code>channelInactive()</code>方法做相应的业务处理。</li>
<li>线程管理和连接多服务端的问题其实是一个场景。就是需要连接多个服务端的情况下，一个连接创建一个线程显然是不太合理的，同时也要对这些线程进行管理。这里暂时的办法是单独启动一个线程，线程的<code>run()</code>方法就是启动netty连接。后续在这个线程里面去完成多个客户端的建立或者一个netty线程去连接多个服务端。目前水平有限，只能想到这个地步。涉及到线程和NIO还有Netty。后续慢慢完善吧。</li>
</ul>
<p>​    所以最后的代码就如下：因为一些原因，没有给出全部的代码，给出了部分核心的代码，其他的细节和本次的内容关系不大。也可以按照自己的需求进行修改。（最好按照自己的想法修改一下，每个人的需求都不太一样，我的代码一定不合适所有人）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectThread</span> <span class="keyword">extends</span> <span class="title">ConnectThread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(ConnectThread.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Bootstrap bootstrap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EventLoopGroup eventLoopGroup;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AtomicBoolean running = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        beginConnect();</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                shutDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//阻塞住</span></span><br><span class="line">        <span class="keyword">while</span> (running.get()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">200l</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;程序运行发生错误&quot;</span>);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                shutDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginConnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            eventLoopGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">            bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            assembleBootStrap();</span><br><span class="line">            reConnect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;客户端连接发送错误&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            shutDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 组装BootStrap</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/12/9</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">assembleBootStrap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConnectThread ConnectThread = <span class="keyword">this</span>;</span><br><span class="line">        bootstrap.group(eventLoopGroup).channel(NioSocketChannel.class);</span><br><span class="line">        bootstrap.remoteAddress(host, port);</span><br><span class="line">        bootstrap.option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>);</span><br><span class="line">        bootstrap.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, <span class="number">6000</span>);</span><br><span class="line">        bootstrap.option(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</span><br><span class="line">        bootstrap.handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> </span>&#123;</span><br><span class="line">                socketChannel.pipeline().addFirst(<span class="keyword">new</span> IdleStateHandler(<span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">                        .addLast(<span class="keyword">new</span> Decoder())</span><br><span class="line">                        .addLast(<span class="keyword">new</span> Handler(ConnectThread));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reConnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.reConnect();</span><br><span class="line">        logger.info(<span class="string">&quot;雷达开始重试，雷达信息为：&#123;&#125;:&#123;&#125;&quot;</span>, host, port);</span><br><span class="line">        bootstrap.connect(host, port).addListener(<span class="keyword">new</span> ConnectListener(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        running.set(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (closeChannel != <span class="keyword">null</span> &amp;&amp; closeChannel.isActive()) &#123;</span><br><span class="line">            closeChannel.close().awaitUninterruptibly();</span><br><span class="line">            closeChannel = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bootstrap = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (eventLoopGroup != <span class="keyword">null</span>) &#123;</span><br><span class="line">            eventLoopGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">        eventLoopGroup = <span class="keyword">null</span>;</span><br><span class="line">        logger.error(<span class="string">&quot;客户端关闭连接，雷达服务端信息为：&#123;&#125; : &#123;&#125;&quot;</span>, host, port);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    来讲一下上面的代码大致的思路。连接类继承了线程，重写了<code>run()</code>方法，run方法里面只有三个部分的代码，一个是启动连接，一个是程序运行中有异常执行关闭方法，释放资源。最后一个就是将线程阻塞住，因为启动连接是异步的，如果不阻塞，代码直接就执行完毕了，后续也没法进行重连的操作。启动连接方法里面只有两步，一个是组装BootStrap启动类，另外一个就是执行重连操作，之前说过，断线重连发生在两个地方，最开始没有连接上和中间断掉，所以这里直接掉同一个方法，不用再重复写方法了。组装启动类按照自己的需求组装就可以了，设置超时事件、设置长时间无数据返回、设置解码器，业务处理类。重连方法就是调用启动类的<code>connect()</code>方法，这里和上面的demo有一点不一样，这里是异步返回的，没有阻塞住，添加了一个监听器，也是为了做重连用的。如果和demo一样的话，这里发生断连，程序就直接关闭了，就没法重连了。想要重连必须重新创建线程组、启动类、通道等，这个显然不是我们想看到了，因为断连后，线程组和和启动类还是可以继续使用的，只不过要换一个连接。</p>
<p>​    下面就继续附上监听器和handler的代码。（handler中有一部分断线重连的方法）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectListener</span> <span class="keyword">implements</span> <span class="title">ChannelFutureListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(ConnectListener.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectThread ConnectThread;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConnectListener</span><span class="params">(ConnectThread ConnectThread)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ConnectThread = ConnectThread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;[&quot;</span> + ConnectThread.getHost() + <span class="string">&quot;:&quot;</span> + ConnectThread.getPort() + <span class="string">&quot;] 启动成功!!!&quot;</span>);</span><br><span class="line">            ConnectThread.setTime(<span class="number">0</span>);</span><br><span class="line">            ConnectThread.setCloseChannel(future.channel());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ConnectThread.getTime() &gt;= <span class="number">1800</span>) &#123;</span><br><span class="line">                logger.error(ConnectThread.getHost() + <span class="string">&quot;:&quot;</span> + ConnectThread.getPort() + <span class="string">&quot;重试超过一小时，不再重试&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.warn(<span class="string">&quot;[&quot;</span> + ConnectThread.getHost() + <span class="string">&quot;:&quot;</span> + ConnectThread.getPort() + <span class="string">&quot;]Channel失联，2秒后重连。。。 &quot;</span>);</span><br><span class="line">            future.channel().eventLoop().schedule(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    ConnectThread.reConnect();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">2l</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    监听器的代码就是判断是否连接上，没有的话进行重试，连接上了就重置次数，同时返回通道信息，为后面关闭通道做准备。剩下句没有什么可以说的了。最好就是handler的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XYDHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(XYDHandler.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> XYDConnectThread xydConnectThread;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XYDHandler</span><span class="params">(XYDConnectThread xydConnectThread)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.xydConnectThread = xydConnectThread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;连接断开，IP端口为：&#123;&#125;&quot;</span>, ctx.channel().remoteAddress());</span><br><span class="line">        ctx.channel().eventLoop().schedule(() -&gt; &#123;</span><br><span class="line">            xydConnectThread.reConnect();</span><br><span class="line">        &#125;, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ByteBuf byteBuf = Unpooled.copiedBuffer((<span class="keyword">byte</span>[]) msg);</span><br><span class="line">        logger.info(<span class="string">&quot;接收到消息为：&#123;&#125;&quot;</span>, ByteBufUtil.hexDump(byteBuf));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    重连的方法就是<code>channelInactive()</code>，和监听器里的代码也是差不多。剩下就没有什么可以说的了。</p>
<p>​    上面的代码就是完成一个断线重连的Netty的客户端，代码直接粘贴是不能用的，需要进行一些修改，我现在也比较烦直接将代码粘贴过来，上来就开始测试。还是要了解一下具体如何实现的，要不然改代码都不知道如何修改。就像这次编写客户端，最开始写很吃力，因为之前是一知半解，不知道如何修改，不知道如何排查，所以走了很多的弯路，代码完全不能看，也不起用。现在了解了一些后，慢慢能够按照自己的想法将代码改造成自己想要的样子，我觉得这样才算一个东西你彻底掌握了，与君共勉。</p>
<p>​    就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/netty/Netty%E7%BC%96%E5%86%99%E5%AE%A2%E6%88%B7%E7%AB%AF/" data-id="ckupl1rr9001b6rup9b1i2szk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qq1162210866.github.io/博客/netty/Netty解码器使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/netty/Netty%E8%A7%A3%E7%A0%81%E5%99%A8%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2021-10-13T13:28:21.195Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Netty解码器了解和使用"><a href="#Netty解码器了解和使用" class="headerlink" title="Netty解码器了解和使用"></a>Netty解码器了解和使用</h2><p>​    距离上次了解Netty已经过去半年了，最近需要编写一个客户端去连接一个设备，发现Netty编写客户端比服务端复杂一点，回头看自己写的服务端的博客，发现当时的了解也是一知半解，整片博客达不到我想象中的要求。现在才发现写博客原来还是有一些技术含量的。我也没有修改写完的博客的习惯。就当成自己的黑历史吧，但是后续自己还是要记录的。中间发现一片博客对于Netty的入门的一些概念讲的比较清楚，这里也放上来。<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/insjE_EJRoCOM-1GqgZP9A">Netty架构与原理</a></p>
<p>​    也就不多说废话了，这边博客讲的是解码器的使用，关于客户端的讲解和代码放到后面一片博客上。下面就直接开始。</p>
<p>​    编码器和解码器其实是一个概念，上一篇博客讲过Netty中的几个重要的组件，其中编解码器在最下面。解码器意如其名，就是对于网络上接收的字节进行解码，将字节转换为相应的java对象，再传给业务处理类，同时对于TCP中的粘包和拆包现象在解码器中处理也是比较方便的。关于粘包问题的解释和做法可以看官网的解释<a target="_blank" rel="noopener" href="https://netty.io/wiki/user-guide-for-4.x.html#dealing-with-a-stream-based-transport">官网对于粘包的解释和处理</a>。最开始我的本意也是处理粘包的现象，同时对收到的数据做校验。所以就查询了一下相关的资料。编码器则是发送数据时将java对象转换为字节数据，再通过网络发送出去，和解码器类似，只不过用的地方不一样。我的代码不涉及发送数据，所以本次博客不再记录编码器，估计使用方法和解码器类似，可能就是方法不一样。</p>
<p>​    Netty想到了粘包和拆包的问题，所以有几种自带的解码器，可以直接使用。LineBasedFrameDecoder（基于特殊分隔符的解码器，例如<code>\r\n</code>）、DelimiterBasedFrameDecoder（更加通用的分隔符解码器，支持多个特殊分隔符）、FixedLengthFrameDecoder（固定长度的解码器）、LengthFieldBasedFrameDecoder（可以按照长度字段动态的解码器，比较符合我们的要求了）。基本常用的解码器就这几种了，最后一个比较符合我们的需求，但是因为后续可能会发生变化，同时，我也想在解码器里面对数据做校验，所以这里打算自己编写解码器。</p>
<p>​    自定义解码器只需要让类继承ByteToMessageDecoder，然后重写自己的方法就可以了。这里我记得Netty有几种解码器，分别解析int short和二进制，但是忘记到底是什么了，欢迎大家补充。</p>
<p>​    继承ByteToMessageDecoder后，只需要重写<code>decode()</code>方法就可以完成解码的工作，这里简单列举一下自己的代码，因为大部分都涉及到业务处理，这部分和解码器无关，不再记录。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 先处理粘包的问题，再对所有数据和数据模块做校验</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx ChannelHandler 和ChannelPipeline 之间的关联</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in 输入的Buf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out 输出的Buf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/11/30</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      	<span class="comment">//获取buf中写指针的位置，相当于buf中能读的数据的长度</span></span><br><span class="line">        <span class="keyword">int</span> bufferLength = in.writerIndex();</span><br><span class="line">      	<span class="comment">//获取指定帧头的位置</span></span><br><span class="line">        <span class="keyword">int</span> headIndex = ByteBufUtil.indexOf(RadarMessageUtil.HEAD_BUF, in);</span><br><span class="line">        <span class="keyword">int</span> surplusLength = RadarMessageUtil.HEAD_LENGTH + RadarMessageUtil.SUM_LENGTH + RadarMessageUtil.CALIBRATE_LENGTH;</span><br><span class="line">      	<span class="comment">//获取当前数据最短的长度，帧头+数据长度位+数据+校验位</span></span><br><span class="line">        <span class="keyword">int</span> shortData = in.getUnsignedShort(headIndex + RadarMessageUtil.HEAD_LENGTH) + surplusLength;</span><br><span class="line">        <span class="keyword">if</span> (headIndex &gt;= <span class="number">0</span> &amp;&amp; bufferLength &gt;= shortData) &#123;</span><br><span class="line">            <span class="keyword">int</span> dataLength = shortData - surplusLength;</span><br><span class="line">            <span class="keyword">byte</span>[] rs = <span class="keyword">new</span> <span class="keyword">byte</span>[dataLength];</span><br><span class="line">            in.getBytes(headIndex + RadarMessageUtil.HEAD_LENGTH + RadarMessageUtil.SUM_LENGTH, rs);</span><br><span class="line">            <span class="keyword">if</span> (compareBytes(rs)) &#123;</span><br><span class="line">              	<span class="comment">//添加该buf到输出中，这里也可以将buf再次转换为java对象</span></span><br><span class="line">                out.add(rs);</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">//将读写指针复位</span></span><br><span class="line">            in.readerIndex(headIndex + RadarMessageUtil.HEAD_LENGTH + RadarMessageUtil.SUM_LENGTH + dataLength + RadarMessageUtil.CALIBRATE_LENGTH);</span><br><span class="line">            in.discardReadBytes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;接收的数据不满足最小长度或者不包含帧头&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    代码就是上面的代码，不是很复杂。简单说一下思路。先是获取整个缓冲区的数据长度，再判断帧头的位置，将帧头后两位的数据解析为数据长度，判断缓存区整个数据长度是不是大于这个长度，如果大于就代表这个包全了，可以解析，将这个buf转换成字节数组再放到out里面（不是必须转换为字节数组）。如果小于则代表缓冲区内数据不全，需要继续等待缓冲区内数据补充，直接返回就可以。如果正常读取后，最后需要将buf中的指针操作都复位，要不然buf的大小会越来越小。</p>
<p>​    以上就是一个解决特定帧头，动态长度的解码器。当然，这个解码器还可以做的更多，例如对数据做校验，这里也就不再展开了。运行效果和网上其他的类似，能够解决相应的粘包问题。使用也比较简单，在添加业务处理类前添加解码器即可。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">       RadarConnectThread radarConnectThread = <span class="keyword">this</span>;</span><br><span class="line">       b.group(eventLoopGroup).channel(NioSocketChannel.class)</span><br><span class="line">               .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">               .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, <span class="number">6000</span>)</span><br><span class="line">               .option(ChannelOption.SO_KEEPALIVE, <span class="keyword">false</span>)</span><br><span class="line">               .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> </span>&#123;</span><br><span class="line">                       socketChannel.pipeline().addLast(<span class="keyword">new</span> RadarDecoder()).addLast(<span class="keyword">new</span> RadarHandler(radarConnectThread));</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> b;</span><br></pre></td></tr></table></figure>

<p>​    中间还是有一些点讲的不是很清楚，后续还会补充一片Netty客户端的博客，这篇博客更加全面的记录，同时修正之前博客的错误（又是一个坑）。</p>
<p>​    那就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/netty/Netty%E8%A7%A3%E7%A0%81%E5%99%A8%E4%BD%BF%E7%94%A8/" data-id="ckupl1rra001c6rup3n7ohadf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qq1162210866.github.io/博客/storm学习/Storm初步使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/storm%E5%AD%A6%E4%B9%A0/Storm%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2021-10-13T13:28:21.195Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Storm初步使用"><a href="#Storm初步使用" class="headerlink" title="Storm初步使用"></a>Storm初步使用</h2><p>​    上一篇博客简单的介绍了Strom的一个Demo，但是没有介绍使用中的细节，这篇博客就来介绍一下上次遗漏的细节。算是一个进阶的学习吧。开始。</p>
<h3 id="Strom分组策略"><a href="#Strom分组策略" class="headerlink" title="Strom分组策略"></a>Strom分组策略</h3><ul>
<li><strong>Shuffle grouping</strong>: 随机分组，Tuples以一定方式随机分布在blot的task上，从而确保每个blot都具有相等数量的tuples。</li>
<li><strong>Fields grouping</strong>: 字段分组，stream按fields中指定的字段进行分组。例如，如果stream按照“ user-id”字段分组，则具有相同“ user-id”的Tuples将始终分到相同的task，但是具有不同“ user-id”的元组可能会到不同的task。</li>
<li><strong>Partial Key grouping</strong>: 部分密钥分组，stream按照指定的字段进行分组（如同上面的字段分组策略），但在两个下游blot之间进行负载平衡，当输入数据倾斜时，可以更好地利用资源。官方文档对它的工作原理和优点提供了很好的解释。地址如下：<a target="_blank" rel="noopener" href="https://melmeric.files.wordpress.com/2014/11/the-power-of-both-choices-practical-load-balancing-for-distributed-stream-processing-engines.pdf">官网</a></li>
<li><strong>All grouping</strong>: 所有分组，stream在blot的所有task之间复制。请谨慎使用此分组策略。</li>
<li><strong>Global grouping</strong>: 全局分组，整个stream进入blot的task的其中一项。具体来说，它将转到ID最低的task上。</li>
<li><strong>None grouping</strong>:无分组，此分组指定您不关心stream的分组方式。没有分组策略等效于随机分组策略。不过，最终Storm会向下推没有分组的blot，最后让其订阅的blot或spout在同一线程中执行（如果可能）。（翻译就是这样，感觉还是不清楚细节，但是类似于随机分组）</li>
<li><strong>Direct grouping</strong>:直接分组，这是一种特殊的分组。以这种方式分组意味着Tuples的<strong>生产者</strong>决定消费者的哪个task将接收此Tuples。直接分组只能在已经声明为直接流的流上声明。直接流发出的元组必须使用<code>emitDirect</code>方法之一发出。blot可以使用提供的<code>TopologyContext</code>或通过<code>emit</code>在<code>OutputCollector</code>中跟踪方法的输出（返回处理Tuples的task的ID）来获取其使用者的任务ID。</li>
<li><strong>Local or shuffle grouping</strong>: 本地或随机分组，如果目标blot在同一工作进程中具有一个或多个任务，则元组将被随机转换为那些正在进行的任务。否则，这就像常规的随机分组。</li>
</ul>
<p>​    讲完了上面的八种分组策略，下面就来看看之前的demo中是如何使用的。</p>
<p>​    <code>fieldsGrouping(&quot;ExampleSpout&quot;, new Fields(&quot;word&quot;));</code>这段代码表示的是从实体<code>ExampleSpout</code>出来的ID为<code>default</code>的流按照字段分组，字段<code>word</code>内容相同的<code>tuple</code>将会交给相同的<code>task</code>处理。如下图：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200904174302403.png" alt="image-20200904174302403"></p>
<p>​    在blot中声明出去的流时，一个blot可能会发送出多个格式的流。同时，也可以指定流的ID，方便下游的多个blot接收。如下图：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200904174842732.png" alt="image-20200904174842732"></p>
<h2 id="Storm中并行度理解"><a href="#Storm中并行度理解" class="headerlink" title="Storm中并行度理解"></a>Storm中并行度理解</h2><p>​    Storm中有一个并行度的概念，在设置blot的时候也可以设置这个东西，下面就来说说这个概念和它牵扯的一下东西。</p>
<p>​    了解并行度需要先了解Strom的三个实体的概念。</p>
<ul>
<li>Worker processes。一个工作进程执行拓扑的一个子集。辅助进程属于特定的拓扑，并且可以为该拓扑的一个或多个组件（blot或spout）运行一个或多个执行程序。正在运行的拓扑就是由在Storm集群中，许多计算机上运行的许多此类进程组成。</li>
<li>Executors (threads)。一个执行者是由一个工作进程催生了的一个线程。它可以为同一组件（blot或spout）运行一项或多项任务。</li>
<li>Tasks。一个任务是执行实际的数据处理的最小单元。您在代码中实现的每个spout或blot在整个集群中执行的任务数量一样多。在拓扑的整个生命周期中，组件的任务数量始终是相同的，但是组件的执行程序（线程）的数量会随着时间而变化。这意味着以下条件成立：threads ≤ tasks。默认情况下，任务数设置为与执行程序数相同，即Storm将在每个线程中运行一个任务。</li>
</ul>
<p>​    他们的关系如下图：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200906234133843.png" alt="image-20200906234133843"></p>
<p>​    详细的解析也可以看这个博客：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ae619304d881">https://www.jianshu.com/p/ae619304d881</a>这个博客将的比较细，同时还有一些自己想法后的测试。</p>
<p>​    当然，也可以看官网上的解析，这些都是从官网了解到的，官网地址如下：<a target="_blank" rel="noopener" href="http://storm.apache.org/releases/2.2.0/Understanding-the-parallelism-of-a-Storm-topology.html">http://storm.apache.org/releases/2.2.0/Understanding-the-parallelism-of-a-Storm-topology.html</a>。</p>
<p>​    了解了这些基础概念，就需要引入一个demo，开始了解并行度。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Config conf = <span class="keyword">new</span> Config();</span><br><span class="line">conf.setNumWorkers(<span class="number">2</span>); <span class="comment">// use two worker processes</span></span><br><span class="line"></span><br><span class="line">topologyBuilder.setSpout(<span class="string">&quot;blue-spout&quot;</span>, <span class="keyword">new</span> BlueSpout(), <span class="number">2</span>); <span class="comment">// set parallelism hint to 2</span></span><br><span class="line"></span><br><span class="line">topologyBuilder.setBolt(<span class="string">&quot;green-bolt&quot;</span>, <span class="keyword">new</span> GreenBolt(), <span class="number">2</span>)</span><br><span class="line">               .setNumTasks(<span class="number">4</span>)</span><br><span class="line">               .shuffleGrouping(<span class="string">&quot;blue-spout&quot;</span>);</span><br><span class="line"></span><br><span class="line">topologyBuilder.setBolt(<span class="string">&quot;yellow-bolt&quot;</span>, <span class="keyword">new</span> YellowBolt(), <span class="number">6</span>)</span><br><span class="line">               .shuffleGrouping(<span class="string">&quot;green-bolt&quot;</span>);</span><br><span class="line"></span><br><span class="line">StormSubmitter.submitTopology(</span><br><span class="line">        <span class="string">&quot;mytopology&quot;</span>,</span><br><span class="line">        conf,</span><br><span class="line">        topologyBuilder.createTopology()</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<p>​    代码很好理解，spout和第一个blot的parallelism hint为2，最后的blot则为6。则得出这段程序总的并行度为：（2+2+6）/2=5至于原因上面的博客和官网也有解释。下面的图也是讲解：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200907000012034.png" alt="image-20200907000012034"></p>
<p>​    因为config设置了两个worker，但是总的线程有10个，相除即得并行度为5。但是这里还是不清楚并行度为5的意义和参考价值。可能是一个worker里面有多少executor吧。</p>
<p>​    后续公司也会把Strom的框架换掉，后续很有可能不再更新Strom的博客了。没有深入了解很是遗憾，但是人生不就是这样吧，终会有点不完美。事在人为有时就是说说而已，很多事我们没法决定和左右，只能尽自己最大的努力。</p>
<p>​    就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/storm%E5%AD%A6%E4%B9%A0/Storm%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8/" data-id="ckupl1rra001d6rupcfz23w3d" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qq1162210866.github.io/博客/storm学习/Storm基础了解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/storm%E5%AD%A6%E4%B9%A0/Storm%E5%9F%BA%E7%A1%80%E4%BA%86%E8%A7%A3/" class="article-date">
  <time datetime="2021-10-13T13:28:21.195Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Storm基础概念了解"><a href="#Storm基础概念了解" class="headerlink" title="Storm基础概念了解"></a>Storm基础概念了解</h2><p>​    最近公司需要学习Storm，所以就来了解一下。本次的博客也是了解一下基础的概念，不涉及代码和其他的东西。大部分的东西都是来自于官网。</p>
<p>​    Apache Storm是一个免费的开源分布式实时计算系统。通过Apache Storm，可以轻松可靠地处理无限制的数据流，从而可以进行实时处理，而Hadoop可以进行批处理。Apache Storm很简单，可以与任何编程语言一起使用，并且使用起来很有趣！</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200706150422939.png" alt="image-20200706150422939"></p>
<h3 id="Storm中的基础概念"><a href="#Storm中的基础概念" class="headerlink" title="Storm中的基础概念"></a>Storm中的基础概念</h3><ul>
<li>Topologies（拓扑）。实时应用程序的逻辑被封装在 Storm topology（拓扑）中. Storm topology（拓扑）类似于 MapReduce 作业.两者之间关键的区别是 MapReduce 作业最终会完成, 而 topology（拓扑）任务会永远运行（除非 kill 掉它）. 一个拓扑是 Spout 和 Bolt 通过 stream groupings 连接起来的有向无环图.</li>
<li>Streams（流）。stream 是 Storm 中的核心概念.一个 stream 是一个无界的、以分布式方式并行创建和处理的 Tuple 序列. stream 以一个 schema 来定义, 这个 schema 用来命名 stream tuple（元组）中的字段.默认情况下 Tuple 可以包含 integers, longs, shorts, bytes, strings, doubles, floats, booleans, and byte arrays 等数据类型.你也可以定义自己的 serializers, 以至于可以在 Tuple 中使用自定义的类型.</li>
<li>Spouts。Spout 是一个 topology（拓扑）中 streams 的源头. 通常 Spout 会从外部数据源读取 Tuple，然后把他们发送到拓扑中.</li>
<li>Bolts。拓扑中所有的业务处理都在 Bolts 中完成. Bolt 可以做很多事情，过滤, 函数, 聚合, 关联, 与数据库交互等.</li>
<li>Stream groupings。topology（拓扑）定义中有一部分是为每一个 bolt 指定输入的 streams . stream grouping 定义了stream 如何在 Bolts tasks 之间分区.相当于将流分组，内置有八个.</li>
<li>Tasks。每个 Spout 或者 Bolt 都以跨集群的多个 Task 方式执行. 每个 Task 对应一个 execution 的线程.</li>
<li>Workers。Topologies （拓扑）在一个或者跨多个 worker 执行. 每个 Worker 进程是一个物理的 JVM.</li>
</ul>
<p>​    上面的信息都是来自于官网，官网地址为：<a target="_blank" rel="noopener" href="http://storm.apache.org/">http://Storm.apache.org</a>。</p>
<p>​    介绍完了一些基础概念，下面就说说具体的流程，把这些概念串起来。</p>
<p>​    Storm集群上有两种节点：主节点和工作节点。主节点运行一个名为“ Nimbus”的守护程序，该守护程序类似于Hadoop的“ JobTracker”。Nimbus负责在集群中分发代码，向计算机分配任务以及监视故障。</p>
<p>​    每个工作程序节点都运行一个称为“ Supervisor”的守护程序。主管侦听分配给它的机器的工作，并根据Nimbus分配给它的东西启动和停止必要的工作程序。每个工作进程执行一个拓扑子集；一个正在运行的拓扑由分布在许多计算机上的许多工作进程组成。</p>
<p>​    Nimbus和主管之间的所有协调都是通过Zookeeper集群完成的。此外，Nimbus守护程序和Supervisor守护程序是快速故障且无状态的。所有状态都保存在Zookeeper或本地磁盘中。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200706221725445.png" alt="image-20200706221725445"></p>
<p>​    Spout是streams的源头。例如，Spout可能会从Kestrel队列中读取元组并将其作为流发出。否则，Spout可能会连接到Twitter API并发出一系列推文。</p>
<p>​    Bolts消耗任何数量的输入流，进行一些处理，并可能发出新的流。复杂的流转换（例如从一条推文流中计算趋势主题流）需要多个步骤，因此需要多个Bolts。Bolts可以执行任何功能，包括运行功能，过滤元组，进行流聚合，进行流联接，与数据库对话等等。</p>
<p>Spout和Bolts网络打包成一个“拓扑”，这是您提交给Storm集群以执行的顶级抽象。拓扑是流转换的图形，其中每个节点都是Spout或Bolts。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200706221938945.png" alt="image-20200706221938945"></p>
<p>​    需要注意：Storm拓扑中的每个节点都并行执行。在拓扑中，您可以为每个节点指定所需的并行度，然后Storm将在整个集群中产生该数量的线程来执行。</p>
<p>​    拓扑将永远运行，或者直到您将其杀死为止。Storm将自动重新分配所有失败的任务。此外，Storm保证即使机器宕机和消息丢失也不会丢失数据。</p>
<p>​    剩下的就是具体编写代码去验证和深入了解了，说实话，看这些枯燥的概念很容易犯困，所以我的意见还是找一个demo，边写代码边理解，这样比较容易理解，同时也会有一个类似于奖励的机制，才能学的更快。</p>
<p>​    下一遍就要来写代码了。    </p>
<p>​    就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/storm%E5%AD%A6%E4%B9%A0/Storm%E5%9F%BA%E7%A1%80%E4%BA%86%E8%A7%A3/" data-id="ckupl1rra001e6rup7w5zcbuk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qq1162210866.github.io/博客/storm学习/Storm简单demo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/storm%E5%AD%A6%E4%B9%A0/Storm%E7%AE%80%E5%8D%95demo/" class="article-date">
  <time datetime="2021-10-13T13:28:21.195Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Storm简单demo"><a href="#Storm简单demo" class="headerlink" title="Storm简单demo"></a>Storm简单demo</h2><p>​    上一篇介绍了Storm的基础概念，下面就来实际写个demo。</p>
<p>​    因为是开发，所以基础的配置还是没有做，就是说是在本地跑的，没有集群之类的。</p>
<p>​    先整合一个基础的架子，使用的是SpringBoot的框架，但是移除了基础依赖，添加了Storm的依赖。上代码    前还是需要先解释一下一些基础的概念。然后再上代码。</p>
<p>​    Storm中使用tuple来作为数据元，相当于一个一个水滴，很多水滴汇集成流。每个tuple是一堆值，每个值有一个名字，并且每个值可以是任何类型。tuple中有两个概念，Values和Fields。tuple也是由这两个组成。</p>
<ul>
<li><p>Values类直接继承自Java中的ArrayList类，因为ArrayList类恰好能够很好地满足描述“一行”值的需要——有序、不去重、可伸缩。</p>
</li>
<li><p>Fields是为了定义Values的名字。在使用Values描述了一行值的概念之后，接下来如何知道这行值当中每一列值代表的含义，也就是要知道字段声明，就是Fields。</p>
</li>
</ul>
<p>​    知道这些概念后，剩下的就是代码的流程了。</p>
<p>​    代码首先新建一个拓扑，然后往拓扑中放入数据源Spout，在依次放入处理单元Bolt，根据需要对这些组件进行设置，比如数据的分组策略和线程的个数等等。Bolt有两个，第一个是先对数据进行初步处理，第二个Bolt对处理后的数据进行统计。最后在销毁拓扑的时候打印出统计的结果。流程就是这个样子，上代码。</p>
<p>​    Spout代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.strom.spout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichSpout;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ExampleSpout.java</span></span><br><span class="line"><span class="comment"> * Description: 练习Spout，数据当源头。也叫壶嘴</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Peng Shiquan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/7/6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleSpout</span> <span class="keyword">extends</span> <span class="title">BaseRichSpout</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spout输出收集器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SpoutOutputCollector spo;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String filed = <span class="string">&quot;word&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计数变量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用数组模拟流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String[] messages = &#123;<span class="string">&quot;My nickname is xuwujing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;My blog address is http://www.panchengming.com/&quot;</span>,</span><br><span class="line">            <span class="string">&quot;My interest is playing games&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 在spout组件初始化时被调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topologyContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spoutOutputCollector</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/6</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Map map, TopologyContext topologyContext, SpoutOutputCollector spoutOutputCollector)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;开始调用ExampleSpout的open方法&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.spo = spoutOutputCollector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: spout的核心，主要执行方法，用于输出信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/6</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nextTuple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count &lt;= messages.length) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;第&quot;</span> + count + <span class="string">&quot;次模拟发送数据...&quot;</span>);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Values类所作的优化主要是提供若干个支持可变列表的构造方法，包括全为String的参数类型、全为Integer的参数类型以及通用的Object类型</span></span><br><span class="line"><span class="comment">             * Values类直接继承自Java中的ArrayList类，因为ArrayList类恰好能够很好地满足描述“一行”值的需要——有序、不去重、可伸缩。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 必须设置messageId，才能调用ack方法</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">this</span>.spo.emit(<span class="keyword">new</span> Values(messages[count - <span class="number">1</span>]), count);</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 声明数据格式，即输出的tuple中，包含了几个字段</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputFieldsDeclarer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer outputFieldsDeclarer)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;ExampleSpout开始声明数据格式&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里Fields声明了几个字段，传tuple就要传多少个Values</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        outputFieldsDeclarer.declare(<span class="keyword">new</span> Fields(filed));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 当Topology停止时，会调用这个方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Topology停止&quot;</span>);</span><br><span class="line">        <span class="keyword">super</span>.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 处理成功时，会调用这个方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ack</span><span class="params">(Object msgId)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;消息处理成功，消息ID&quot;</span> + msgId);</span><br><span class="line">        <span class="keyword">super</span>.ack(msgId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 当tuple处理失败时，会调用这个方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fail</span><span class="params">(Object msgId)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;消息处理失败&quot;</span>);</span><br><span class="line">        <span class="keyword">super</span>.fail(msgId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    第一个Bolt代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.strom.bolt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ExampleBolt.java</span></span><br><span class="line"><span class="comment"> * Description:  Bolt练习，处理流数据的地方</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Peng Shiquan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/7/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SegmentationBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OutputCollector outputCollector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 在Bolt启动前执行，提供启动的环境。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topologyContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputCollector</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;进入SegmentationBolt的prepare&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.outputCollector = outputCollector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: Bolt的核心,执行的方法。每次接收一个tuple，就会调用一次</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tuple</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;开始执行处理方法&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Spout已经定义了这个field</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String msg = tuple.getStringByField(<span class="string">&quot;word&quot;</span>);</span><br><span class="line">        String[] words = msg.toLowerCase().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 发送到下个bolt</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">this</span>.outputCollector.emit(<span class="keyword">new</span> Values(word));</span><br><span class="line">        &#125;</span><br><span class="line">        outputCollector.ack(tuple);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 声明数据格式，即输出的tuple中，包含了几个字段。Bolt执行完毕也会输出一个流</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputFieldsDeclarer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer outputFieldsDeclarer)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;ExampleSpout开始声明数据格式&quot;</span>);</span><br><span class="line">        outputFieldsDeclarer.declare(<span class="keyword">new</span> Fields(<span class="string">&quot;count&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 释放该Bolt占用的资源，Strom在终止时会调用这个方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;SegmentationBolt资源释放&quot;</span>);</span><br><span class="line">        <span class="keyword">super</span>.cleanup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    第二个Bolt代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.strom.bolt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CountBolt.java</span></span><br><span class="line"><span class="comment"> * Description: Bolt练习，计数的Bolt</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Peng Shiquan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/7/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> count;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存单词和对应的计数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Integer&gt; counts = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;进入CountBolt的prepare&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.counts = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">        String msg = tuple.getStringByField(<span class="string">&quot;count&quot;</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;第&quot;</span> + count + <span class="string">&quot;次统计单词次数&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!counts.containsKey(msg)) &#123;</span><br><span class="line">            counts.put(msg, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            counts.put(msg, counts.get(msg) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 最后执行，打印统计的单词次数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;下面就是单词次数================&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : counts.entrySet()) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;单词&quot;</span> + entry.getKey() + <span class="string">&quot;出现&quot;</span> + entry.getValue() + <span class="string">&quot;次&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.err.println(<span class="string">&quot;输出结束=======================&quot;</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;释放资源&quot;</span>);</span><br><span class="line">        <span class="keyword">super</span>.cleanup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 不在往下一个Bolt输出，所以没有代码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputFieldsDeclarer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer outputFieldsDeclarer)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;CountBolt开始声明数据格式&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    启动入口代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.strom.bolt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CountBolt.java</span></span><br><span class="line"><span class="comment"> * Description: Bolt练习，计数的Bolt</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Peng Shiquan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/7/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> count;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存单词和对应的计数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Integer&gt; counts = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;进入CountBolt的prepare&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.counts = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">        String msg = tuple.getStringByField(<span class="string">&quot;count&quot;</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;第&quot;</span> + count + <span class="string">&quot;次统计单词次数&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!counts.containsKey(msg)) &#123;</span><br><span class="line">            counts.put(msg, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            counts.put(msg, counts.get(msg) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 最后执行，打印统计的单词次数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;下面就是单词次数================&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : counts.entrySet()) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;单词&quot;</span> + entry.getKey() + <span class="string">&quot;出现&quot;</span> + entry.getValue() + <span class="string">&quot;次&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.err.println(<span class="string">&quot;输出结束=======================&quot;</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;释放资源&quot;</span>);</span><br><span class="line">        <span class="keyword">super</span>.cleanup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Description: 不在往下一个Bolt输出，所以没有代码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputFieldsDeclarer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: Peng Shiquan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 2020/7/7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer outputFieldsDeclarer)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;CountBolt开始声明数据格式&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    剩下就没有什么主要代码了，还有就是pom文件和一些配置文件。因为没有使用SpringBoot的基础类，所以没有Spring的配置文件，只有一个日志文件是为了方便调试。配置文件代码如下。</p>
<p>pom文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>strom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>strom<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--storm相关jar  --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.storm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>storm-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    日志配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">monitorInterval</span>=<span class="string">&quot;60&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%-4r [%t] %-5p %c&#123;1.&#125; - %msg%n&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">&quot;org.apache.storm&quot;</span> <span class="attr">level</span>=<span class="string">&quot;OFF&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">&quot;org.apache.zookeeper&quot;</span> <span class="attr">level</span>=<span class="string">&quot;OFF&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;OFF&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;Console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    以上就是代码了，因为是简单的demo，只是本地模式，所以运行起来也很简单。后续的集群部署还需要在了解一下。运行的截图如下：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200708212602792.png" alt="image-20200708212602792"></p>
<p>​    没有什么可以讲的了，后面就是要再写一个集群部署的知识点。</p>
<p>​    就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/storm%E5%AD%A6%E4%B9%A0/Storm%E7%AE%80%E5%8D%95demo/" data-id="ckupl1rrc001f6rup73ke2cjd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qq1162210866.github.io/博客/storm学习/Storm集群部署" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/storm%E5%AD%A6%E4%B9%A0/Storm%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2021-10-13T13:28:21.195Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Storm集群部署"><a href="#Storm集群部署" class="headerlink" title="Storm集群部署"></a>Storm集群部署</h2><p>​    上一篇博客写了一个demo，在IDEA中也跑成功了，下面就是部署到集群环境中去运行，也是搞了一天，和普通的Java项目有点不太一样。开始。</p>
<p>​    部署Storm集群比较繁琐，网上资料也鱼龙混杂，所以还是建议大家去官网上找官方文档。</p>
<p>​    Storm官方部署流程：<a target="_blank" rel="noopener" href="http://storm.apache.org/releases/2.2.0/Setting-up-a-Storm-cluster.html">http://storm.apache.org/releases/2.2.0/Setting-up-a-Storm-cluster.html</a></p>
<p>​    首先就是下载基础的东西，jdk和Strom、zookeeper安装包。地址如下：</p>
<p>​    JDK下载地址：<a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase-downloads.html">https://www.oracle.com/java/technologies/javase-downloads.html</a></p>
<p>​    Storm下载地址：<a target="_blank" rel="noopener" href="http://storm.apache.org/downloads.html">http://storm.apache.org/downloads.html</a></p>
<p>​    ZooKeeper下载地址：<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/releases.html">https://zookeeper.apache.org/releases.html</a></p>
<p>​    需要注意的是下载的时候注意，Storm和ZooKeeper需要下载发行版本，不要下载源码版本，要不然会出现问题，很蛋疼。如下图</p>
<p>​    <img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200710104725796.png" alt="image-20200710104725796"></p>
<p>​    下载完毕，放到自己指定的目录，解压就可以了。一步一步来吧。</p>
<ul>
<li><p>安装JDK</p>
<p>1.查看是否已经安装jdk</p>
<p>rpm -qa|grep jdk</p>
<p>2.卸载原有jdk，因为openjdk不适用</p>
<p>yum -y remove java-1.8.0-openjdk-headless-1.8.0.65-3.b17.el7.x86_64</p>
<p>3.将jdk安装包上传到服务器上。将其解压到指定位置。记得先创建文件夹</p>
<p>tar -zxvf jdk-8u191-linux-x64.tar.gz -C /usr/local/java/</p>
<p>4.在/etc/profile文件末尾添加</p>
<p>export JAVA_HOME=/usr/local/java/jdk1.8.0_191</p>
<p>export JRE_HOME=${JAVA_HOME}/jre</p>
<p>export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib</p>
<p>export PATH=${JAVA_HOME}/bin:$PATH</p>
<p>5.使/etc/profile文件生效</p>
<p>source /etc/profile</p>
<p>6.验证安装是否成功</p>
<p>Java -version</p>
</li>
<li><p>安装ZooKeeper</p>
<p>Zookeeper有一个官方安装文档，很详细。地址：<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.3.3/zookeeperAdmin.html#sc_systemReq">https://zookeeper.apache.org/doc/r3.3.3/zookeeperAdmin.html#sc_systemReq</a></p>
<p>需要注意的就是，Storm使用Zookeeper协调集群。ZooKeeper 不用于消息传递，因此Storm在Zookeeper上的负载非常低。在大多数情况下，单节点Zookeeper集群就足够了。所以我安装的就是单节点的ZooKeeper。按照文档来就可以了，没有什么可以讲的点，如果不行在网上搜一下错误信息。</p>
</li>
<li><p>安装Storm</p>
<p>把Storm的包解压到指定目录，修改配置文件，这一步需要注意的是，例如：<code>storm.local.dir: &quot;/mnt/storm&quot;</code>前面是有一个空格的，要不然启动时会抱错误。安装流程文档就是最上面的一个链接。</p>
<p>修改完毕配置文件后，依次启动服务。<code>bin/storm nimbus</code>,<code>bin/storm nimbus</code>,<code>bin/storm ui</code>。因为UI服务默认占用的是8080端口，如果有修改需要，只需要在配置文件添加：<code>ui.port: 8083</code>（注意空格）。</p>
<p>剩下就没有什么了，启动三个服务后，输入一下网址：<code>http://&#123;ui host&#125;:8080</code>就可以看到Storm的UI，如下图：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200710110638215.png" alt="image-20200710110638215"></p>
<p>这里就不再介绍各个组件的意思了，都很容易看懂。</p>
</li>
<li><p>提交自己的Topology</p>
<p>提交自己的Topology也很简单，官网上也有详细的介绍，地址：<a target="_blank" rel="noopener" href="http://storm.apache.org/releases/2.2.0/Running-topologies-on-a-production-cluster.html">http://storm.apache.org/releases/2.2.0/Running-topologies-on-a-production-cluster.html</a></p>
<p>需要注意的是，如果你的Storm没有加入环境变量，需要使用全路径，如下：</p>
<p><code>/apache-storm-2.2.0/bin/storm jar strom-0.0.1-SNAPSHOT.jar com.example.strom.StromApplication count </code> </p>
<p>另外，打包的时候也需要注意，要指定主类，要不然会一直报找不到主类的错误。</p>
<p>打包需要注意去除SpringBoot的依赖，因为他本身带有打包插件，打包会报错误。</p>
<p>打包插件代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.ServicesResourceTransformer&quot;</span> /&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.example.strom.StromApplication<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上传正常截图如下：<br><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200710114634347.png" alt="image-20200710114634347"><br>删除Topology截图如下：<br><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200710112836552.png" alt="image-20200710112836552"></p>
<p>StormUI截图：</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200710114916495.png" alt="image-20200710114916495"></p>
</li>
</ul>
<p>​    剩下就没有什么要说的了。这样就初步完成集群部署了。</p>
<p>​    就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/storm%E5%AD%A6%E4%B9%A0/Storm%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/" data-id="ckupl1rrd001g6rupfqw572kp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qq1162210866.github.io/博客/中间件/ElasticSearch/ElasticSearch相关知识点" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/ElasticSearch%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/" class="article-date">
  <time datetime="2021-10-13T13:28:21.195Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ElasticSearch相关知识点"><a href="#ElasticSearch相关知识点" class="headerlink" title="ElasticSearch相关知识点"></a>ElasticSearch相关知识点</h2><h3 id="ES基础知识点"><a href="#ES基础知识点" class="headerlink" title="ES基础知识点"></a>ES基础知识点</h3><p>​    ES集群可以包含多个索引（indices）(数据库)，每一个索引可以包含多个类型（types）（表），每一个类型包含多个文档（documents）（行），然后每个文档包含多个字段（fields）（列）。</p>
<h4 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a>索引（Index）</h4><p>​    索引是文档(Document)的容器，是一类文档的集合。在ES中有三种索引的概念，意思分别为：</p>
<ul>
<li>索引(名词)。类比传统的关系型数据库领域来说，索引相当于SQL中的一个数据库(Database)。索引由其名称(必须为全小写字符)进行标识。</li>
<li>索引(动词)。保存一个文档到索引(名词)的过程。这非常类似于SQL语句中的 INSERT关键词。如果该文档已存在时那就相当于数据库的UPDATE。</li>
<li>倒排索引。关系型数据库通过增加一个B+树索引到指定的列上，以便提升数据检索速度。索引ElasticSearch 使用了一个叫做 倒排索引 的结构来达到相同的目的。</li>
</ul>
<h4 id="类型（Type）"><a href="#类型（Type）" class="headerlink" title="类型（Type）"></a>类型（Type）</h4><p>​    Type 可以理解成关系数据库中Table。</p>
<p>​    之前的版本中，索引和文档中间还有个类型的概念，每个索引下可以建立多个类型，文档存储时需要指定index和type。从6.0.0开始单个索引中只能有一个类型，7.0.0以后将将不建议使用，8.0.0 以后完全不支持。但是后续的版本弃用了，原因如下：</p>
<p>​    我们虽然可以通俗的去理解Index比作 SQL 的 Database，Type比作SQL的Table。但这并不准确，因为如果在SQL中,Table 之前相互独立，同名的字段在两个表中毫无关系。但是在ES中，同一个Index 下不同的 Type 如果有同名的字段，他们会被 Luecence 当作同一个字段 ，并且他们的定义必须相同。所以我觉得Index现在更像一个表，而Type字段并没有多少意义。目前Type已经被Deprecated，在7.0开始，一个索引只能建一个Type为_doc</p>
<h4 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a>文档（Document）</h4><p>​    Document Index 里面单条的记录称为Document（文档）。等同于关系型数据库表中的行。</p>
<h4 id="映射（Mapping）"><a href="#映射（Mapping）" class="headerlink" title="映射（Mapping）"></a>映射（Mapping）</h4><p>​    映射(Mapping)相当于数据表的表结构。ElasticSearch中的映射（Mapping）用来定义一个文档，可以定义所包含的字段以及字段的类型、分词器及属性等等。</p>
<p>​    映射定义了类型中的域，每个域的数据类型，以及Elasticsearch如何处理这些域。映射也用于配置与类型有关的元数据。（元数据就是指和文档相关的数据，例如：文档的id、文档的index、文档的版本号）</p>
<p>​    映射创建完毕后就不能修改了，只能后续增加映射，不能修改已经存在的映射。映射也分为动态和静态。动态就是根据传入的json的类型去猜测映射的类型，例如“123”回被当为String。静态映射是在创建index时指定映射。</p>
<h4 id="字段（fields）"><a href="#字段（fields）" class="headerlink" title="字段（fields）"></a>字段（fields）</h4><p>​    代表传统DB中的列的概念，例如学生表中的name列，一般映射也是对字段进行限制。</p>
<h4 id="分片（Shard）"><a href="#分片（Shard）" class="headerlink" title="分片（Shard）"></a>分片（Shard）</h4><p>​    一个分片是一个底层的工作单元 ，它仅保存了全部数据中的一部分。索引实际上是指向一个或者多个物理分片的逻辑命名空间 。分片是数据的容器，文档保存在分片内，分片又被分配到集群内的各个节点里。分片分为主分片和副本。</p>
<ul>
<li>主分片：主要的数据存储分片，也是和用户打交道的主要分片。</li>
<li>副本：主要对主分片的数据做冗余备份。当主分片异常时，副本可以继续提供读访问。</li>
</ul>
<p>注意：一个index可能存在多个主分片上。主分片数量在创建时指定后就不能修改了，但是副本的数量可以修改。主分片不能和本分片的副本在同一个节点上。</p>
<h4 id="节点（Node）"><a href="#节点（Node）" class="headerlink" title="节点（Node）"></a>节点（Node）</h4><p>​    节点是一个ElasticSearch的实例，其本质就是一个Java进程；Node 是组成集群的一个单独的服务器，用于存储数据并提供集群的搜索和索引功能。与集群一样，节点也有一个唯一名字，默认在节点启动时会生成一个uuid作为节点名，该名字也可以手动指定。单个集群可以由任意数量的节点组成。如果只启动了一个节点，则会形成一个单节点的集群。一台机器可以部署多个节点，但是建议一台机器部署一个节点。</p>
<h4 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h4><p>​    Elasticsearch 使用一种称为倒排索引的结构，它适用于快速的全文搜索。一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。文档列表里面存储该词出现的文档和文档中该词出现的频率。</p>
<p>​    倒排索引就是将文档中出现的不重复的词语建立一个列表，然后对于各个文档，标注出该词语在文档中出现的次数。第一列是不重复词语，第一行是各个文档的id或者名称。表格中间填写的就是各个文档中各个词语出现的次数。</p>
<p>​    正排索引就是像MySQL这样类似，根据id查询该行的信息。倒排就是根据信息查询id。</p>
<h4 id="分析器"><a href="#分析器" class="headerlink" title="分析器"></a>分析器</h4><p>​    分析器就是从一串文本中切分出一个一个的词条，并対每个词条进行标准化。分析器实际上是将三个功能封装到了一个包里</p>
<ul>
<li>字符过滤器：首先，字符串按顺序通过每个字符过滤器 。他们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉HTML，或者将 &amp; 转化成 and。</li>
<li>分词器：其次，字符串被分词器分为单个的词条。一个简单的分词器遇到空格和标点的时候，可能会将文本拆分成词条。</li>
<li>Token 过滤器：最后，词条按顺序通过每个 token 过滤器 。这个过程可能会改变词条（例如，小写化 Quick ），删除词条（例如， 像 a， and， the 等无用词），或者增加词条（例如，像 jump 和 leap 这种同义词）。</li>
</ul>
<p>​    内置的分析器有一下几种：</p>
<ul>
<li>标准分析器是Elasticsearch默认使用的分析器。它是分析各种语言文本最常用的选择。它根据 Unicode 联盟 定义的 单词边界 划分文本。删除绝大部分标点。最后，将词条小写。</li>
<li>简单分析器在任何不是字母的地方分隔文本，将词条小写。</li>
<li>空格分析器在空格的地方划分文本。</li>
<li>特定语言分析器可用于很多语言。它们可以考虑指定语言的特点。例如， 英语 分析器附带了一组英语无用词（常用单词，例如 and 或者 the ，它们对相关性没有多少影响），它们会被删除。 由于理解英语语法的规则，这个分词器可以提取英语单词的词干。</li>
</ul>
<h3 id="ES中相关原理"><a href="#ES中相关原理" class="headerlink" title="ES中相关原理"></a>ES中相关原理</h3><h4 id="如何索引到文档"><a href="#如何索引到文档" class="headerlink" title="如何索引到文档"></a>如何索引到文档</h4><p>​    当索引一个文档的时候，文档会被存储到一个主分片中。这个时候是通过计算得到该文档所在的分片的。通过以下公式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure>

<p>​    routing 是一个可变值，默认是文档的 _id ，也可以设置成一个自定义的值。 routing 通过 hash 函数生成一个数字，然后这个数字再除以 number_of_primary_shards （主分片的数量）后得到 余数 。这个分布在 0 到 number_of_primary_shards-1 之间的余数，就是我们所寻求的文档所在分片的位置。这也就是为什么不能修改主分片的数量，如果修改了，后续的索引就无法找到对应的分片，之前的存放的文档也会有影响。</p>
<h4 id="搜索的过程"><a href="#搜索的过程" class="headerlink" title="搜索的过程"></a>搜索的过程</h4><p>​    先说普通的CURD操作，因为CURD一般都带有三个属性：_index, _type, 和 routing values ，基本可以确定集群中的那个分片处理这个请求。</p>
<p>​    但是搜索比较复杂一些。主要分为查询阶段和取回阶段。</p>
<h5 id="查询阶段"><a href="#查询阶段" class="headerlink" title="查询阶段"></a>查询阶段</h5><p>​    当一个搜索请求被发送到某个节点时，这个节点就变成了协调节点。 这个节点的任务是广播查询请求到所有相关分片并将它们的响应整合成全局排序后的结果集合，这个结果集合会返回给客户端。</p>
<p>​    第一步是广播请求到索引中每一个节点的分片拷贝。就像 document GET requests 所描述的， 查询请求可以被某个主分片或某个副本分片处理， 这就是为什么更多的副本（当结合更多的硬件）能够增加搜索吞吐率。 协调节点将在之后的请求中轮询所有的分片拷贝来分摊负载。</p>
<p>​    每个分片在本地执行查询请求并且创建一个长度为 from + size 的优先队列—也就是说，每个分片创建的结果集足够大，均可以满足全局的搜索请求。 分片返回一个轻量级的结果列表到协调节点，它仅包含文档 ID 集合以及任何排序需要用到的值，例如 _score 。</p>
<p>​    协调节点将这些分片级的结果合并到自己的有序优先队列里，它代表了全局排序结果集合。至此查询过程结束。</p>
<h5 id="取回阶段"><a href="#取回阶段" class="headerlink" title="取回阶段"></a>取回阶段</h5><p>​    协调节点首先决定哪些文档 确实 需要被取回。例如，如果我们的查询指定了 { “from”: 90, “size”: 10 } ，最初的90个结果会被丢弃，只有从第91个开始的10个结果需要被取回。这些文档可能来自和最初搜索请求有关的一个、多个甚至全部分片。</p>
<p>​    协调节点给持有相关文档的每个分片创建一个 multi-get request ，并发送请求给同样处理查询阶段的分片副本。</p>
<p>​    分片加载文档体– _source 字段—如果有需要，用元数据和 search snippet highlighting 丰富结果文档。 一旦协调节点接收到所有的结果文档，它就组装这些结果为单个响应返回给客户端。</p>
<ul>
<li><p>想象一下有两个文档有同样值的时间戳字段，搜索结果用 timestamp 字段来排序。 由于搜索请求是在所有有效的分片副本间轮询的，那就有可能发生主分片处理请求时，这两个文档是一种顺序， 而副本分片处理请求时又是另一种顺序。</p>
<p>这就是所谓的结果震荡问题: 每次用户刷新页面，搜索结果表现是不同的顺序。 让同一个用户始终使用同一个分片，这样可以避免这种问题， 可以设置 preference 参数（偏好参数选定对应的节点）为一个特定的任意值比如用户会话ID来解决。</p>
</li>
</ul>
<h4 id="节点故障后选举的流程"><a href="#节点故障后选举的流程" class="headerlink" title="节点故障后选举的流程"></a>节点故障后选举的流程</h4><p>​    Elasticsearch在满足如下时间点的时候会触发选举1.集群启动初始化2.集群的Master崩溃的时候3.任何一个节点发现当前集群中的Master节点没有得到n/2 + 1节点认可的时候，触发选举。</p>
<p>​    选举的流程：</p>
<p><img src="https://pic2.zhimg.com/v2-7c4b590346650f5e32088458da5df48d_r.jpg" alt="preview"></p>
<p>​    详细看文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/110079342">https://zhuanlan.zhihu.com/p/110079342</a></p>
<p>​    <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/281021501">https://zhuanlan.zhihu.com/p/281021501</a></p>
<h4 id="处理冲突的流程"><a href="#处理冲突的流程" class="headerlink" title="处理冲突的流程"></a>处理冲突的流程</h4><p>​    每个文档都有一个 _version （版本）号，当文档被修改时版本号递增。 Elasticsearch 使用这个 _version 号来确保变更以正确顺序得到执行。如果旧版本的文档在新版本之后到达，它可以被简单的忽略。</p>
<p>​    我们可以利用 _version 号来确保 应用中相互冲突的变更不会导致数据丢失。我们通过指定想要修改文档的 version 号来达到这个目的。 如果该版本不是当前版本号，我们的请求将会失败。</p>
<p>也可以通过外部版本号：</p>
<p>如果你的主数据库已经有了版本号 — 或一个能作为版本号的字段值比如 timestamp — 那么你就可以在 Elasticsearch 中通过增加 version_type=external 到查询字符串的方式重用这些相同的版本号， 版本号必须是大于零的整数， 且小于 9.2E+18 — 一个 Java 中 long 类型的正值。</p>
<p>外部版本号的处理方式和我们之前讨论的内部版本号的处理方式有些不同， Elasticsearch 不是检查当前 _version 和请求中指定的版本号是否相同， 而是检查当前 _version 是否 小于 指定的版本号。 如果请求成功，外部的版本号作为文档的新 _version 进行存储。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><h4 id="POSTMAN练习"><a href="#POSTMAN练习" class="headerlink" title="POSTMAN练习"></a>POSTMAN练习</h4><ul>
<li>PUT /index/type/id {body} 添加一个文档。</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT &#x27;http://127.0.0.1:9200/megacorp/employee/4&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;first_name&quot; : &quot;Li&quot;,</span><br><span class="line">    &quot;last_name&quot; :  &quot;Si&quot;,</span><br><span class="line">    &quot;age&quot; :        26,</span><br><span class="line">    &quot;about&quot; :      &quot;I love to sleep&quot;,</span><br><span class="line">    &quot;interests&quot;: [ &quot;bed&quot;, &quot;work&quot; ]</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>GET /megacorp/employee/1 查询一个id为1的文档。</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET &#x27;http://127.0.0.1:9200/megacrop/employee/1&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;from&quot;:2,</span><br><span class="line">    &quot;size&quot;:1</span><br><span class="line">&#125; &#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>GET /megacorp/employee/_search    搜索文档。可以添加相关的json来限制查询条件</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET &#x27;http://127.0.0.1:9200/megacrop/employee/_search&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;last_name&quot; : &quot;Smith&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>HEAD /megacorp/employee/123 查询文档是否存在。</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --head &#x27;http://127.0.0.1:9200/megacrop/employee/23&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>PUT /website/blog/123/_create    如果ID不存在创建新文档</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT &#x27;http://127.0.0.1:9200/website/blog/123/_create&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My first blog entry&quot;,</span><br><span class="line">  &quot;text&quot;:  &quot;I am starting to get the hang of this...&quot;,</span><br><span class="line">  &quot;date&quot;:  &quot;2014/01/02&quot;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>DELETE /website/blog/123    删除文档</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request DELETE &#x27;http://127.0.0.1:9200/website/blog/123&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>POST /website/blog/1/_update    更新文档，存在的字段就更新，不存在的字段就增加。</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &#x27;http://127.0.0.1:9200/megacorp/employee/4/_update&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">   &quot;doc&quot; : &#123;</span><br><span class="line">      &quot;about&quot; : &quot;l love to sleep and work&quot;</span><br><span class="line">      </span><br><span class="line">   &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_most_important_queries.html">ES常用的查询语句</a></p>
</li>
<li><p>多个查询的组合。比较复杂，后面如果经常使用需要多看</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;must&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">25</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;must_not&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;Zhang&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;should&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;rock&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;exists&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;interests&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后续需要多看官方的文档，多了解了解</p>
<h4 id="SpringBoot整合"><a href="#SpringBoot整合" class="headerlink" title="SpringBoot整合"></a>SpringBoot整合</h4><p>​    整合依赖，添加esstarter即可，注意这个依赖使用的是elasticsearch-rest-high-level-client</p>
<p>​    添加相关配置，例如集群的url，这里可以添加多个，客户端会轮询</p>
<p>​    添加相关实体类，加上@Document(indexName = “user”)注解</p>
<p>​    添加UserRepository接口继承ElasticsearchRepository&lt;User, Integer&gt;，一般的方法默认都实现了，也可以是使用@Query注解修改你方法的Query</p>
<p>​    查询即可，后续高级的用法再说。</p>
<h3 id="ES的面试问题"><a href="#ES的面试问题" class="headerlink" title="ES的面试问题"></a>ES的面试问题</h3><ul>
<li>ES集群相关的配置。</li>
</ul>
<p>我们公司使用的是单节点架构，分片是默认的5分片。索引大概4个索引。主要存储的数据都是设备的历史数据和状态记录。这样是没法达到高可用的，可以设置多节点，保证高可用，因为主分片和他的副本是不会在同一个节点上的。索引的话可以设置多个主分片，但是后续不能修改，这个就需要结合你的业务增长速度，每个分片其实会占用一定的计算机资源。副本的话可以后续修改，如果你某个索引吞吐量达，可以添加副本的数量。</p>
<ul>
<li>ES是如何找到一个文档的</li>
</ul>
<p>​    首先以我们公司使用的单节点架构为例，寻找一个文档很简单，知道文档的id和index，直接就能判断出文档在哪个分片，然后获取数据并且返回即可。这一步骤没有什么可以讲的点。搜索就复杂一点，因为不知道文档属于哪个分片，所以需要将请求发送到这个索引的所有副本分片上，同时后续的请求会轮询其他分片。每个分片建立一个优先队列，长度为from+size。默认的是0和10。然后该分片将符合要求的文档的id和排序值返回给协调节点，协调节点将所有节点的结果排序，取出客户端需要的数据，再次请求对应的分片，将分片返回的文档返回给客户端即可。多节点的话，最先请求的节点会处理客户端的请求，也叫做协调节点，但是我们只有一个节点，所以也就只有一个协调节点。</p>
<ul>
<li>项目中什么地方使用到ES，为什么这样用？</li>
</ul>
<p>因为我们公司项目本身是用来给政府单位开发的，所以在设计上会存在一些过量的设计，以此凸显自己项目的优势。这个我认为在开发中是没法避免的。后期的话，公司会做一个设备信息状态的判断 ，然后演算某些隧道的设备是否达到替换的标准，以此给业主提供参考意见，我觉这个地方可以展示es的一些优势，将es利用起来，例如：对某条隧道故障设备进行排名，再按照设备的供应商、地理位置等等条件。当然，这只是我的一个想法，目前的使用还是简单的将其作为一个数据库，对设备的历史数据进行维护。</p>
<ul>
<li>ES如果某一时刻需要开启大批量的查询，如何做？</li>
</ul>
<p>可以通过游标查询，游标查询允许我们 先做查询初始化，然后再批量地拉取结果。游标查询是取某个时间点的快照数据，通过请求中设置游标的时间参数，获取到游标的id，后续的请求发送这个id即可。达到大批量的查询。 游标查询的过期时间会在每次做查询的时候刷新，所以你的时间点设置只要本地查询处理就可以了。不需要设置很大。初始搜索请求和每个后续滚动请求返回一个新的 _scroll_id。</p>
<ul>
<li>ES如何解决脑裂现象的</li>
</ul>
<p>脑裂现象是指集群中因为网络分区或者其他原因导致出现两个master的现象，例如123选举3节点为master节点。456选举6节点为master节点。esmaster节点的选举来源分为两个地方，activemaster列表和mastercanditancees列表，前者是通过禁止本地节点入选来解决脑裂现象，后者是通过通过设置最小节点数来解决脑裂现象。当然，在我们项目实际使用过程中没有涉及到集群的这一方面，所以有些实际的问题可能没有涉及到。</p>
<ul>
<li>什么是倒排索引</li>
</ul>
<p>​    说到倒排索引，其实可以先提一下正排索引，类似MySQL这种，根据某行记录的ID查询该行记录，例如查询id为9的用户的信息，这就是正排索引，倒排索引相反，根据信息查询id，例如，有很多用户的信息，每个用户有一个备注，例如：我喜欢打篮球或者我喜欢打排球。倒排索引就是将这段话分词，分为各个词语，然后将形成一个列表，第一列就是各个词语，第一行就是各个文档id，中间内容就是记录各个词语在各个文档中是否出现或者出现的频率。这样就能达到一个效果，根据词语搜索文档的id，再搜索文档的信息。这样的表格就是倒排索引。</p>
<ul>
<li>ES集群是如何处理故障的？</li>
</ul>
<p>​    其他节点发现master节点故障后，发起选举，选举出新的master节点，然后新的主节点重新分配主分片，为挂掉的主节点创建分片的副本。</p>
<ul>
<li>ES集群的选举过程？</li>
</ul>
<p>​    选举的情况有三种：1）master节点崩溃。2）集群初始化的时候。3）任意节点发现当前master节点没有n/2+1节点支持时。</p>
<p>​    es的节点成员先发送ping请求给其他节点，构建两个列表：当前其他节点认为的存活的master节点列表和master候选节点列表。activeMaster和masterCanditances存在优先级，先从activeMaster中选举，如果该列表为空，在从masterCanditance列表中选举。</p>
<p>activeMaster节点不包含本地节点，这样就可以避免脑裂现象。该列表的选举采用Bully算法，就是每个节点都有一个优先级，从这些节点中选取出优先级最高的节点当作master节点。优先级的判断主要有两点：版本号和id。版本号越大优先级越高、id越小优先级越高。</p>
<p>masterCanditances列表里面先判断是否达到最小节点数，如果达到了就按照优先级进行选举。</p>
<p>选举出来master节点后，还存在两种情况：本地节点是master节点，会等待其他节点投票，如果超时或者设置的最小节点，就重新选举，如果票数大于，就当选为master节点。本地节点不是master时，首先禁止其他节点加入自己，然后监听集群的发布状态。如果新的master和自己的一致，就进行状态更新，否则重新发起选举。</p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>//索引的概念</p>
<p>//文档的概念</p>
<p>//映射的相关概念</p>
<p>//主分片和复制分片的概念</p>
<p>//es如何确保请求被分开（可能是轮询）</p>
<p>//es中的文本分析和</p>
<p>//倒排索引（分词）</p>
<p>//分析器</p>
<p>//结构化查询（通过json体进行查询）</p>
<p>//查询语句和过滤语句</p>
<p>//结果震荡</p>
<p>//字典树</p>
<p>练习</p>
<p>//简单的CURD</p>
<p>//指定映射和分析器</p>
<p>//结构化查询（通过json体进行查询）</p>
<p>//查询语句和过滤语句</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/ElasticSearch%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/" data-id="ckupl1rry001w6rup4f3o9bgh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qq1162210866.github.io/博客/中间件/ElasticSearch/elasticsearch搭建和api使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/elasticsearch%E6%90%AD%E5%BB%BA%E5%92%8Capi%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2021-10-13T13:28:21.195Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Elasticsearch搭建和简单API使用"><a href="#Elasticsearch搭建和简单API使用" class="headerlink" title="Elasticsearch搭建和简单API使用"></a>Elasticsearch搭建和简单API使用</h1><p>​    之前的博客介绍了SpringBoot如何使用ES，但是ES最新版本的安装没有说明，最近需要做这个了发现没有具体的文档，这篇博客就来说一下ES在CentOS下的安装文档，同时也介绍一下一些简单的ES使用的API。不多逼逼了，开始。</p>
<h3 id="Elasticsearch安装"><a href="#Elasticsearch安装" class="headerlink" title="Elasticsearch安装"></a>Elasticsearch安装</h3><ul>
<li><p>下载RPM包。</p>
<p>本次的安装步骤是使用RPM包安装的，因为步骤比较简单。所以第一步需要下载RPM包，这个需要到官网下载，地址如下：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a>。根据自己的需要下载对应的版本就可以了。把RPM包上传到服务器上即可。</p>
</li>
<li><p>安装ES</p>
<p>在RPM包目录下执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm  --install elasticsearch-7.9.1-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>出现以下画面就表示安装完成</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200904104228179.png" alt="image-20200904104228179"></p>
</li>
<li><p>配置ES</p>
<p>配置ES前需要先安装Java，但是这个比较简单，并且不在本次叙述内容里面，这里就不再累述了，网上博客一搜一大堆。</p>
<ul>
<li><p>配置ES中的JAVA_HOME。</p>
<p>配置一下ES中的JAVA_HOME，这样ES启动的时候就会自己去找Java环境了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/elasticsearch</span><br><span class="line"></span><br><span class="line">修改JAVA_HOME属性为本机的配置即可</span><br></pre></td></tr></table></figure></li>
<li><p>修改ES配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">修改以下配置</span><br><span class="line">cluster.initial_master_nodes</span><br><span class="line">network.host</span><br><span class="line">http.port</span><br><span class="line">node.name</span><br><span class="line">cluster.name</span><br><span class="line">详细文件内容如下：</span><br><span class="line"><span class="comment"># ======================== Elasticsearch Configuration =========================</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> Elasticsearch comes with reasonable defaults for most settings.</span></span><br><span class="line"><span class="comment">#       Before you set out to tweak and tune the configuration, make sure you</span></span><br><span class="line"><span class="comment">#       understand what are you trying to accomplish and the consequences.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The primary way of configuring a node is via this file. This template lists</span></span><br><span class="line"><span class="comment"># the most important settings you may want to configure for a production cluster.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please consult the documentation for further information on configuration options:</span></span><br><span class="line"><span class="comment"># https://www.elastic.co/guide/en/elasticsearch/reference/index.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for your cluster:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cluster.name: elasticsearch</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ------------------------------------ Node ------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">node.name: node-1</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Add custom attributes to the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------- Paths ------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to directory where to store the data (separate multiple locations by comma):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to log files:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------- Memory -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Lock the memory on startup:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Make sure that the heap size is set to about half the memory available</span></span><br><span class="line"><span class="comment"># on the system and that the owner of the process is allowed to use this</span></span><br><span class="line"><span class="comment"># limit.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Elasticsearch performs poorly when the system is swapping the memory.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Network -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set the bind address to a specific IP (IPv4 or IPv6):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set a custom port for HTTP:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the network module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># --------------------------------- Discovery ----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Pass an initial list of hosts to perform discovery when this node is started:</span></span><br><span class="line"><span class="comment"># The default list of hosts is [&quot;127.0.0.1&quot;, &quot;[::1]&quot;]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#discovery.seed_hosts: [&quot;host1&quot;, &quot;host2&quot;]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Bootstrap the cluster using an initial set of master-eligible nodes:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the discovery and cluster formation module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Gateway -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Block initial recovery after a full cluster restart until N nodes are started:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#gateway.recover_after_nodes: 3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the gateway module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Various -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Require explicit names when deleting indices:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>启动ES，添加到开机自启</p>
<p>命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service elasticsearch start</span><br><span class="line">chkconfig --add elasticsearch</span><br></pre></td></tr></table></figure></li>
<li><p>其他信息</p>
<ul>
<li><p>删除ES</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e elasticsearch-7.9.1-x86_64.rpm</span><br></pre></td></tr></table></figure></li>
<li><p>开放防火墙端口（建议开启防火墙）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=9200/tcp --permanent</span><br></pre></td></tr></table></figure></li>
<li><p>把日志目录到权限赋予es用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R es:es /opt/elasticsearch</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="API简单介绍"><a href="#API简单介绍" class="headerlink" title="API简单介绍"></a>API简单介绍</h3><p>​    ES可以通过使用RESTful API来进行交互，使用的是9200端口。更极端的情况下，可以使用curl命令来进行交互。</p>
<p>​    一个 Elasticsearch 请求和任何 HTTP 请求一样由若干相同的部件组成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X&lt;VERB&gt; <span class="string">&#x27;&lt;PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;&#x27;</span> -d <span class="string">&#x27;&lt;BODY&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">介绍</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>VERB</code></td>
<td align="center">适当的 HTTP <em>方法</em> 或 <em>谓词</em> : <code>GET</code>、 <code>POST</code>、 <code>PUT</code>、 <code>HEAD</code> 或者 <code>DELETE</code>。</td>
</tr>
<tr>
<td align="center"><code>PROTOCOL</code></td>
<td align="center"><code>http</code> 或者 <code>https</code>（如果你在 Elasticsearch 前面有一个 <code>https</code> 代理）</td>
</tr>
<tr>
<td align="center"><code>HOST</code></td>
<td align="center">Elasticsearch 集群中任意节点的主机名，或者用 <code>localhost</code> 代表本地机器上的节点。</td>
</tr>
<tr>
<td align="center"><code>PORT</code></td>
<td align="center">运行 Elasticsearch HTTP 服务的端口号，默认是 <code>9200</code> 。</td>
</tr>
<tr>
<td align="center"><code>PATH</code></td>
<td align="center">API 的终端路径（例如 <code>_count</code> 将返回集群中文档数量）。Path 可能包含多个组件，例如：<code>_cluster/stats</code> 和 <code>_nodes/stats/jvm</code> 。</td>
</tr>
<tr>
<td align="center"><code>QUERY_STRING</code></td>
<td align="center">任意可选的查询字符串参数 (例如 <code>?pretty</code> 将格式化地输出 JSON 返回值，使其更容易阅读)</td>
</tr>
<tr>
<td align="center"><code>BODY</code></td>
<td align="center">一个 JSON 格式的请求体 (如果请求需要的话)</td>
</tr>
</tbody></table>
<ul>
<li><p>例子</p>
<ul>
<li><p>创建一个商品的索引，指定四个属性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9200/commodity</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;number_of_shards&quot;</span>:3,</span><br><span class="line">        <span class="string">&quot;number_of_replicas&quot;</span>:2</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;commodity_id&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>:<span class="string">&quot;long&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;commodity_name&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;picture_url&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;price&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>:<span class="string">&quot;double&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">返回结果：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;shards_acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;commodity&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200904143546873.png" alt="image-20200904143546873"></p>
</li>
</ul>
<p>还有一些用法，这里就不再列出来了，详细的文档可以看看官方文档，官方文档是基于2.0版本的，但是安装的是7.9，所以部分用法可能有些不一样，但是了解ES的一些基础的东西估计没有问题。中文文档地址在下方。<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</a></p>
</li>
</ul>
<p>​    这样就基础的就差不多了，就这样吧，结束。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/elasticsearch%E6%90%AD%E5%BB%BA%E5%92%8Capi%E4%BD%BF%E7%94%A8/" data-id="ckupl1rrz001x6rup2fofbjuz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qq1162210866.github.io/博客/Linux学习/第七章、Linux文件系统" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/Linux%E5%AD%A6%E4%B9%A0/%E7%AC%AC%E4%B8%83%E7%AB%A0%E3%80%81Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time datetime="2021-10-13T13:28:21.194Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第七章、Linux文件系统"><a href="#第七章、Linux文件系统" class="headerlink" title="第七章、Linux文件系统"></a>第七章、Linux文件系统</h2><h3 id="Linux文件系统"><a href="#Linux文件系统" class="headerlink" title="Linux文件系统"></a>Linux文件系统</h3><ul>
<li><p>Linux的EXT2文件系统</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_3DFC7CA9B512-1.jpeg" alt="IMG_3DFC7CA9B512-1"></p>
<ul>
<li><p>Data block 是用来放置文件内容数据的地方。Ext2系统中所支持的blokc大小有1、2，4K三种。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_2488E99AAFB4-1.jpeg" alt="IMG_2488E99AAFB4-1"></p>
</li>
<li><p>Inode table 是记录文件的属性以及该文件实际数据是放在哪个block中的。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_F2D95A3DEA87-1.jpeg" alt="IMG_F2D95A3DEA87-1"></p>
<p>inode还有下面的特点。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_7173E6AAB4C5-1.jpeg" alt="IMG_7173E6AAB4C5-1"></p>
<p>inode的记录结构图，最小的1K的block可以容纳16GB的文件。<code>12+256+256*256+256*256*256=16GB</code></p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_B0821E59ADEE-1.jpeg" alt="IMG_B0821E59ADEE-1"></p>
</li>
<li><p>Superblock记录整个filesystem相关信息的地方。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_163F8E9E2A81-1.jpeg" alt="IMG_163F8E9E2A81-1"></p>
</li>
<li><p>Filesytem Description（文件系统描述说明）描述每个block group的开始与结束的block号码，以及说明每个区段分别介于哪一个block号码之间。</p>
</li>
<li><p>Block bitmap(区块对照表)记录系统中空的block号码。</p>
</li>
<li><p>Inode bitmap（inode 对照表）记录未使用的inode号码。</p>
</li>
<li><p><code>dumpe2fs</code> 查询Ext家族superblock信息的指令。（不常用）</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_51A8DF0CE1DB-1.jpeg" alt="IMG_51A8DF0CE1DB-1"></p>
</li>
<li><p>文件的读取流程</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_7F443C85D318-1.jpeg" alt="IMG_7F443C85D318-1"></p>
</li>
</ul>
</li>
<li><p>XFS文件系统简介</p>
<ul>
<li><p>资料区。分为多个存储群组，每个群组包含（1）整个文件系统的 superblock、 (2)剩余空间的管理机制、 (3)inode 的分配与追踪。</p>
</li>
<li><p>文件系统活动登录区。主要记录文件系统的变化，有点类似于日志区。</p>
</li>
<li><p>实时运作区。记录extent区块的信息。</p>
</li>
<li><p><code>xfs_info</code>指令的用法</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_368E80FB9615-1.jpeg" alt="IMG_368E80FB9615-1"></p>
</li>
</ul>
</li>
<li><p>文件系统的简单操作</p>
<ul>
<li><p><code>df</code>列出文件系统的整体磁盘使用量</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_0AAC648A473B-1.jpeg" alt="IMG_0AAC648A473B-1"></p>
</li>
<li><p><code>du</code>评估文件系统的磁盘使用量</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_01964E14EB78-1.jpeg" alt="IMG_01964E14EB78-1"></p>
</li>
</ul>
</li>
<li><p>实体链接与符号链接</p>
<ul>
<li><p><code>ln</code>制作链接档。</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_C5F5EAF2A276-1.jpeg" alt="IMG_C5F5EAF2A276-1"></p>
<ul>
<li><p>Hard Link（实体链接，硬式连结或实际连结）在某个目录下新增一笔档名链接到某inode号码的关联记录。</p>
</li>
<li><p>Symbolic Link(符号链接，类似于快捷方式) 建立一个独立的文件，而这个文件会让数据的读取指向link的那个文件档名。会创建新的inode和block，但是要比原档名小的多。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>磁盘的分区、格式化、检验与挂载</p>
<ul>
<li><p><code>lsblk</code>列出系统上所有的磁盘列表。<br><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_881CF83F6037-1.jpeg" alt="IMG_881CF83F6037-1"></p>
</li>
<li><p><code>blkid</code>列出装置的UUID等参数</p>
</li>
<li><p><code>parted</code>列出磁盘的分区表类型与分区信息</p>
</li>
<li><p>分区的步骤：先通过<code>lsblk</code>或者<code>blkid</code>找到磁盘，再通过<code>parted /dev/xxx print</code> 找到该磁盘的分区类型，之后通过<code>fdisk</code>(MBR分区)或者<code>gdisk</code>(GPT分区)来操作磁盘。</p>
</li>
<li><p><code>mkfs.xfs</code>命令是建置文件系统</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_C576B170E89D-1.jpeg" alt="IMG_C576B170E89D-1"></p>
</li>
<li><p>EXT4文件系统的<code>mkfs.ext4</code></p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_D34A4CD5C7F0-1.jpeg" alt="IMG_D34A4CD5C7F0-1"></p>
</li>
</ul>
</li>
<li><p>文件系统的检验</p>
<ul>
<li><p><code>xfs_repair</code>处理XFS文件系统<br><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_ED943AA7B08E-1.jpeg" alt="IMG_ED943AA7B08E-1"></p>
</li>
<li><p><code>fsck.ext4</code>处理EXT4文件系统</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_1AC76C5CAAB8-1.jpeg" alt="IMG_1AC76C5CAAB8-1"></p>
</li>
</ul>
</li>
<li><p>文件系统的挂载和卸除</p>
<ul>
<li><p><code>mount</code>挂载使用到的命令</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_EF0C6D310CCA-1.jpeg" alt="IMG_EF0C6D310CCA-1"></p>
</li>
<li><p><code>umount</code>将装置文件卸除的命令</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_D4FFFBEBEEE1-1.jpeg" alt="IMG_D4FFFBEBEEE1-1"></p>
</li>
</ul>
</li>
<li><p>设置开机挂载</p>
<ul>
<li><p>/etc/fstab文件内容</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200421091505802.png" alt="image-20200421091505802"></p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_DA7EB7846934-1.jpeg" alt="IMG_DA7EB7846934-1"></p>
<ul>
<li><p>磁盘装置文件名/UUID/LABEL name。 例子：/dev/vda2.  UUID=xxx.  LABEL=xxx</p>
</li>
<li><p>挂载点。一定要是目录</p>
</li>
<li><p>磁盘分区槽的文件系统。如xfs,ext4,vfat,reiserfs,nfs</p>
</li>
<li><p>文件系统参数</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_01E1BA15FC1D-1.jpeg" alt="IMG_01E1BA15FC1D-1"></p>
</li>
<li><p>能否被dump备份指令作用。0即可</p>
</li>
<li><p>是否以fsck检验扇区。xfs文件系统会自己检查，直接填0即可</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>特殊装置loop挂载</p>
<ul>
<li><p>以挂载一个文件为例</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200421134709795.png" alt="image-20200421134709795"></p>
</li>
</ul>
</li>
</ul>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/image-20200421134803389.png" alt="image-20200421134803389"></p>
<p>步骤：1.建立大型文件。2.大型文件格式化。3.将大型文件挂载到目录（通过UUID的形式）</p>
<ul>
<li><p>内存置换空间（swap）之建置（用处不大，看看就可以）</p>
<p><img src="https://1162210866.oss-cn-beijing.aliyuncs.com/uPic/IMG_57EEF927240A-1.jpeg" alt="IMG_57EEF927240A-1"></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/Linux%E5%AD%A6%E4%B9%A0/%E7%AC%AC%E4%B8%83%E7%AB%A0%E3%80%81Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" data-id="ckupl1rql000x6rup8fxzbuwi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/6/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/" rel="tag">test</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/test/" style="font-size: 10px;">test</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%95%B0%E6%8D%AE%E4%BD%8D%E5%AD%A6%E4%B9%A0/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/%E6%9D%82%E9%A1%B9/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E8%AE%B0%E5%BD%95/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/13/qq1162210866.github.io/%E5%8D%9A%E5%AE%A2/%E6%9D%82%E9%A1%B9/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>